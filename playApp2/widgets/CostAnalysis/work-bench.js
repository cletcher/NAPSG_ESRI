// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/CostAnalysis/work-bench.html":'\x3cdiv style\x3d"height: 100%; width: 100%"\x3e\r\n  \x3cdiv class\x3d"esriCTContentSection"\x3e\r\n    \x3cdiv class\x3d"esriCTAddEditFeatureContainer" data-dojo-attach-point\x3d"templatePickerContainer"\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"esriCTSelectFeatureToCopyParentContainer"\x3e\r\n      \x3cdiv class\x3d"esriCTSelectFeatureLabel"\x3e${nls.workBench.featureModeText}:\x3c/div\x3e\r\n      \x3cdiv class\x3d"esriCTSelectFeatureToCopyContainer"\x3e\r\n        \x3cdiv class\x3d"esriCTSketchEnable esriCTFeatureModeIcons" data-dojo-attach-point\x3d"sketchButton" title\x3d"${nls.workBench.sketchToolTitle}"\x3e\x3c/div\x3e\r\n        \x3cdiv class\x3d"esriCTSelectDisable esriCTFeatureModeIcons" data-dojo-attach-point\x3d"selectButton" title\x3d"${nls.workBench.selectToolTitle}"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"projectOverview"\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv class\x3d"esriCTPageFooter"\x3e\r\n    \x3cdiv class\x3d"jimu-btn esriCTEllipsis" data-dojo-attach-point\x3d"backButton"\x3e${nls.common.back}\x3c/div\x3e\r\n    \x3cdiv class\x3d"jimu-btn esriCTEllipsis" data-dojo-attach-point\x3d"refreshButton"\x3e${nls.workBench.refresh}\x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare jimu/BaseWidget jimu/FilterManager dojo/Evented dijit/_WidgetsInTemplateMixin dojo/text!./work-bench.html dojo/_base/lang dojo/dom-attr dojo/_base/array dojo/dom-class dojo/on esri/graphic dojo/dom-construct dojo/Deferred dojo/promise/all esri/layers/FeatureLayer esri/tasks/GeometryService esri/graphicsUtils ./template-picker ./project-overview ./project-summary ./asset-details esri/tasks/query esri/tasks/QueryTask esri/geometry/geometryEngine esri/SpatialReference esri/geometry/Point".split(" "),
function(x,y,z,A,B,C,d,D,k,t,h,n,p,q,r,m,u,E,F,G,H,I,J,K,L,v,w){return x([y,A,B],{templateString:C,baseClass:"jimu-widget-cost-analysis-work-bench",_projectOverview:null,_projectSummary:null,_assetItemSummary:{},_assetGroupSummary:{},_assetTableIds:{},_recentlyOperatedLayerIds:[],_projectAssetTable:null,_additionalCostTable:null,_assetInfoForReset:{},filterManager:null,_pointLayer:null,_originalTemplateAttributes:null,_isLoadingProject:null,_exsitingLabelPointDefExpression:null,postCreate:function(){this.inherited(arguments);
this._assetItemSummary={};this._assetGroupSummary={};this._assetTableIds={};this._recentlyOperatedLayerIds=[];this._assetInfoForReset={};this.filterManager=z.getInstance();this._exsitingLabelPointDefExpression=this._isLoadingProject=this._originalTemplateAttributes=this._pointLayer=null},onWidgetActive:function(){this._templatePicker&&this._templatePicker.bindLayerEvents()},onWidgetDeActive:function(){this._templatePicker&&this._templatePicker._editor&&this._templatePicker._editor.editToolbar&&(this._templatePicker._editor.templatePicker.clearSelection(),
this._templatePicker._editor.editToolbar.deactivate(),this._templatePicker.removeLayerEvents())},onShow:function(){this.refreshTemplatePicker()},onWidgetOpen:function(){this.refreshTemplatePicker();this.config.projectSettings.projectLayer||(this._recentlyOperatedLayerIds=[],this._filterAssets());this._templatePicker&&!this._templatePicker._editor&&(this._disableWebMapPopup(),this._templatePicker.initEditingToolbar())},onWidgetClose:function(){this.config.projectSettings.projectLayer||this._clearAppliedFilters();
this._templatePicker&&this._templatePicker._editor&&(this._templatePicker._editor.destroy(),this._templatePicker._editor=null,this._enableWebMapPopup())},refreshTemplatePicker:function(){if(this._templatePicker)this._templatePicker.onWindowResize()},startup:function(){this.inherited(arguments);this._storeExistingLabelPointLayerDefExpression();this.config.projectSettings.projectLayer?this.own(h(this.backButton,"click",d.hitch(this,function(){t.contains(this.backButton,"jimu-state-disabled")||(this._clearAppliedFilters(),
this._templatePicker.destroy(),this._templatePicker=null,this._enableWebMapPopup(),this.emit("showProjectPanel"))}))):(D.set(this.refreshButton,"innerHTML",this.nls.common.reset),t.add(this.backButton,"esriCTHidden"));this.own(h(this.refreshButton,"click",d.hitch(this,function(){this._clearAppliedFilters();this._templatePicker&&(this._templatePicker.destroy(),this._templatePicker=null);this.projectInfo.projectId&&this.config.projectSettings.projectLayer?this.emit("reloadProject",this.projectInfo.projectId):
this._resetProject()})));this.onProjectCreateOrLoad(this.projectInfo,this.assetInfo)},_resetProject:function(){var a=[],b;this.loadingIndicator.show();if(this._assetInfoForReset&&0<Object.keys(this._assetInfoForReset).length)for(b in this._assetInfoForReset){var c,f;c=this.layerInfosObj.getLayerInfoById(b).layerObject;f=c.globalIdField+" in ('"+this._assetInfoForReset[b].join("','")+"')";a.push(this.appUtils.deleteFeatures(c.url,f))}r(a).then(d.hitch(this,function(){this.loadingIndicator.hide();this._assetInfoForReset=
{};this.onProjectCreateOrLoad(this.projectInfo,this.assetInfo);this.emit("resetProject")}),d.hitch(this,function(){this.loadingIndicator.hide()}))},_clearAppliedFilters:function(){this.config.projectSettings.projectLayer&&this.filterManager.applyWidgetFilter(this.config.projectSettings.projectLayer,this.widgetId,"",!0,!0);this._recentlyOperatedLayerIds=[];k.forEach(this.config.layerSettings,d.hitch(this,function(a){var b;b=this.layerInfosObj.getLayerInfoById(a.id);a.editable&&b&&b.layerObject&&b.layerObject.clearSelection()}));
var a=this.map.getLayer(this.config.projectSettings.pointLayerCentroid);a&&(a.setDefinitionExpression(this._exsitingLabelPointDefExpression),a.refresh());this._filterAssets(!0)},_loadProjectAssetTable:function(){var a=new q;if(this.config.projectSettings.assetTable&&!this._projectAssetTable){var b;b=this.layerInfosObj.getTableInfoById(this.config.projectSettings.assetTable).layerObject;this._projectAssetTable=new m(b.url);this.own(h(this._projectAssetTable,"load",function(){a.resolve()}))}else a.resolve();
return a.promise},_loadAdditionalCostTable:function(){var a,b;b=new q;(a=this.config.projectSettings.multiplierAdditionalCostTable)&&!this._additionalCostTable?(a=this.layerInfosObj.getTableInfoById(a).layerObject.url,this._additionalCostTable=new m(a),this.own(h(this._additionalCostTable,"load",function(){b.resolve()}))):b.resolve();return b.promise},onProjectCreateOrLoad:function(a,b){var c=[];this.projectInfo=a;this._displayLabelRelatedToSelectProject();c.push(this._loadProjectAssetTable());c.push(this._loadAdditionalCostTable());
r(c).then(d.hitch(this,function(){var c,e,g;this.projectInfo=a;this._recentlyOperatedLayerIds=[];this._assetTableIds={};this._assetItemSummary={};this._assetGroupSummary={};this._disableWebMapPopup();this.initWorkBenchComponents().then(d.hitch(this,function(){g=this.config.projectSettings.projectLayer;this.projectInfo.projectId&&g&&(e=this.layerInfosObj.getLayerInfoById(g).layerObject,c=e.globalIdField+"\x3d '"+this.projectInfo.projectId+"'",this.filterManager.applyWidgetFilter(g,this.widgetId,c,
!0,!0));this._projectOverview&&this._projectOverview.showAssetItemSummary(this._assetItemSummary,!1);this._assetDetails&&this._assetDetails.reset();b?this.loadProject(b):(this._filterAssets(),this._projectSummary.addConfiguredAdditionalCostArray())}))}))},loadProject:function(a){var b=[];this._isLoadingProject=!0;this._projectSummary.loadingProject=!0;this._projectSummary.loadAdditionalCost(a.additionalCostInfo);for(var c in a.assetInfo){var f=a.assetInfo[c],e=this.layerInfosObj.getLayerInfoById(c).layerObject,
b=b.concat(f);this._loadAsset(e,f,a,c)}this._setExtentToProjectAssets(b);this._recentlyOperatedLayerIds=[];this._onAssetInfoUpdate();this._projectSummary.loadingProject=!1;this._projectSummary.calculateGrossCost(this._projectSummary.totalCost,!1)},_loadAsset:function(a,b,c,f){k.forEach(b,d.hitch(this,function(b){var e=b.attributes[a.globalIdField],d=c.assetTemplateInfo[e];b.templateInfo=d;b.templateName=d.TEMPLATENAME;this._templatePicker.loadCostingInfo(f,d);this._assetTableIds[e]=d.OBJECTID;this._onFeaturesAdded([b],
a,[d],!1)}))},_setExtentToProjectAssets:function(a){0<a.length&&this.map.setExtent(E.graphicsExtent(a).expand(1.5))},initWorkBenchComponents:function(){var a=new q;this._initTemplatePicker();this._initProjectSummary();this._initProjectOverview();this._initAssetDetails(a);return a.promise},_initTemplatePicker:function(){var a=p.create("div",{},this.templatePickerContainer);this._templatePicker=new F({config:this.config,nls:this.nls,layerInfosObj:this.layerInfosObj,loadingIndicator:this.loadingIndicator,
projectInfo:this.projectInfo,selectedProjectFeatureAttr:this.selectedProjectFeatureAttr?this.selectedProjectFeatureAttr:null,map:this.map,selectFeaturesNode:this.copyFeaturesNode,selectButton:this.selectButton,sketchButton:this.sketchButton,appUtils:this.appUtils,widgetId:this.widgetId},a);h(this._templatePicker,"assetAdded",d.hitch(this,function(a,c,f){0<a.length&&0<f.length&&(this._onFeaturesAdded(a,c,f,!0),this.emit("onAssetAdded",a,c.id,this._projectA),this._onAssetInfoUpdate())}));h(this._templatePicker,
"assetDeleted",d.hitch(this,function(a,c){var b;b=this._getGlobalIds(c.globalIdField,a);this._onFeaturesUpdated(a);this._onAssetInfoUpdate();k.forEach(b,d.hitch(this,function(a){this._assetTableIds.hasOwnProperty(a)&&delete this._assetTableIds[a];this._assetInfoForReset&&this._assetInfoForReset[c.id]&&(a=this._assetInfoForReset[c.id].indexOf(a),-1<a&&this._assetInfoForReset[c.id].splice(a,1))}));this._projectAssetTable&&(a=this.config.assetTableFields.ASSETGUID+" in ('"+b.join("','")+"')",this.appUtils.deleteFeatures(this._projectAssetTable.url,
a))}));h(this._templatePicker,"assetUpdated",d.hitch(this,function(a){this._onFeaturesUpdated(a,!0);this._onAssetInfoUpdate()}));this._templatePicker.startup()},_initProjectSummary:function(){this._projectSummary?this._projectSummary.reset(this.projectInfo):(this._projectSummary=new H({nls:this.nls,map:this.map,config:this.config,appUtils:this.appUtils,layerInfosObj:this.layerInfosObj,projectInfo:this.projectInfo,additionalCostTable:this._additionalCostTable},p.create("div",{},this.projectSummaryDiv)),
this.own(h(this._projectSummary,"grossCostUpdated",d.hitch(this,function(a,b,c){this._projectOverview.grossCostUpdated(b);this._assetDetails.grossCostUpdated(a,b,c);this.emit("onGrossCostUpdated",a,b,c)}))),this.own(h(this._projectSummary,"onOkButtonClicked",d.hitch(this,function(){this.emit("showAssetDetails")}))),this.own(h(this._projectSummary,"onCancelButtonClicked",d.hitch(this,function(){this.emit("showAssetDetails")}))),this._projectSummary.startup())},_initProjectOverview:function(){this._projectOverview?
this._projectOverview.updateProjectInfo(this.projectInfo):(this._projectOverview=new G({config:this.config,appUtils:this.appUtils,nls:this.nls,map:this.map,layerInfosObj:this.layerInfosObj,geometryService:new u(this.config.helperServices.geometry.url),projectInfo:this.projectInfo},p.create("div",{},this.projectOverview)),this.own(h(this._projectOverview,"actionClicked",d.hitch(this,function(a){this.emit("actionClicked",a)}))),this.own(h(this._projectOverview,"titleClicked",d.hitch(this,function(a){this.emit("titleClicked",
a)}))),this.own(h(this._projectOverview,"totalCostCalculated",d.hitch(this,function(a){this._assetDetails.totalCostUpdated(a);this._projectSummary.calculateGrossCost(a,!0)}))),this.own(h(this._projectOverview,"addOrModifyLabelPoint",d.hitch(this,function(a){this._addOrModifyLabelPoint(a.projectGeometry)}))),this._projectOverview.startup())},_initAssetDetails:function(a){this._assetDetails?(this._assetDetails.showAssetDetails({}),a.resolve()):(this._assetDetails=new I({nls:this.nls,map:this.map,config:this.config,
appUtils:this.appUtils,layerInfosObj:this.layerInfosObj},p.create("div",{},this.assetDetailsDiv)),this.own(h(this._assetDetails,"showAdditionalCost",d.hitch(this,function(){this._projectSummary&&this._projectSummary.cloneTableData();this.emit("showAdditionalCost")}))),this.own(h(this._assetDetails,"onOkButtonClicked",d.hitch(this,function(){this.emit("showWorkBenchPanel")}))),this.own(h(this._assetDetails,"onCancelButtonClicked",d.hitch(this,function(){this.emit("showWorkBenchPanel")}))),this.own(h(this._assetDetails,
"onLoad",d.hitch(this,function(){a.resolve()}))),this.own(h(this._assetDetails,"groupCostEquationUpdated",d.hitch(this,this._updateGroupCostEquation))),this._assetDetails.startup())},_onAssetInfoUpdate:function(){this._projectOverview.showAssetItemSummary(this._assetItemSummary,!0);this._assetDetails.showAssetDetails(this._assetGroupSummary);this._filterAssets();this.emit("assetInfoUpdated",this._assetItemSummary)},_addAssetGroupSummary:function(a,b,c){var f=c[0].TEMPLATENAME;this._assetGroupSummary.hasOwnProperty(b.id)?
this._assetGroupSummary[b.id].hasOwnProperty(f)||(this._assetGroupSummary[b.id][f]={}):(this._assetGroupSummary[b.id]={},this._assetGroupSummary[b.id][f]={});k.forEach(a,d.hitch(this,function(a,d){d=c[d];d.SCENARIO===this.nls.scenarioSelection.noneText&&(d.SCENARIO="null");d.GEOGRAPHY===this.nls.scenarioSelection.noneText&&(d.GEOGRAPHY="null");this._assetGroupSummary[b.id][f].hasOwnProperty(d.GEOGRAPHY)?this._assetGroupSummary[b.id][f][d.GEOGRAPHY].hasOwnProperty(d.SCENARIO)||(this._assetGroupSummary[b.id][f][d.GEOGRAPHY][d.SCENARIO]=
[]):(this._assetGroupSummary[b.id][f][d.GEOGRAPHY]={},this._assetGroupSummary[b.id][f][d.GEOGRAPHY][d.SCENARIO]=[]);this._assetGroupSummary[b.id][f][d.GEOGRAPHY][d.SCENARIO].push(a)}))},_updateAssetGroupSummary:function(a,b,c){var f,e,g,l;e=b.templateInfo.TEMPLATENAME;g=b.templateInfo.GEOGRAPHY;l=b.templateInfo.SCENARIO;f=b.attributes[a.objectIdField];g===this.nls.scenarioSelection.noneText&&(g="null");l===this.nls.scenarioSelection.noneText&&(l="null");k.some(this._assetGroupSummary[a.id][e][g][l],
d.hitch(this,function(d,k){if(d.attributes[a.objectIdField]===f)return c?this._assetGroupSummary[a.id][e][g][l][k].featureDimension=b.featureDimension:this._assetGroupSummary[a.id][e][g][l].splice(k,1),!0}))},_onFeaturesAdded:function(a,b,c,f){var e,g=[];e=c[0].TEMPLATENAME;g=this._getGlobalIds(b.globalIdField,a);this._addAssetGroupSummary(a,b,c);this._assetItemSummary.hasOwnProperty(b.id)?this._assetItemSummary[b.id].templates.hasOwnProperty(e)?(a=this._assetItemSummary[b.id].templates[e].features.concat(a),
this._assetItemSummary[b.id].templates[e].units=a.length):this._assetItemSummary[b.id].templates[e]={units:a.length,features:a,cost:null}:(this._assetItemSummary[b.id]={layerName:b.name,templates:{},geometryType:b.geometryType},this._assetItemSummary[b.id].templates[e]={units:a.length,features:a,cost:null});this._recentlyOperatedLayerIds=[b.id];this._setFeaturesAndUnits(a,b,e);this._assetItemSummary[b.id].templates[e].cost=this._getTotalCost(b,e);f&&this._projectAssetTable?this._addAssetsToProjectAssetTable(c,
g):(this._assetInfoForReset||(this._assetInfoForReset={}),this._assetInfoForReset[b.id]=this._assetInfoForReset[b.id]?this._assetInfoForReset[b.id].concat(g):d.clone(g))},_updateFeaturesInfo:function(a){var b;k.forEach(a,d.hitch(this,function(a){var c;c=a._layer;for(b in this._assetItemSummary[c.id].templates)this._setUpdatedTemplateFeatures(a,c,b)}));return a},_setUpdatedTemplateFeatures:function(a,b,c){k.some(this._assetItemSummary[b.id].templates[c].features,d.hitch(this,function(f){if(f.attributes[b.objectIdField]===
a.attributes[b.objectIdField])return a.featureDimension=f.featureDimension,a.templateName=c,a.templateInfo=f.templateInfo,!0}))},_onFeaturesUpdated:function(a,b){a=this._updateFeaturesInfo(a);this._recentlyOperatedLayerIds=[];k.forEach(a,d.hitch(this,function(a){var c,e;e=a.templateName;c=a._layer;this._recentlyOperatedLayerIds.push(c.id);k.some(this._assetItemSummary[c.id].templates[e].features,d.hitch(this,function(d,f){if(d.attributes[c.objectIdField]===a.attributes[c.objectIdField])return this._assetItemSummary.hasOwnProperty(c.id)&&
this._assetItemSummary[c.id].templates[e]&&(b?(this._assetItemSummary[c.id].templates[e].features[f]=a,this._setFeaturesAndUnits(this._assetItemSummary[c.id].templates[e].features,c,e,b)):(d=this._assetItemSummary[c.id].templates[e].units,d-=a.featureDimension,this._assetItemSummary[c.id].templates[e].units=this.appUtils.removeNegativeExponents(d)),this._updateAssetGroupSummary(c,a,b)),b||this._assetItemSummary[c.id].templates[e].features.splice(f,1),!0}));0===this._assetItemSummary[c.id].templates[e].features.length?
delete this._assetItemSummary[c.id].templates[e]:this._assetItemSummary[c.id].templates[e].cost=this._getTotalCost(c,e);0===Object.keys(this._assetItemSummary[c.id].templates).length&&delete this._assetItemSummary[c.id]}))},_setFeaturesAndUnits:function(a,b,c,f){var e,g=0;e=this.config.generalSettings.measurementUnit;k.forEach(a,d.hitch(this,function(a){if(!a.hasOwnProperty("featureDimension")||f)a.featureDimension="esriGeometryPolygon"===b.geometryType?this.appUtils.getAreaOfGeometry(a.geometry,
this.appUtils.units[e].areaUnit):"esriGeometryPolyline"===b.geometryType?this.appUtils.getLengthOfGeometry(a.geometry,this.appUtils.units[e].lengthUnit):1,f||(a.templateName=c);g+=a.featureDimension}));this._assetItemSummary[b.id].templates[c].features=a;return this._assetItemSummary[b.id].templates[c].units=g},_getGroupTotalMeasure:function(a,b){var c,f,e,g;c=0;e=b.TEMPLATENAME;g=b.GEOGRAPHY;b=b.SCENARIO;try{f=this._assetGroupSummary[a][e][g][b],k.forEach(f,d.hitch(this,function(a){c+=a.featureDimension}))}catch(l){c=
0}return c},_getGroupTotalCount:function(a,b){var c,d,e,g;c=0;e=b.TEMPLATENAME;g=b.GEOGRAPHY;b=b.SCENARIO;try{(d=this._assetGroupSummary[a][e][g][b])&&0<d.length&&(c=d.length)}catch(l){c=0}return c},_getTotalCost:function(a,b){var c=0;k.forEach(this._assetItemSummary[a.id].templates[b].features,d.hitch(this,function(f){var e,g,l,h;l=this._getGroupTotalMeasure(a.id,f.templateInfo);h=this._getGroupTotalCount(a.id,f.templateInfo);try{g=f.templateInfo.COSTEQUATION,g=g.replace(/{MEASURE}/ig,f.featureDimension),
g=g.replace(/{TOTALMEASURE}/ig,l),g=g.replace(/{TOTALCOUNT}/ig,h),e=this.appUtils.evaluate(g)}catch(M){e=0}k.some(this._assetGroupSummary[a.id][b][f.templateInfo.GEOGRAPHY][f.templateInfo.SCENARIO],d.hitch(this,function(b){if(b.attributes[a.objectIdField]===f.attributes[a.objectIdField])return b.individualCost=e,!0}));f.individualCost=e;c+=e}));return Number(c)},_getGlobalIds:function(a,b){var c=[];k.forEach(b,d.hitch(this,function(b){c.push(b.attributes[a])}));return c},_getExpressionToFilterAssets:function(a){var b,
c=[],d,e;if((e=this.layerInfosObj.getLayerInfoById(a))&&e.layerObject&&this._assetItemSummary[a])for(b in d=e.layerObject,this._assetItemSummary[a].templates)c=c.concat(this._getGlobalIds(d.globalIdField,this._assetItemSummary[a].templates[b].features));return 0<c.length?d.globalIdField+" in ('"+c.join("','")+"')":"1\x3d2"},_filterAssets:function(a){this._recentlyOperatedLayerIds&&0!==this._recentlyOperatedLayerIds.length||(this._recentlyOperatedLayerIds=[],k.forEach(this.config.layerSettings,d.hitch(this,
function(a){a.editable&&this._recentlyOperatedLayerIds.push(a.id)})));k.forEach(this._recentlyOperatedLayerIds,d.hitch(this,function(b){var c="";a||(c=this._getExpressionToFilterAssets(b));this.filterManager.applyWidgetFilter(b,this.widgetId,c,!0,!0)}))},_addAssetsToProjectAssetTable:function(a,b){var c=[],f=["COSTEQUATION","SCENARIO","TEMPLATENAME","GEOGRAPHYGUID"];this.loadingIndicator.show();k.forEach(b,d.hitch(this,function(b,g){var e={};k.forEach(this._projectAssetTable.fields,d.hitch(this,function(c){var d=
"";-1<f.indexOf(c.name.toUpperCase())?(d=a[g][c.name.toUpperCase()],"SCENARIO"!==c.name.toUpperCase()&&"GEOGRAPHYGUID"!==c.name.toUpperCase()||"null"!==d||(d=null),e[c.name]=d):"ASSETGUID"===c.name.toUpperCase()?e[c.name]=b:"PROJECTGUID"===c.name.toUpperCase()&&this.projectInfo.projectId&&(e[c.name]=this.projectInfo.projectId)}));c.push(new n(null,null,e))}));this._projectAssetTable.applyEdits(c,null,null,d.hitch(this,function(a){var c=!1;k.forEach(a,d.hitch(this,function(a,d){a.success?this._assetTableIds[b[d]]=
a.objectId:c=!0}));c&&this.appUtils.showMessage(this.nls.workBench.errorInSavingAssetDetails);this.loadingIndicator.hide()}),d.hitch(this,function(){this.loadingIndicator.hide();this.appUtils.showMessage(this.nls.workBench.errorInSavingAssetDetails)}))},_updateGroupCostEquation:function(a){var b=[],c,f,e;c=a.groupInfo;f=this._assetGroupSummary[c.layerId][c.templateName][c.region][c.scenario];e=this.layerInfosObj.getLayerInfoById(c.layerId).layerObject;k.forEach(f,d.hitch(this,function(f){var g={},
h,m;h=f.attributes[e.globalIdField];m=f.attributes[e.objectIdField];k.some(this._assetItemSummary[c.layerId].templates[c.templateName].features,d.hitch(this,function(b){if(b.attributes[e.objectIdField]===m)return b.templateInfo.COSTEQUATION=a.templateInfo.COSTEQUATION,b.templateInfo.SCENARIO=a.templateInfo.SCENARIO,!0}));f.templateInfo.COSTEQUATION=a.templateInfo.COSTEQUATION;f.templateInfo.SCENARIO=a.templateInfo.SCENARIO;this._projectAssetTable&&this._assetTableIds[h]&&(g[this.config.assetTableFields.COSTEQUATION]=
a.templateInfo.COSTEQUATION,g[this.config.assetTableFields.SCENARIO]="null"===a.templateInfo.SCENARIO?null:a.templateInfo.SCENARIO,g[this.config.assetTableFields.OBJECTID]=this._assetTableIds[h],b.push(new n(null,null,g)))}));delete this._assetGroupSummary[c.layerId][c.templateName][c.region][c.scenario];this._assetGroupSummary[c.layerId][c.templateName][c.region][a.templateInfo.SCENARIO]=f;this._templatePicker.loadCostingInfo(e.id,f[0].templateInfo);this._assetItemSummary[e.id].templates[c.templateName].cost=
this._getTotalCost(e,c.templateName);this._projectOverview.showAssetItemSummary(this._assetItemSummary,!1);this._assetDetails.showAssetDetails(this._assetGroupSummary);this._projectAssetTable&&(this.loadingIndicator.show(),this._projectAssetTable.applyEdits(null,b,null,d.hitch(this,function(){this.loadingIndicator.hide()}),d.hitch(this,function(){this.loadingIndicator.hide()})))},_enableWebMapPopup:function(){this.map&&this.map.setInfoWindowOnClick(!0)},_disableWebMapPopup:function(){this.map&&this.map.setInfoWindowOnClick(!1);
this._hideWebMapPopup()},_hideWebMapPopup:function(){this.map.infoWindow.isShowing&&this.map.infoWindow.hide();this.map.infoWindow.clearFeatures()},_addOrModifyLabelPoint:function(a){this.loadingIndicator.show();""!==this.config.projectSettings.pointLayerCentroid&&null!==this.config.projectSettings.pointLayerCentroid&&void 0!==this.config.projectSettings.pointLayerCentroid?this._isLoadingProject?this._displayLabelRelatedToSelectProject():this._checkExistingLabelPoint(a):this.loadingIndicator.hide()},
_displayLabelRelatedToSelectProject:function(){if(this._pointLayer=this.map.getLayer(this.config.projectSettings.pointLayerCentroid)){var a=this._pointLayer.getDefinitionExpression(),b=this._getFieldName(this._pointLayer,"projectid")+" \x3d '"+this.projectInfo.projectId+"'";""!==a&&null!==a&&void 0!==a?-1===a.indexOf(b)&&(a=a+" AND "+b):a=b;this._pointLayer.setDefinitionExpression(a);this._pointLayer.refresh()}this._isLoadingProject=!1;this.loadingIndicator.hide()},_checkExistingLabelPoint:function(a){var b=
{};b.existingLabelPoint=this._getExistingLabelPointDeferred();r(b).then(d.hitch(this,function(b){0<b.existingLabelPoint.features.length?this._createLabelPoint(!1,a,b.existingLabelPoint.features[0]):this._createLabelPoint(!0,a)}),d.hitch(this,function(){this.loadingIndicator.hide();this.appUtils.showMessage(this.nls.createLoadProject.errorAddingPointLabel)}))},_createLabelPoint:function(a,b,c){if(0<b.rings.length){var f=new u(this.config.helperServices.geometry.url);b=L.simplify(b);f.labelPoints([b],
d.hitch(this,function(b){this.config.projectSettings.pointLayerCentroid&&(b=b[0],a?this._addLabelPoint(b):this._updateExistingLabelPoint(c,b))}),d.hitch(this,function(){this.loadingIndicator.hide();this.appUtils.showMessage(this.nls.createLoadProject.errorFetchingPointLabel)}))}else this._deleteExistingLabelPoint(c)},_deleteExistingLabelPoint:function(a){if(a){var b={};b[this._pointLayer.objectIdField]=a.attributes[this._pointLayer.objectIdField];var c=new n(null,null,b,null),f=new m(this._pointLayer.url,
{outFields:["*"]});f.onLoad=d.hitch(this,function(){f.applyEdits(null,null,[c],d.hitch(this,function(a,b,c){c[0].success||this.appUtils.showMessage(this.nls.createLoadProject.errorAddingPointLabel);this.map.getLayer(this.config.projectSettings.pointLayerCentroid).refresh();this.loadingIndicator.hide()}),d.hitch(this,function(){this.loadingIndicator.hide();this.appUtils.showMessage(this.nls.createLoadProject.errorAddingPointLabel)}))})}else this.loadingIndicator.hide()},_getExistingLabelPointDeferred:function(){var a;
a=this._getFieldName(this._pointLayer,"projectid")+" \x3d '"+this.projectInfo.projectId+"'";var b=new K(this._pointLayer.url),c=new J;c.outFields=["*"];c.where=a;c.returnGeometry=!0;c.outSpatialReference=this.map.spatialReference;return b.execute(c).promise},_getFieldName:function(a,b){var c;k.forEach(a.fields,d.hitch(this,function(a){a.name.toLowerCase()===b.toLowerCase()&&(c=a.name)}));return c},_addLabelPoint:function(a){var b=new w(a.x,a.y,new v({wkid:this.map.spatialReference.wkid}));a=this._pointLayer.hasOwnProperty("templates")&&
0<this._pointLayer.templates.length&&this._pointLayer.templates[0].hasOwnProperty("prototype")&&this._pointLayer.templates[0].prototype.hasOwnProperty("attributes")?this._pointLayer.templates[0].prototype.attributes:this._pointLayer.hasOwnProperty("types")&&0<this._pointLayer.types.length&&this._pointLayer.types[0].hasOwnProperty("templates")&&0<this._pointLayer.types[0].templates.length&&this._pointLayer.types[0].templates[0].hasOwnProperty("prototype")&&this._pointLayer.types[0].templates[0].prototype.hasOwnProperty("attributes")?
this._pointLayer.types[0].templates[0].prototype.attributes:null;null===this._originalTemplateAttributes||""===this._originalTemplateAttributes||void 0===this._originalTemplateAttributes?this._originalTemplateAttributes=d.clone(a):a=d.clone(this._originalTemplateAttributes);var c=this._getFieldName(this._pointLayer,"projectid");a[c]=this.projectInfo.projectId;a=new n(b,null,a,null);(new m(this._pointLayer.url)).applyEdits([a],null,null,d.hitch(this,function(a,b,c){a[0].success||this.appUtils.showMessage(this.nls.createLoadProject.errorAddingPointLabel);
this.map.getLayer(this.config.projectSettings.pointLayerCentroid).refresh();this.loadingIndicator.hide()}),d.hitch(this,function(){this.loadingIndicator.hide();this.appUtils.showMessage(this.nls.createLoadProject.errorAddingPointLabel)}))},_updateExistingLabelPoint:function(a,b){var c={};c[this._pointLayer.objectIdField]=a.attributes[this._pointLayer.objectIdField];a=new w(b.x,b.y,new v({wkid:this.map.spatialReference.wkid}));var f=new n(a,null,c,null),e=new m(this._pointLayer.url,{outFields:["*"]});
e.onLoad=d.hitch(this,function(){e.applyEdits(null,[f],null,d.hitch(this,function(a,b,c){b[0].success||this.appUtils.showMessage(this.nls.createLoadProject.errorAddingPointLabel);this.map.getLayer(this.config.projectSettings.pointLayerCentroid).refresh();this.loadingIndicator.hide()}),d.hitch(this,function(){this.loadingIndicator.hide();this.appUtils.showMessage(this.nls.createLoadProject.errorAddingPointLabel)}))})},updateProjectFeatureAttributes:function(a){this._templatePicker.selectedProjectFeatureAttr=
a},_storeExistingLabelPointLayerDefExpression:function(){var a=this.map.getLayer(this.config.projectSettings.pointLayerCentroid);a&&(a=a.getDefinitionExpression(),this._exsitingLabelPointDefExpression=d.clone(a))}})});