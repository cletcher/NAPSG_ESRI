// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/CostAnalysis/setting/LayerSettings.html":'\x3cdiv class\x3d"esriCTTabNode"\x3e\r\n  \x3cdiv data-dojo-attach-point\x3d"layerSettingsMainContainer"\x3e\r\n    \x3cdiv class\x3d"esriCTLayerSettingsTableNode" data-dojo-attach-point\x3d"layerSettingsTableNode"\x3e\x3c/div\x3e\r\n    \x3cdiv class\x3d"esriCTHidden esriCTNoAssetLayersAvailable" data-dojo-attach-point\x3d"noAssetLayersAvailable"\x3e\r\n      ${nls.layerSettings.noAssetLayersAvailable}\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare jimu/BaseWidget dojo/Evented jimu/dijit/Message dijit/_WidgetsInTemplateMixin dojo/text!./LayerSettings.html dojo/_base/lang jimu/dijit/SimpleTable jimu/dijit/Popup dojo/_base/array dojo/query dijit/registry dojo/dom-class dojo/dom-construct dojo/_base/html dojo/on dojo/dom-attr ./AttributeSettings".split(" "),function(q,r,t,u,v,w,e,x,y,k,h,n,f,l,z,p,m,A){return q([r,t,v],{templateString:w,attributeSettingPopup:null,baseClass:"jimu-widget-cost-analysis-layer-settings",_layerSettingsTable:null,
constructor:function(a){e.mixin(this,a)},postMixInProperties:function(){this.nls.common={};e.mixin(this.nls.common,window.jimuNls.common)},postCreate:function(){this.inherited(arguments);this.attributeSettingPopup=this._layerSettingsTable=null},setConfig:function(){this._filterLayers()},getConfig:function(){return this._getUpdateLayerSettings()},_getUpdateLayerSettings:function(){var a;if(this._layerSettingsTable)return a=this._layerSettingsTable.getData(),a=this._getSelectedFields(a)},_createlayerSettingsGrid:function(){this._layerSettingsTable=
new x({fields:[{name:"editable",title:this.nls.layerSettings.EditableLayerHeaderTitle,type:"checkbox",editable:!1,width:"16%"},{name:"title",title:this.nls.layerSettings.layerNameHeaderTitle,type:"text",editable:!1,width:"64%"},{name:"fieldPicker",title:this.nls.layerSettings.fieldPickerHeaderTitle,type:"empty",editable:!1,hidden:!0,width:"0%"},{name:"selectable",title:"",type:"checkbox",editable:!1,hidden:!0,width:"0%"},{name:"id",title:"",type:"text",editable:!1,hidden:!0,width:"0%"},{name:"url",
title:"",type:"text",editable:!1,hidden:!0,width:"0%"},{name:"attributeSetting",title:this.nls.layerSettings.attributeSettingHeaderTitle,type:"empty",editable:!1,width:"20%"}],selectable:!0});this._layerSettingsTable.placeAt(this.layerSettingsTableNode);z.setStyle(this._layerSettingsTable.domNode,{height:"100%"});this._layerSettingsTable.startup()},onLayerSettingChange:function(a){var b={};if(a=this._layerSettingsTable.getRowData(a))b.layerId=a.id,b.editable=null===a.editable?!1:a.editable;this.emit("onLayerSettingUpdate",
b)},_filterLayers:function(){var a,b,c=[];a=this.map.itemInfo.itemData.operationalLayers;0===a.length?f.remove(this.noAssetLayersAvailable,"esriCTHidden"):(f.add(this.noAssetLayersAvailable,"esriCTDisabled"),this._createlayerSettingsGrid(),this._setTableHeadTooltip(),c=[this.config.projectSettings.costingGeometryLayer||"",this.config.projectSettings.projectLayer||"",this.config.projectSettings.pointLayerCentroid||""],this.config&&0<this.config.layerSettings.length&&k.forEach(this.config.layerSettings,
e.hitch(this,function(a){(b=this.map.getLayer(a.id))&&(!b.errors||0>=b.errors.length)&&(c.push(a.id),b.editable=this._checkEditCapabilities(b),this._createFieldsRows(a,b.editable))})),k.forEach(a,e.hitch(this,function(a){a.errors&&!(0>=a.errors.length)||"ArcGISFeatureLayer"!==a.layerType||a.hasOwnProperty("featureCollection")||-1!==c.indexOf(a.id)||(a.selectable=!0,a.editable=this._checkEditCapabilities(a.layerObject),this._createFieldsRows(a,a.editable))})));this.updateAttributeButtonState(this.config.projectSettings.projectLayer)},
_checkEditCapabilities:function(a){return a&&a.capabilities&&-1!==a.capabilities.indexOf("Delete")&&-1!==a.capabilities.indexOf("Create")&&-1!==a.capabilities.indexOf("Update")&&a.globalIdField?!0:!1},_getInvalidLayersMsg:function(a){var b,c=[];b="";a=this.layerInfosObj.getLayerInfoById(a).layerObject;a.capabilities?(-1===a.capabilities.indexOf("Create")&&c.push("Create"),-1===a.capabilities.indexOf("Update")&&c.push("Update"),-1===a.capabilities.indexOf("Delete")&&c.push("Delete")):c=["Create","Update",
"Delete"];0<c.length&&(b=this.nls.layerSettings.missingCapabilitiesMsg,b+="\x3cbr/\x3e",k.forEach(c,e.hitch(this,function(a){b+="\x3cli\x3e"+this.nls.layerSettings[a.toLowerCase()]+"\x3c/li\x3e"})));a.globalIdField||(b+="\x3cbr/\x3e",b+=this.nls.layerSettings.missingGlobalIdMsg);return b},_enableDisableEditableCheckbox:function(a,b,c){var d,g;d=h(".simple-table-cell ",a)[0];d.children[0]&&(g=n.byNode(d.children[0]));c?g.setStatus(!0):(m.set(g.domNode,"title",this.nls.layerSettings.disableEditableCheckboxTooltip),
g.setValue(!1),g.setStatus(!1),f.add(g.domNode,"jimu-float-leading"),a.errorDiv||(b=this._getInvalidLayersMsg(b.id),a.errorDiv=l.create("div",{"class":"esriCTFieldError"},d),m.set(a.errorDiv,"errorMessage",b),a.errorSpan=l.create("span",{"class":"jimu-icon jimu-icon-error"},a.errorDiv),this.own(p(a.errorDiv,"click",e.hitch(this,function(a){a=m.get(a.currentTarget,"errorMessage");u({message:a})})))))},_createFieldsRows:function(a,b){var c,d,g;a.editable&&(a.selectable=a.editable);c=this._layerSettingsTable.addRow({title:a.title?
a.title:a.name,editable:a.editable,selectable:a.selectable,id:a.id,url:a.url});c.tr.layerInfo=this.map._layers[a.id];c.tr.attributeSettingFields=a.attributeSetting;g=h(".jimu-checkbox",c.tr.children[3]);d=h(".jimu-checkbox",c.tr.children[0]);a.editable&&this._setCheckBoxState(d[0],g[0]);setTimeout(e.hitch(this,function(){this._setHeaderCheckBoxState()}),200);this.own(p(n.byNode(d[0]),"change",e.hitch(this,function(b){this._setCheckBoxState(d[0],g[0]);this._setHeaderCheckBoxState();this.onLayerSettingChange(d[0].parentElement.parentElement);
this._addAttributeSettingIcon(c.tr,a,b)})));this._enableDisableEditableCheckbox(c.tr,a,b);this._addAttributeSettingIcon(c.tr,a,b)},_addAttributeSettingIcon:function(a,b,c){var d;d=h(".simple-table-cell",a)[6];l.empty(d);d&&(c?(a.attributeSetting=l.create("div",{"class":"esriCTAttributeSettingIcon"},d),this.projectLayer&&""!==this.projectLayer||f.add(a.attributeSetting,"esriCTAttributeSettingDisableIcon"),this.own(p(a.attributeSetting,"click",e.hitch(this,function(c){f.contains(c.currentTarget,"esriCTAttributeSettingDisableIcon")||
(c=a.layerInfo,this._curRow=a,c||(c={selectedFields:null},a.layerInfo=c),c.layerLabel="",c.layer=this.layerInfosObj.getLayerInfoById(b.id),this._createAttributeSettingsPopup({nls:this.nls,featureLayer:c.layer.layerObject,selectedFields:a.attributeSettingFields,layerGridInfo:c,config:this.config,projectLayer:this.projectLayer}))})))):a.attributeSetting=l.create("div",{"class":"esriCTAttributeSettingDisableIcon"},d))},updateAttributeButtonState:function(a){var b=!1,c=h(".esriCTAttributeSettingIcon",
this.domNode);a&&""!==a||(b=!0);c&&0<c.length&&k.forEach(c,e.hitch(this,function(a){b?f.add(a,"esriCTAttributeSettingDisableIcon"):f.remove(a,"esriCTAttributeSettingDisableIcon")}))},_createAttributeSettingsPopup:function(a){var b,c,d;a.map=this.map;c=l.create("button",{title:this.nls.common.ok});c.label=this.nls.common.ok;d=l.create("button",{title:this.nls.common.cancel});d.label=this.nls.common.cancel;this._attributeSettings=new A(a);this._attributeSettings.startup();b=new y({titleLabel:this.nls.layerSettings.attributeSettingsPopupTitle,
content:this._attributeSettings,width:830,height:500,autoHeight:!0,buttons:[c,d]});c.onClick=e.hitch(this,function(){this._curRow.attributeSettingFields=this._attributeSettings.okButtonClicked();this._attributeSettings.destroy();this._attributeSettings=null;b.close()});d.onClick=e.hitch(this,function(){this._attributeSettings.destroy();this._attributeSettings=null;b.close()})},_setCheckBoxState:function(a,b){a=n.byNode(a);b=n.byNode(b);a.checked?(b.set("checked",!0),b.set("status",!1),b.set("disable",
!0),f.add(b.domNode,"jimu-state-disabled")):(b.set("checked",!0),b.set("status",!0),b.set("disable",!1),f.remove(b.domNode,"jimu-state-disabled"));f.add(b.domNode.children[0],"checked")},_setHeaderCheckBoxState:function(){var a,b,c=!0,d;a=h(".simple-table-title .checkbox",this.domNode)[1];d=h(".simple-table-title .jimu-checkbox",this.domNode)[1];k.some(this._layerSettingsTable.getRows(),e.hitch(this,function(a){b=h("td.selectable .checked",a);if(0===b.length)return c=!1,!0}));c?(f.add(a,"checked"),
n.byNode(d).set("checked",!0)):(f.remove(a,"checked"),n.byNode(d).set("checked",!1))},updateLayerSettingsTable:function(a){var b=this._layerSettingsTable.getData(),c;a.lastSelectedId&&(c=this.layerInfosObj.getLayerInfoById(a.lastSelectedId))&&c.layerObject&&(c=c.layerObject,c.editable=this._checkEditCapabilities(c),c.selectable=!0,this._createFieldsRows(c,c.editable));a.currentSelectedLayerId&&k.some(b,e.hitch(this,function(b,c){if(b.id===a.currentSelectedLayerId)return this._layerSettingsTable.deleteRow(this._layerSettingsTable.tbody.rows[c]),
!0}))},_getFieldsOptionsObj:function(a){var b=[],c,d;d=a.fields;c=["esriFieldTypeString"];b.push({label:this.nls.layerSettings.selectLabel,value:""});k.forEach(d,e.hitch(this,function(d){d.editable&&!d.domain&&-1<c.indexOf(d.type)&&37<d.length&&d.name!==a.typeIdField&&b.push({label:d.alias||d.name,value:d.name})}));return b},_getSelectedFields:function(a){var b;b=this._layerSettingsTable.getRows();k.forEach(b,e.hitch(this,function(b,d){null===a[d].editable&&(a[d].editable=!1);a[d].attributeSetting=
b.attributeSettingFields;delete a[d].fieldPicker}));return a},_setTableHeadTooltip:function(){var a;a=h(".simple-table-thead th",this.domNode);a.length&&(m.set(a[0],"title",this.nls.layerSettings.EditableLayerHeaderTooltip),m.set(a[1],"title",this.nls.layerSettings.fieldPickerHeaderTooltip),m.set(a[2],"title",this.nls.layerSettings.layerNameHeaderTooltip),m.set(a[3],"title",this.nls.layerSettings.SelectableLayerHeaderTooltip))}})});