// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/array dojo/Deferred dojo/json dojo/number esri/Color esri/request esri/geometry/Polygon".split(" "),function(c,n,h,q,r,t,u){return{computeHistograms:function(a,b,f){var d=this,e=new n,g=b.maxImageWidth,c=b.maxImageHeight;f=this.makePolygon(f);var g=this.getModelPixelSize(f,g,c),k=b.renderingRule.toJson();this.execComputeHistograms(b,f,g,k).then(function(b){b=d.processHistogramResponse(a,b,k);e.resolve(b)}).otherwise(function(a){e.reject(a)});return e},execComputeHistograms:function(a,
b,f,d){a=a.url+"/computeHistograms";var e={f:"json"};e.geometry=h.stringify(b.toJson());e.geometryType="esriGeometryPolygon";e.renderingRule=h.stringify(d);e.pixelSize=h.stringify(f);return t({url:a,content:e,handleAs:"json",callbackParamName:"callback"},{})},getGeometries:function(a){var b=[];c.forEach(a,function(a){a.geometry&&b.push(a.geometry)});return b},getModelPixelSize:function(a,b,f){var d=0,e=0;a=a.getExtent();d=a.getWidth();e=a.getHeight();1>d&&(d=1);1>e&&(e=1);b=Math.max(Math.ceil(d/b),
Math.ceil(e/f));return{x:b,y:b}},isPolygonLayer:function(a){return a&&"esriGeometryPolygon"===a.geometryType?!0:!1},isWROModelLayer:function(a){var b="Title Url Description InputRanges OutputValues NoDataRanges RangeLabels NoDataRangeLabels".split(" ");return a&&"ArcGISImageServiceLayer"===a.type&&10.3<=a.version&&a.renderingRule&&a.renderingRule.rasterFunctionArguments&&a.renderingRule.rasterFunctionArguments.Colormap&&a.allowRasterFunction&&"Nearest"===a.defaultResamplingMethod&&c.every(b,function(b){return c.some(a.fields,
function(a){return b===a.name})})?!0:!1},makePolygon:function(a){return this.mergePolygons(this.getGeometries(a))},mergePolygons:function(a){var b=null;1===a.length?b=a[0]:(b=new u(a[0].spatialReference),c.forEach(a,function(a){c.forEach(a.rings,function(a){b.addRing(a)})}));return b},processHistogramResponse:function(a,b,f){var d={noDataCount:0,colorCounts:[]};if(!b||!b.histograms||0===b.histograms.length)return d;var e=a.util.colorRamp.tipPattern,g=b.histograms[0],h=Math.round(g.min),k=Math.round(g.max)-
1;0===h&&0<g.counts&&(d.noDataCount=g.counts[0]);var l=0;c.forEach(f.rasterFunctionArguments.Colormap,function(b){var f=0,c=b[0],m=null,p=m;b=[b[1],b[2],b[3]];var n=(new r(b)).toHex(),f=c<h||c>k?0:g.counts[c-h];l+=f;a.util.colorRamp[""+c]&&(m=a.util.colorRamp[""+c],p=e.replace("{label}",m).replace("{value}",c));d.colorCounts.push({count:f,value:c,pct:0,label:m,fullLabel:p,rgb:b,hex:n})});0<d.noDataCount&&(l+=d.noDataCount);0<l&&c.forEach(d.colorCounts,function(a){var b=a.count/l*100,b=q.format(b,
{places:2});a.pct=b});return d}}});