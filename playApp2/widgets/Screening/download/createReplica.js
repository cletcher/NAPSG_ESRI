// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/string dojo/Evented jimu/BaseWidget esri/request dojo/Deferred dojo/promise/all esri/geometry/projection esri/SpatialReference".split(" "),function(h,d,k,l,m,n,p,q,r,g,t){return h([n,m],{baseClass:"jimu-widget-screening-create-replica",_extractDataTaskGPService:null,errMessageString:"",responseArray:[],layerDetailsObj:{},constructor:function(b){this._extractDataTaskGPService=null;this.errMessageString="";this.responseArray=[];this.layerDetailsObj=
{};d.mixin(this,b)},startup:function(){this.responseArray=[];this.layerDetailsObj={};this._loadProjection()},_init:function(){var b,c,a;k.forEach(this.config.downloadSettings.layers,d.hitch(this,function(a){var e,d;if(this.downloadFeatureDetailsObj[a.id]&&0<this.downloadFeatureDetailsObj[a.id].length&&-1<a.downloadingFileOption.indexOf(this.fileFormat)&&a.allowDownload){b=a.url.split("/");c=parseInt(b.pop(),10);b=b.join("/");e=!1;for(d in this.layerDetailsObj)d.toLowerCase()===b.toLowerCase()&&(e=
!0,b=d);e||(this.layerDetailsObj[b]={layerInstance:a,layerIndexes:[],layerDetails:{},layerNames:[],wkid:this.filterLayerObj[a.id].spatialReference.wkid});this.layerDetailsObj[b].layerIndexes.push(c);this.layerDetailsObj[b].layerNames.push(a.layerName);this.layerDetailsObj[b].layerDetails[c]={queryOption:"useFilter",useGeometry:!0,where:this.filterLayerObj[a.id].getDefinitionExpression()||""}}}));this.errMessageString="";for(a in this.layerDetailsObj)this.responseArray.push(this._exportFileUsingCreateReplica(a,
this.layerDetailsObj[a]));r(this.responseArray).then(d.hitch(this,function(){this.errMessageString?(this.errMessageString=l.substitute(this.nls.reportsTab.createReplicaFailedMessage,{layerNames:this.errMessageString}),this.emit("createReplicaComplete",this.errMessageString)):this.emit("createReplicaComplete")}))},_exportFileUsingCreateReplica:function(b,c){var a,f,e;a=this._removeDuplicateLayerIds(c.layerIndexes);f=new q;"shapefile"===this.fileFormat?(e=new t({wkid:c.wkid}),e=g.project(this.aoi.geometry,
e)):e=this.aoi.geometry;a={f:"json",replicaName:c.layerInstance.layerName,layers:a.join(),layerQueries:JSON.stringify(c.layerDetails),inSR:JSON.stringify(this.aoi.geometry.spatialReference),geometry:JSON.stringify(e),geometryType:"esriGeometryPolygon",transportType:"esriTransportTypeUrl",returnAttachments:!1,returnAttachmentsDataByUrl:!1,async:!1,syncModel:"none",dataFormat:this.fileFormat};p({url:b+"/createReplica",content:a,handleAs:"json",callbackParamName:"callback"},{usePost:!0}).then(d.hitch(this,
function(a){this.onRequestSucceeded(f,a)}),d.hitch(this,function(a){this.errMessageString&&(this.errMessageString+=", ");this.errMessageString+=c.layerNames.join(", ");this.onRequestFailed(f,a)}));return f.promise},_removeDuplicateLayerIds:function(b){return b.filter(function(b,a,d){return a===d.indexOf(b)})},onRequestSucceeded:function(b,c){var a;b.resolve();c.responseUrl?a=c.responseUrl:c.URL?a=c.URL:c.resultUrl&&(a=c.resultUrl);a&&this.emit("onRequestSucceeded",a)},onRequestFailed:function(b,c){b.resolve();
this.emit("onRequestFailed",c)},_loadProjection:function(){"shapefile"===this.fileFormat?g.load().then(d.hitch(this,function(){this._init()}),d.hitch(this,function(){this.loadingIndicator.hide();this.emit("showMessage",this.nls.reportsTab.errorInLoadingProjectionModule)})):this._init()}})});