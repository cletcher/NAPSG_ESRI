// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/Deferred dojo/_base/lang dojo/promise/all esri/tasks/query esri/tasks/QueryTask jimu/LayerInfos/LayerInfos jimu/DataSourceManager jimu/utils ./utils".split(" "),function(l,e,g,h,m,n,p,q,r,f){return l([],{constructor:function(a){this.appConfig=a.appConfig;this.map=a.map;this.layerInfosObj=p.getInstanceSync();this.dataSourceManager=q.getInstance();this.cacheData={}},destroy:function(){this.cacheData=this.dataSourceManager=this.layerInfosObj=this.map=this.appConfig=null},
preprocessingDataSource:function(a){var b=new e;if(!a)return b.resolve(),b;var c=this._tryGetLayerIdDataSchema(a),d=c.dataSchema,c=this._tryGetLayerObject(c.layerId);a=this._tryGetLayerForFrameWork(d,a);h([c,a]).then(function(a){var c=a[0];b.resolve({layerObject:c&&c.layerObject,popupInfo:c&&c.popupInfo,featureLayerForFrameWork:a[1]})},function(a){b.reject(a)});return b},getFeaturesForSetting:function(a){var b=new e;if(!a)return b.resolve(),b;this.getFeaturesByDataSource(a).then(function(a){a=this._cutFeaturesForSetting(a);
b.resolve(a)}.bind(this),function(a){b.reject(a)});return b},preprocessingDataSourceForSetting:function(a){var b=new e;if(!a)return b.resolve(),b;var c=this._tryGetLayerIdDataSchema(a),d=c.layerId,k=c.dataSchema,c=this._tryGetLayerObject(d),k=this._tryGetLayerForFrameWork(k,a);a=this.getLayerDefinitionByDataSource(a,d);h([c,k,a]).then(function(a){var c=a[0];b.resolve({layerObject:c&&c.layerObject,popupInfo:c&&c.popupInfo,featureLayerForFrameWork:a[1],definition:a[2]})}.bind(this),function(a){b.reject(a)});
return b},preprocessingDataSourceForRange:function(a){var b=new e;if(!a)return b.resolve(),b;var c=this._tryGetLayerIdDataSchema(a).layerId,c=this.getLayerDefinitionByDataSource(a,c);a=this.getFeaturesByDataSource(a);h([c,a]).then(function(a){var c=a[0];a=a[1];a=this._cutFeaturesForSetting(a);b.resolve({definition:c,features:a})}.bind(this),function(a){b.reject(a)});return b},_tryGetLayerIdDataSchema:function(a){var b={layerId:"",dataSchema:null};if(a.layerId)this.dsType="CLIENT_FEATURES",b.layerId=
a.layerId;else if(a.frameWorkDsId){a=(a=f.getDsTypeInfoMeta(a.frameWorkDsId,this.appConfig))&&a.dsMeta;if(!a)return b;"Features"===a.type?this.dsType="FRAMEWORK_FEATURES":"FeatureStatistics"===a.type&&(this.dsType="FRAMEWORK_STATISTICS");b.dataSchema=a.dataSchema;a=f.parseDataSourceId(a.id);b.layerId=a&&a.layerId}return b},_tryGetLayerObject:function(a){var b=new e;if(!a)return b.resolve(),b;a=this._tryGetLayerInfo(a);if(!a)return console.error("Invalid data source"),b.resolve(),b;var c=a.getPopupInfo();
a.getLayerObject().then(function(a){b.resolve({layerObject:a,popupInfo:c})}.bind(this),function(a){b.reject(a)});return b},_tryGetLayerForFrameWork:function(a,b){var c=new e;if(!a)return c.resolve(),c;var d=a;"FRAMEWORK_STATISTICS"===this._getDataSourceType(b)&&(d=f.mockLayerDefinitionForSTD(a));f.getLoadedLayer(d).then(function(a){c.resolve(a)}.bind(this),function(a){c.reject(a)});return c},_tryGetLayerInfo:function(a){var b=this.layerInfosObj.getLayerInfoById(a);b||(b=this.layerInfosObj.getTableInfoById(a));
return b},getLayerDefinitionByDataSource:function(a,b){var c=new e;if(!a)return console.error("Invalid data source"),c.resolve(),c;var d;if(a.layerId){b=this._tryGetLayerInfo(a.layerId);if(!b)return c.reject("Invalid data source"),c;d=b.getPopupInfo();this._getServiceDefinitionByLayerInfo(b).then(function(a){f.addAliasForLayerDefinition(a,d);c.resolve(a)}.bind(this),function(a){c.reject(a)});return c}if(a.frameWorkDsId){b&&(b=this._tryGetLayerInfo(b))&&(d=b.getPopupInfo());b=null;a=(this.appConfig.dataSource&&
this.appConfig.dataSource.dataSources)[a.frameWorkDsId];if("Features"===a.type)return b=g.clone(a.dataSchema),f.addAliasForLayerDefinition(b,d),c.resolve(b),c;if("FeatureStatistics"===a.type)return b={type:"Table",fields:[]},a=g.clone(a.dataSchema),b.fields=a.fields,a.groupByFields&&a.groupByFields[0]&&(b.groupByFields=g.clone(a.groupByFields)),f.addAliasForLayerDefinition(b,d),c.resolve(b),c}},_getDataSourceType:function(a){if(a){if(a.layerId)return"CLIENT_FEATURES";if(a.frameWorkDsId&&(a=(a=f.getDsTypeInfoMeta(a.frameWorkDsId,
this.appConfig))&&a.dsMeta)){if("Features"===a.type)return"FRAMEWORK_FEATURES";if("FeatureStatistics"===a.type)return"FRAMEWORK_STATISTICS"}}},_getServiceDefinitionByLayerInfo:function(a){var b=new e;a.getServiceDefinition().then(g.hitch(this,function(c){c?b.resolve(c):a.getLayerObject().then(function(a){a?(a=r.getFeatureLayerDefinition(a),b.resolve(a)):b.resolve(null)},function(a){b.reject(a)})}));return b},getFeaturesByDataSource:function(a){var b=new e,c=null;if("DATA_SOURCE_FEATURE_LAYER_FROM_MAP"===
a.dataSourceType){a=a.layerId;if(!a)return b.resolve(),b;this._getFeaturesForMapDS(a).then(function(a){c=a.features;b.resolve(c)},function(a){b.reject(a)})}else{a=a.frameWorkDsId;if(!a)return b.resolve(),b;this.getFeaturesForFrameDS(a).then(function(a){c=a.features;b.resolve(c)},function(a){b.reject(a)})}return b},_cutFeaturesForSetting:function(a){a&&1E3<a.length&&(a=a.slice(0,1E3));return a},_getFeaturesForMapDS:function(a){var b=new e,c=this._tryGetLayerInfo(a);if(!c)return b.reject("Can not get layerInfo by the layer id of this data source."),
b;a=c.getUrl();var d=c.getFilter();if(!a)return console.warn("Invalid layer url of data source, use client features."),c.getLayerObject().then(function(a){b.resolve({features:a.graphics})}),b;c=new m;c.outSpatialReference=this.map.spatialReference;c.where=d||"1\x3d1";c.outFields=["*"];c.returnGeometry=!1;return(new n(a)).execute(c)},getFeaturesForFrameDS:function(a){var b=new e;if(this.cacheData[a])return b.resolve(this.cacheData[a]),b;if("widget"===f.parseDataSourceId(a).from)return b.resolve({}),
b;var c=this.dataSourceManager.getDataSourceConfig(a),c=g.clone(c);if(!c)return b.reject("Can not get vaild data source config by the frameWorkDsId of this data source."),b;c.filterByExtent=!1;this.dataSourceManager.doQuery(c).then(function(c){this.cacheData[a]=c;b.resolve(c)}.bind(this),function(a){b.reject(a)});return b}})});