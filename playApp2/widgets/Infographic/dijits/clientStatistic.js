// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["jimu/DataSourceManager","jimu/statisticsUtils","../utils"],function(l,m,e){return{getSingleValueForServerStatFeature:function(a){a=a&&a[0]&&a[0].attributes;if(!a)return null;var b=Object.keys(a)[0];return Number(a[b])},getResultForExtraStatFeature:function(a,b){var c=b.field;b=b.type;c="count"===b?"STAT_COUNT":e.upperCaseString(c+"_"+b);b=a&&a[0]&&a[0].attributes;if(!b)return null;a=b[c];"undefined"===typeof a&&(c=e.lowerCaseString(c),a=b[c]);return Number(a)},statistic:function(a,b,c,d){return a&&
b&&c?"DATA_SOURCE_FEATURE_LAYER_FROM_MAP"===b.dataSourceType?this.getStatisticResultFromFeatures(c,a):"Features"===this._getExtalDataSourceType(b,d)?this.getStatisticResultFromFeatures(c,a):this.statisticExtraStatSource(a,c):null},formatterRangeNumber:function(a){if(!a&&0!==a)return!1;"number"!==typeof a&&(a=Number(a));this.isFolatNumber(a)&&(a=a.toFixed(2),a=Number(a));return a},isFolatNumber:function(a){return"number"!==typeof a?!1:/^\d+(\.\d+)$/.test(a)},statisticExtraStatSource:function(a,b){var c;
if(b){if(0===b.length)c=void 0;else if(1===b.length)c=this._getValueFromFeatureOfExtraStatFeatures(b[0],a);else if(1<b.length){var d={count:0,sum:0},f,e,h,k=0,g=0;b.forEach(function(b){f=this._getValueFromFeatureOfExtraStatFeatures(b,a);switch(a.type){case "count":d.count+=f;break;case "sum":d.sum+=f;break;case "min":d.min="undefined"===typeof d.min?f:Math.min(d.min,f);break;case "max":d.max="undefined"===typeof d.max?f:Math.max(d.max,f);break;case "avg":h=this._getValueFromFeatureOfExtraStatFeatures(b,
{type:"count"}),e=this._getValueFromFeatureOfExtraStatFeatures(b,{field:a.field,type:"sum"}),k+=e,g+=h}}.bind(this));"avg"===a.type&&(d.avg=0===g?0:k/g);c=d[a.type]}return c}},_getValueFromFeatureOfExtraStatFeatures:function(a,b){if(!a||!a.attributes)return"count"===b.type?0:void 0;b="count"===b.type?"STAT_COUNT":e.upperCaseString(b.field+"_"+b.type);a=a.attributes;var c=a[b];"undefined"===typeof c&&(b=e.lowerCaseString(b),c=a[b]);return c},_getCountValueFromFeatureOfExtraStatFeatures:function(a){if(a&&
a.attributes){a=a.attributes;var b,c="STAT_COUNT";b=a[c];"undefined"===typeof b&&(c=e.lowerCaseString(c),b=a[c]);return b||0}},getStatisticResultFromFeatures:function(a,b){if(a){if("count"===b.type)return a.length;var c=b.type;return m.getStatisticsResultFromClientSync({featureSet:{features:a},fieldName:b.field,statisticTypes:[c]})[c+"Field"]}},_getExtalDataSourceType:function(a,b){return this._getExtalDataSourceInfo(a,b).type},_getExtalDataSourceInfo:function(a,b){if(a){b=b||this.appConfig;var c=
a.frameWorkDsId;if("undefined"!==typeof c){var d={};return d=(b=b&&b.dataSource&&b.dataSource.dataSources)?b[c]:l.getInstance().getDataSourceConfig(a.frameWorkDsId)}}}}});