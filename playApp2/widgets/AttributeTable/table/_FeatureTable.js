// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/html dijit/_WidgetBase jimu/dijit/Message jimu/dijit/Filter dgrid/OnDemandGrid ../dgrid/Selection dgrid/extensions/ColumnHider dgrid/extensions/ColumnResizer dgrid/extensions/ColumnReorder dgrid/Keyboard dijit/Menu dijit/MenuItem dijit/Toolbar dijit/form/Button dijit/DropDownMenu dijit/form/ToggleButton dijit/form/DropDownButton dojo/Deferred dojo/when dojo/Evented dojo/touch dojo/store/Memory esri/config esri/lang esri/request esri/tasks/RelationParameters esri/tasks/RelationshipQuery esri/layers/FeatureLayer esri/tasks/QueryTask esri/tasks/query esri/tasks/ProjectParameters esri/geometry/Multipoint esri/geometry/geometryEngine esri/geometry/normalizeUtils esri/IdentityManager dojo/_base/lang dojo/on dojo/aspect dojo/_base/array jimu/dijit/LoadingIndicator jimu/dijit/FieldStatistics jimu/dijit/Popup jimu/dijit/CheckBox jimu/SelectionManager jimu/CSVUtils jimu/utils ../utils dojo/query dojo/string dojo/topic dojo/keys".split(" "),
function(D,h,K,y,L,M,N,O,P,Q,R,S,r,T,B,U,V,W,t,X,Y,Z,u,C,q,aa,E,ba,F,z,w,ca,da,ea,fa,ga,d,n,ha,l,G,ia,ja,ka,la,ma,x,v,A,na,H,I){return D([K,Y],{baseClass:"jimu-widget-attributetable-feature-table",_defaultFeatureCount:2E3,_defaultBatchCount:25,_batchCount:0,_filterObj:null,_currentDef:null,_requestStatus:"initial",parent:null,map:null,matchingMap:!1,layerInfo:null,configedInfo:null,footerHeight:25,layer:null,loading:null,grid:null,footer:null,selectedRowsLabel:null,selectionRows:null,nls:null,_dblClickResult:null,
actived:!1,showSelected:!1,tableCreated:!1,_relatedQuery:!1,_relatedQueryIds:null,_selectionHandles:null,_selectionResults:null,_normalizedExtent:null,constructor:function(a){a=a||{};this.set("parent",a.parent||null);this.set("map",a.map||null);this.set("matchingMap",!!a.matchingMap);this.set("layerInfo",a.layerInfo||null);this.set("layer",a.layer||null);this.set("configedInfo",a.configedInfo||null);this.set("relatedOriginalInfo",a.relatedOriginalInfo||null);this.set("relationship",a.relationship||
null);this.set("syncSelection",!!a.syncSelection||!0)},postCreate:function(){this.inherited(arguments);this._relatedQueryIds=[];this.createToolbar();this.loading=new G;this.loading.placeAt(this.domNode);this.selectionManager=la.getInstance();this._selectionResults=[];this.selectionRows=[];this._normalizedExtent=null;h.setAttr(this.domNode,"data-layerinfoid",d.getObject("layerInfo.id",!1,this));this.get("map")&&(this.own(n(this.map.root,Z.release,d.hitch(this,function(){this._clickMap=!0}))),this.own(n(this.map,
"extent-change",d.hitch(this,"_onExtentChange"))));this.own(n(window,"resize",d.hitch(this,this._resize)))},startup:function(){this.inherited(arguments);this.toolbarHeight=parseInt(h.getStyle(this.toolbar.domNode,"height"),10)||0},setLayerDefinition:function(a){this._layerDefinition=a},getLayerDefinition:function(){return this._getLayerDifinition()},getFilterableFields:function(){if(this._layerDefinition&&this.configedInfo){var a=d.clone(this._layerDefinition);return this._getFilterableFields(a.fields,
this.configedInfo.layer.fields)}return[]},getFilterObj:function(){return this._filterObj},setFilterObj:function(a){this._filterObj=a},showRefreshing:function(a){a?this._toggleLoading(!0):this._toggleLoading(!1)},active:function(){this.actived=!0},deactive:function(){this.actived=!1},cancelThread:function(){"fulfilled"!==this._requestStatus&&this._currentDef&&(this._currentDef.cancel({canceledBySelf:!0}),this._requestStatus="canceled")},isCanceled:function(){return"canceled"===this._requestStatus},
createToolbar:function(){var a=new T({},h.create("div")),b=new U;this.showSelectedRecordsMenuItem=new r({label:this.nls.showSelectedRecords,iconClass:"esriAttributeTableSelectPageImage",onClick:d.hitch(this,this.toggleSelectedRecords)});b.addChild(this.showSelectedRecordsMenuItem);this.showRelatedRecordsMenuItem=new r({label:this.nls.showRelatedRecords,iconClass:"esriAttributeTableSelectAllImage",onClick:d.hitch(this,this.onShowRelatedRecordsClick)});b.addChild(this.showRelatedRecordsMenuItem);this.filterMenuItem=
new r({label:this.nls.filter,iconClass:"esriAttributeTableFilterImage",onClick:d.hitch(this,this.onFilterMenuItemClick)});b.addChild(this.filterMenuItem);this.toggleColumnsMenuItem=new r({label:this.nls.columns,iconClass:"esriAttributeTableColumnsImage",onClick:d.hitch(this,this.onToggleColumnsClick)});b.addChild(this.toggleColumnsMenuItem);this.hideExportButton||(this.exportCSVMenuItem=new r({label:this.nls.exportFiles,showLabel:!0,iconClass:"esriAttributeTableExportImage",onClick:d.hitch(this,this.onExportCSVClick)}),
b.addChild(this.exportCSVMenuItem));this.selectionMenu=new W({label:this.nls.options,iconClass:"esriAttributeTableOptionsImage",dropDown:b});a.addChild(this.selectionMenu);this.matchingCheckBox=new V({checked:this.matchingMap?!0:!1,showLabel:!0,label:this.nls.filterByExtent,onChange:d.hitch(this,function(a){this.set("matchingMap",a);this._onMatchingCheckBoxChange(a)})});a.addChild(this.matchingCheckBox);this.zoomButton=new B({label:this.nls.zoomto,iconClass:"esriAttributeTableZoomImage",onClick:d.hitch(this,
this.zoomTo)});a.addChild(this.zoomButton);this.clearSelectionButton=new B({label:this.nls.clearSelection,iconClass:"esriAttributeTableClearImage",onClick:d.hitch(this,this.clearSelection,!0,!0)});a.addChild(this.clearSelectionButton);this.refreshButton=new B({label:this.nls.refresh,showLabel:!0,iconClass:"esriAttributeTableRefreshImage",onClick:d.hitch(this,this.refresh)});a.addChild(this.refreshButton);h.place(a.domNode,this.domNode);this.toolbar=a;this.own(n(this,"data-loaded,row-click,clear-selection",
d.hitch(this,"changeToolbarStatus")));this.parent&&H.publish(this.parent.id+"_toolbar_created",{toolbar:this.toolbar,context:this})},startQuery:function(a){this.cancelThread();this._requestStatus="processing";this._toggleLoading();a&&a.length?this.queryByStoreObjectIds=a:(this._relatedQuery=!1,this._relatedQueryIds=[],this.queryByStoreObjectIds=null);this._currentDef=this._getLayerObject();this._currentDef.then(d.hitch(this,function(b){this.domNode&&(this.layer=b,(b=!this.layerInfo.isTable&&this.matchingMap&&
this.map.extent||null)&&b.spatialReference&&b.spatialReference.isWebMercator()?(this._currentDef=fa.normalizeCentralMeridian([b],null,d.hitch(this,function(a){return a[0]}))).then(d.hitch(this,function(b){this._doQuery(b,a);this._normalizedExtent=b}),d.hitch(this,function(a){a&&"Request canceled"!==a.message&&console.error(a);this.changeToolbarStatus();this._toggleLoading(!1)})):this._doQuery(b,a))}),d.hitch(this,function(a){console.error(a);this.changeToolbarStatus();this._toggleLoading(!1)}))},
queryRecordsByRelationship:function(a){var b=a&&a.layer,c=a&&a.selectedIds;a&&a.relationship&&this.set("relationship",a.relationship);a&&a.relatedOriginalInfo&&this.set("relatedOriginalInfo",a.relatedOriginalInfo);var e=this.relationship;b&&e&&c&&0<c.length&&!x.isEqual(this._relatedQueryIds,c)&&d.getObject("relatedOriginalInfo.layerObject.url",!1,this)?(this._toggleLoading(!0),this._requestStatus="processing",this._relatedQuery=!0,this.matchingCheckBox.set("checked",!1),this.cancelThread(),this._currentDef=
this._getLayerObject(),this._currentDef.then(d.hitch(this,function(a){if(this.domNode){this.layer=a;var g=[],f=this.layer;l.forEach(f.fields,function(a){q.isDefined(a.show)&&!0!==a.show&&!("esriFieldTypeOID"===a.type||q.isDefined(f.objectIdField)&&a.name===f.objectIdField)||v.arcade.isArcadeExpressionField(a)||g.push(a.name)});a=new ba;a.objectIds=c;a.outFields=g.length?g:["*"];a.relationshipId=e.id;a.returnGeometry="esriGeometryPoint"===this.layer.geometryType;(this._currentDef=b.queryRelatedFeatures(a,
function(a){return a})).then(d.hitch(this,function(a){if(this.domNode){var b={displayFieldName:e.objectIdField,fields:f.fields,features:[],fieldAliases:null},g={},d=function(a){var c=a.attributes[this.layer.objectIdField];g[c]||(g[c]=!0,b.features.push(a))},k;for(k in a){var J=a[k];l.forEach(J&&J.features,d,this)}h.destroy(this.tipNode);0<b.features.length?(this.grid||(this._removeTable(),h.place(this.loading.domNode,this.domNode)),a=this._getOutFieldsFromLayerInfos(this.layer.objectIdField),this.queryExecute(a,
b.features.length,!1,b)):(this.tipNode=h.toDom("\x3cdiv\x3e"+this.nls.noRelatedRecords+"\x3c/div\x3e"),this._removeTable(),h.place(this.tipNode,this.domNode),h.place(this.loading.domNode,this.domNode));this._relatedQueryIds=c;this.emit("data-loaded");this._toggleLoading(!1)}}),d.hitch(this,function(a){a&&"Request canceled"!==a.message&&console.error(a);h.destroy(this.tipNode);this.tipNode=h.toDom("\x3cdiv\x3e"+this.nls.noRelatedRecords+"\x3c/div\x3e");this._removeTable();h.place(this.tipNode,this.domNode);
h.place(this.loading.domNode,this.domNode);this._toggleLoading(!1);this.changeToolbarStatus()}))}}),d.hitch(this,function(a){console.error(a);this._toggleLoading(!1);this.changeToolbarStatus()}))):this._toggleLoading(!1)},getSelectedRows:function(){return this.tableCreated?this.selectionRows:[]},zoomTo:function(){this._zoomToSelected()},toggleSelectedRecords:function(){this._relatedQuery&&!this.showSelected&&0===this.getSelectedRows().length?(this._relatedQuery=!1,this._relatedQueryIds=[],this.layerInfo&&
!this.layerInfo.isTable&&this.matchingCheckBox.set("checked",!0),this.startQuery(),this.showSelectedRecordsMenuItem.set("label",this.nls.showSelectedRecords),this.showSelected=!1,this.emit("show-all-records",{layerInfoId:this.layerInfo.id})):this.tableCreated&&(this.showSelected?(this.showAllSelectedRecords(),this.showSelectedRecordsMenuItem.set("label",this.nls.showSelectedRecords),this.showSelected=!1,this.emit("show-all-records",{layerInfoId:this.layerInfo.id})):(this.showSelectedRecords(),this.showSelectedRecordsMenuItem.set("label",
this.nls.showAllRecords),this.showSelected=!0,this.emit("show-selected-records",{layerInfoId:this.layerInfo.id})))},onShowRelatedRecordsClick:function(){var a=this.getSelectedRows();0<a.length?this.emit("show-related-records",{layerInfoId:this.layerInfo.id,objectIds:a}):this._getFeatureIds(this.layer&&this.layer.objectIdField,this.matchingMap&&this._normalizedExtent).then(d.hitch(this,function(a){console.log(a);this.emit("show-related-records",{layerInfoId:this.layerInfo.id,objectIds:a})}))},onFilterMenuItemClick:function(){this.showRefreshing(!0);
this.getLayerDefinition().then(d.hitch(this,function(a){if(this.domNode){a=d.clone(a);var b=this.getFilterableFields();a.fields=b;var c=new L({noFilterTip:this.nls.noFilterTip,style:"width:100%;",featureLayerId:this.layerInfo.id,runtime:!0}),b=this._getFilterPopupSize();this._filterPopup=new ja({titleLabel:this.nls.filter,width:b.w,height:b.h,content:c,autoHeight:!0,buttons:[{label:this.nls.ok,onClick:d.hitch(this,function(){var a=c.toJson();a&&a.expr?(this.setFilterObj(a),this.clearSelection(!1),
this.startQuery(),this._filterPopup.close(),this._filterPopup=null,this.emit("apply-filter",{layerInfoId:this.layerInfo.id,expr:a.expr})):new y({message:this.nls.setFilterTip})})},{label:this.nls.cancel}]});c.startup();h.addClass(this._filterPopup.domNode,"widget-at-filter-popup");b=this.getFilterObj();c.build({url:this.layer.url,partsObj:b,layerDefinition:this.layer||a,featureLayerId:this.layer.id})}}),d.hitch(this,function(a){this.domNode&&console.error(a)})).always(d.hitch(this,function(){this.showRefreshing(!1)}));
this.emit("show-filter",{layerInfoId:this.layerInfo.id})},_getFilterPopupSize:function(){var a={w:720,h:485};window.appInfo.isRunInMobile&&(a={w:window.innerWidth,h:window.innerHeight});return a},_resize:function(){if(this._filterPopup){var a=this._getFilterPopupSize();this._filterPopup.resize(a)}},onToggleColumnsClick:function(){this.toggleColumns();this.emit("toggle-columns",{layerInfoId:this.layerInfo.id})},onExportCSVClick:function(){var a=this._getRichTextFields(),b=this._getExportCSVPopupMessage(a),
c=new y({"class":this.baseClass+"-popup",message:b,titleLabel:this.nls.exportFiles,autoHeight:!0,buttons:[{label:this.nls.ok,onClick:d.hitch(this,function(){var e=b._check;c.domNode&&(c.domNode.className+=" is-loading",(new G).placeAt(c.domNode));this.exportToCSV(null,"undefined"===typeof e||e.checked?null:a).then(function(){c.close()},function(a){console.error("Error exporting CSV for Attribute Table");c.close()})})},{label:this.nls.cancel}]});this.emit("export-csv",{layerInfoId:this.layerInfo.id})},
_getExportCSVPopupMessage:function(a){var b=document.createElement("div");b.className="message-wrapper";b.appendChild(document.createTextNode(this.nls.exportMessage));if(a.length){var c=document.createElement("div");c.className="input-row";var e=new ka({label:this.nls.keepRichTextLabel,checked:!0}),f=document.createElement("a");f.className="hint-button";f.href="#";f.role="button";f.appendChild(document.createTextNode(this.nls.whatsThis));c.appendChild(e.domNode);c.appendChild(f);b.appendChild(c);
b._check=e;this.own(n(f,"click",d.hitch(this,function(b){b.preventDefault();b={"class":this.baseClass+"-popup",message:this._getRichTextMessage(a)};window.appInfo.isRunInMobile||(b.width=500);new y(b)})))}return b},_getRichTextMessage:function(a){if(!a||a.hasOwnProperty("length")&&!a.length)return"";for(var b=document.createElement("div"),c="",e=0,d=a.length;e<d;e++)c+="\x3cmark\x3e"+a[e].fieldName+"\x3c/mark\x3e";a=""+("\x3cp\x3e"+na.substitute(this.nls.richTextMessage.explanatoryText.line1,{layerName:"\x3cstrong\x3e"+
this.layer.name+"\x3c/strong\x3e"})+"\x3c/p\x3e");a=a+('\x3cdiv class\x3d"tags"\x3e'+c+"\x3c/div\x3e")+("\x3cp\x3e"+this.nls.richTextMessage.explanatoryText.line2+"\x3c/p\x3e\x3cp\x3e"+this.nls.richTextMessage.explanatoryText.line3+"\x3c/p\x3e\x3ch3\x3e"+this.nls.richTextMessage.example.label+'\x3c/h3\x3e\x3cdiv class\x3d"example-block"\x3e\x3cpre\x3e\x3cfont color\x3d"#31aacd"\x3eWeb AppBuilder\x3c/font\x3e for \x3cu\x3eArcGIS\x3c/u\x3e\x3c/pre\x3e'+this.nls.richTextMessage.example.scenarios.first+
'\x3cpre\x3e\x26ltfont color\x3d"#31aacd"\x26gtWeb AppBuilder\x26lt/font\x26gt for \x26ltu\x26gtArcGIS\x26lt/u\x26gt\x3c/pre\x3e'+this.nls.richTextMessage.example.scenarios.second+"\x3cpre\x3eWeb AppBuilder for ArcGIS\x3c/pre\x3e\x3c/div\x3e");b.innerHTML=a;return b},_getRichTextFields:function(){var a=this.layerInfo&&this.layerInfo.getPopupInfo&&this.layerInfo.getPopupInfo(),a=a&&a.fieldInfos,b=[];if(a)for(var c=0,e=a.length;c<e;c++){var d=a[c];d.stringFieldOption&&"richtext"===d.stringFieldOption&&
b.push(d)}return b},onSelectionComplete:function(){var a=this.layer&&this.layer.getSelectedFeatures();a&&(0===a.length?this.clearSelection(!1,0<this._selectionResults.length):this._selectBySelf(a)||(this.clearSelection(!1),this._updateSelectRowsByFeatures(a)))},onSelectionClear:function(){this.clearSelection(!1,!0)},changeToolbarStatus:function(){if(this.tableCreated){var a=this.getSelectedRows();this.showSelected?this.showSelectedRecordsMenuItem.set("label",this.nls.showAllRecords):this.showSelectedRecordsMenuItem.set("label",
this.nls.showSelectedRecords);this.tableCreated&&a&&0<a.length&&this.layer&&this.layer.objectIdField?(this.showSelectedRecordsMenuItem.set("disabled",!1),this.clearSelectionButton.set("disabled",!1)):(this.showSelectedRecordsMenuItem.set("disabled",!0),this.clearSelectionButton.set("disabled",!0));this._relatedQuery&&(this.showSelectedRecordsMenuItem.set("disabled",!1),this.tableCreated&&a&&0===a.length&&this.showSelectedRecordsMenuItem.set("label",this.nls.showAllRecords));this.showRelatedRecordsMenuItem.set("disabled",
!0);if(this.layerInfo&&this.isSupportQueryToServer()&&this.layer&&this.layer.objectIdField){this._relatedDef&&!this._relatedDef.isFulfilled()&&this._relatedDef.cancel();var b=this.layerInfo.getRelatedTableInfoArray();this._relatedDef=b;b.then(d.hitch(this,function(a){this.domNode&&this.tableCreated&&a&&0<a.length&&this.showRelatedRecordsMenuItem.set("disabled",!1)}))}this.tableCreated&&this.isSupportQueryToServer()&&!this._relatedQuery?this.filterMenuItem.set("disabled",!1):this.filterMenuItem.set("disabled",
!0);this.matchingCheckBox.set("disabled",!1);this.tableCreated?this.toggleColumnsMenuItem.set("disabled",!1):this.toggleColumnsMenuItem.set("disabled",!0);this.hideExportButton||(a&&0<a.length?this.exportCSVMenuItem.set("label",this.nls.exportSelected):this.exportCSVMenuItem.set("label",this.nls.exportAll),this.tableCreated?this.exportCSVMenuItem.set("disabled",!1):this.exportCSVMenuItem.set("disabled",!0));this.layerInfo.isShowInMap()?this.tableCreated&&a&&0<a.length?this.zoomButton.set("disabled",
!1):this.zoomButton.set("disabled",!0):this.zoomButton.set("disabled",!0);this.layerInfo.isTable&&(this.matchingCheckBox.set("disabled",!0),this.zoomButton.set("disabled",!0))}else this._relatedQuery?(this.showSelectedRecordsMenuItem.set("disabled",!1),this.showSelectedRecordsMenuItem.set("label",this.nls.showAllRecords)):this.showSelectedRecordsMenuItem.set("disabled",!0),this.showRelatedRecordsMenuItem.set("disabled",!0),this.matchingCheckBox.set("disabled",!0),this.filterMenuItem.set("disabled",
!0),this.toggleColumnsMenuItem.set("disabled",!0),this.hideExportButton||this.exportCSVMenuItem.set("disabled",!0),this.zoomButton.set("disabled",!0)},showSelectedRecords:function(){if(this.tableCreated){var a=this.layer.objectIdField,b=this.getSelectedRows();0<b.length&&this.grid&&(this.grid.store instanceof u?this.grid.set("query",d.hitch(this,function(c){return"number"===typeof c&&-1<b.indexOf(c)||-1<b.indexOf(c[a])?!0:!1})):this.grid.set("query",function(){return b}))}},showAllSelectedRecords:function(){if(this.tableCreated&&
this.showSelected){this.grid.set("query",{});var a=this.getSelectedRows();this._updateSelectRowsByIds(a)}},clearSelection:function(a,b){this.tableCreated&&(this.grid.clearSelection(),this.selectionRows=[],a&&this.grid.set("query",{}),b&&(this._selectionResults=[],this.layer&&0<this.layer.getSelectedFeatures().length&&this.selectionManager.clearSelection(this.layer)),this._closePopup(),this.setSelectedNumber(),this.showSelected=!1,this.emit("clear-selection"))},refresh:function(){this.grid&&this.grid.clearSelection();
this._relatedQuery||this.startQuery();this.emit("refresh",{layerInfoId:this.layerInfo.id})},exportToCSV:function(a,b){if(!this.layerInfo||!this.layer||!this.tableCreated){var c=new t;c.reject();return c}return this.getSelectedRowsData().then(d.hitch(this,function(c){var e=this.layer.objectIdField,g=[],k=this.layer.fullExtent.spatialReference.equals(this.map.extent.spatialReference),h=this._hasArcadeExpressionFields(),p=v.getSortbyFields(this.grid,this.layer);if(k){var m=l.map(this._getTableSelectedIds(),
d.hitch(this,function(a){for(var b=0,d=c.length;b<d;b++)if(c[b]&&c[b][e]===a)return c[b];return{}}))||[];0===m.length&&this.isSelectionMode()&&m.push({});g=m;0===m.length&&this.grid.store instanceof u&&(g={},p&&p instanceof Array&&(g.sort=l.map(p,function(a){a=a.split(/\ +/);return{attribute:a[0],descending:"DESC"===a[1]}})),g=d.clone(this.grid.store.query({},g)));g.length&&this._appendXY(g)}var m={},n=this.getOutFields(!!g.length);m.datas=g;m.fromClient=!1;m.withGeometry="esriGeometryPoint"===this.layer.geometryType;
m.outFields=n;m.formatNumber=!1;m.formatDate=!0;m.formatCodedValue=!0;m.popupInfo=this.layerInfo.getPopupInfo();m.objectIds=!k&&this._getExportObjectIds();m.outSpatialReference=!k&&d.clone(this.layer.fullExtent.spatialReference);m.richTextFieldsToClear=b;h&&(m.arcadeExpressions={expressionInfos:this.layerInfo.getPopupInfo().expressionInfos,layerDefinition:x.getFeatureLayerDefinition(this.layer)});m.orderByFields=p;if(!m.objectIds||m.objectIds instanceof Array&&0===m.objectIds.length)this.matchingMap&&
this.layerInfo&&!this.layerInfo.isTable&&(m.geometry=this._currentExtent),m.start=0,m.num=this.layer.maxRecordCount||1E3;return ma.exportCSVFromFeatureLayer(a||this.configedInfo.name,this.layer,m)}))},toggleColumns:function(){this.tableCreated&&this.grid._toggleColumnHiderMenu()},changeHeight:function(a){this.grid&&0<=a-this.toolbarHeight-this.footerHeight&&h.setStyle(this.grid.domNode,"height",a-this.toolbarHeight-this.footerHeight+"px")},isSupportQueryToServer:function(){var a=this.layer&&"esri.layers.CSVLayer"===
this.layer.declaredClass,b=this.layer&&"esri.layers.StreamLayer"===this.layer.declaredClass;return this.layer&&this.layer.url&&this.configedInfo.layer.url&&!a&&!b},isSupportQueryOnClient:function(){var a=this.layer&&"esri.layers.CSVLayer"===this.layer.declaredClass,b=this.layer&&"esri.layers.StreamLayer"===this.layer.declaredClass;return!(this.layer&&this.layer.url&&this.configedInfo.layer.url)||a||b},destroy:function(){this._destroyed||(this.layer=this.configedInfo=this.layerInfo=null,this._selectionHandles&&
l.forEach(this._selectionHandles,function(a){a&&a.remove&&a.remove()}),this._closePopup(),this._filterPopup&&this._filterPopup.domNode&&(this._filterPopup.close(),this._filterPopup=null),this._dblClickResult=null,this.grid&&this.grid.destroy(),this.relationship=this.nls=this.map=null,this._currentDef&&!this._currentDef.isFulfilled()&&this._currentDef.cancel({canceledBySelf:!0}),this._relatedDef&&!this._relatedDef.isFulfilled()&&this._relatedDef.cancel({canceledBySelf:!0}),this.inherited(arguments))},
_selectBySelf:function(a){a=a||[];if(a.length!==this._selectionResults.length)return!1;var b=this.layer.objectIdField;return l.every(this._selectionResults,function(c){return a.some(function(a){return c.attributes[b]===a.attributes[b]})})},_updateSelectRowsByFeatures:function(a){var b=l.map(a,d.hitch(this,function(a){return a.attributes[this.layer.objectIdField]}));this._updateSelectRowsByIds(b);this._selectionResults=a},_updateSelectRowsByIds:function(a){this.grid&&this.tableCreated&&(this.selectionRows=
a,l.forEach(a,d.hitch(this,function(a){this.grid.select(a)})),this.setSelectedNumber(),this.changeToolbarStatus())},_removeTable:function(){this.grid&&this.grid.domNode&&(this.grid.destroy(),this.grid=null);this.footer&&(h.destroy(this.footer),this.selectedRowsLabel=this.footer=null);this.tableCreated=!1},_onMatchingCheckBoxChange:function(a){this.tableCreated&&!this._relatedQuery&&(this.cancelThread(),this.queryByStoreObjectIds=null,this.startQuery());if("fulfilled"===this._requestStatus&&this.tableCreated&&
this._relatedQuery)if(a)this.queryByStoreObjectIds=l.map(this.grid.store.data,d.hitch(this,function(a){return a[this.layer.objectIdField]})),this.startQuery(this.queryByStoreObjectIds);else{var b=this._relatedQueryIds;this._relatedQueryIds=[];this.queryRecordsByRelationship({layer:this.relatedOriginalInfo.layerObject,selectedIds:b})}a||(this._currentExtent=null)},_closePopup:function(){var a=this.map.infoWindow.getSelectedFeature(),b=a&&this._dblClickResult&&a===this._dblClickResult,a=a&&a._layer===
this.layer;this.domNode&&(b||a)&&(this.map.infoWindow.hide(),this._dblClickResult=null)},_getLayerObject:function(){function a(a){this._selectionHandles&&l.forEach(this._selectionHandles,function(a){a&&a.remove&&a.remove()});this._selectionHandles=[];this._selectionHandles.push(n(a,"selection-complete",d.hitch(this,"onSelectionComplete")));this._selectionHandles.push(n(a,"selection-clear",d.hitch(this,"onSelectionClear")))}return(this._currentDef=this.layerInfo.getLayerObject()).then(d.hitch(this,
function(b){var c=new t;"esri.layers.ArcGISImageServiceLayer"===b.declaredClass||"esri.layers.ArcGISImageServiceVectorLayer"===b.declaredClass?(b=new F(b.url),this.own(n(b,"load",d.hitch(this,function(b){d.hitch(this,a)(b.layer);c.resolve(b.layer)})))):(d.hitch(this,a)(b),c.resolve(b));return c}))},_getLayerDifinition:function(){return this._layerDefinition?X(d.clone(this._layerDefinition)):aa({url:this.layer.url,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(d.hitch(this,
function(a){this.setLayerDefinition(a);return this.getLayerDefinition()}))},_getFilterableFields:function(a,b){return l.filter(a,function(a){return l.some(b,function(b){return a.name===b.name&&(b.show||!q.isDefined(b.show))&&d.mixin(a,b)})})},_getExportObjectIds:function(){var a=this._getTableSelectedIds()||[];if(0===a.length&&this.grid.store instanceof u){var b=this.layer.objectIdField;this.grid.store.query(function(c){a.push(c[b])})}return a},_doQuery:function(a,b){if(this.layer){var c=this.layer.objectIdField;
this.isSupportQueryToServer()?this._queryToServer(a,c,b):this.isSupportQueryOnClient()&&this._queryOnClient(a,c,b)}},_queryOnClient:function(a,b,c){var e={};e.features="esri.layers.StreamLayer"===this.layer.declaredClass?this.layer.getLatestObservations():l.filter(this.layer.graphics,d.hitch(this,function(a){return!a.wabIsTemp}));c&&0<c.length&&(e.features=l.filter(e.features,function(a){return-1<c.indexOf(a.attributes[this.layer.objectIdField])},this));var f=this.layer.fields,g=this.configedInfo.layer.fields;
e.fields=g?l.filter(g,d.hitch(this,function(a){q.isDefined(a.show)||(a.show=!0);a.name!==b||"esriFieldTypeOID"!==a.type&&"esriFieldTypeInteger"!==a.type||(a._pk=!0);for(var c=0,e=f.length;c<e;c++)f[c].name!==a.name||a.type||(a.type=f[c].type);return a.show||a._pk})):l.filter(f,d.hitch(this,function(a){q.isDefined(a.show)||(a.show=!0);a.name!==b||"esriFieldTypeOID"!==a.type&&"esriFieldTypeInteger"!==a.type||(a._pk=!0);return a.show||a._pk}));for(var g=[],k=e.features.length,h=0;h<k;h++)e&&e.features&&
e.features[h]&&e.features[h].geometry&&g.push(e.features[h].geometry);a&&C.defaults.geometryService&&0<g.length?a.spatialReference.equals(g[0].spatialReference)?(e.features=l.filter(e.features,d.hitch(this,function(b){if(b&&b.geometry)return ea.intersects(a,b.geometry)})),this.queryExecute(e.fields,e.features.length,!1,e,a)):(k=new E,k.geometries1=g,k.geometries2=[a],k.relation=E.SPATIAL_REL_INTERSECTION,(this._currentDef=C.defaults.geometryService.relation(k,d.hitch(this,function(a){return a}))).then(d.hitch(this,
function(b,c){for(var e=c.length,d=[],g=0;g<e;g++)d.push(b.features[c[g].geometry1Index]);b.features=d;this.queryExecute(b.fields,b.features.length,!1,b,a)},e),d.hitch(this,function(a){a&&"Request canceled"!==a.message&&console.error(a);this.changeToolbarStatus();this._toggleLoading(!1)}))):this.queryExecute(e.fields,e.features.length,!1,e,a)},_queryToServer:function(a,b,c){this._getFeatureCount(a,c).then(d.hitch(this,function(e){if(this.domNode)if(c)this._queryFeatureLayer(a,b,e,!1,c);else{var f=
this.layer,g=q.isDefined(f.maxRecordCount)?f.maxRecordCount:1E3;this._batchCount=Math.min(g,this._defaultBatchCount);if(e<=g||!this.layer.objectIdField)this._queryFeatureLayer(a,b,e,!1);else{var k=this._getOutFieldsFromLayerInfos(b),h={fields:this.layer.fields};this.layer._recordCounts=e;f.advancedQueryCapabilities&&f.advancedQueryCapabilities.supportsPagination?this.queryExecute(k,e,!0,h,a):this._getFeatureIds(b,a).then(d.hitch(this,function(b){this.domNode&&(this.layer._objectIds=b,this.queryExecute(k,
e,!0,h,a))}),d.hitch(this,function(a){console.error(a);this.changeToolbarStatus()}))}}}),d.hitch(this,function(a){console.error(a);this.changeToolbarStatus()}))},_getFeatureCount:function(a,b){var c=new t,e=new z(this.configedInfo.layer.url),f=new w;f.returnGeometry=!1;f.where=this._getLayerFilterExpression();b&&(f.where+=" AND "+this.layer.objectIdField+" IN ("+b.join()+")");a&&(f.geometry=a);(this._currentDef=e.executeForCount(f,d.hitch(this,function(a){return a}))).then(d.hitch(this,function(a){c.resolve(a)}),
d.hitch(this,function(a){a&&"Request canceled"!==a.message&&(console.error(a),console.log("Could not get feature count."));this._toggleLoading(!1);c.reject(a)}));return c},_queryFeatureLayer:function(a,b,c,e,f){var g=new z(this.configedInfo.layer.url),k=new w;k.where=this._getLayerFilterExpression();f&&b&&(k.where+=" AND "+b+" IN ("+f.join()+")");var h=this._getOutFieldsFromLayerInfos(b),p=(f=this._hasArcadeExpressionFields())&&this._hasArcadeExpressionWithGeometry();if(0<h.length&&!f){var m=[];l.forEach(h,
function(a){m.push(a.name)});k.outFields=m}else k.outFields=["*"];a&&(k.geometry=a,k.spatialRelationship=w.SPATIAL_REL_INTERSECTS);k.outSpatialReference=d.clone(this.map.spatialReference);k.returnGeometry="esriGeometryPoint"===this.layer.geometryType||p;b&&(k.orderByFields=[b+" ASC"]);(this._currentDef=g.execute(k,d.hitch(this,function(a){return a}))).then(d.hitch(this,function(b){this.queryExecute(h,c,e,b,a)}),d.hitch(this,function(a){a&&"Request canceled"!==a.message&&console.error(a);this.changeToolbarStatus();
this._toggleLoading(!1)}))},_getFeatureIds:function(a,b){var c=new t,e=new z(this.configedInfo.layer.url),f=new w;f.returnGeometry=!1;f.returnIdsOnly=!0;f.where=this._getLayerFilterExpression();if(this.layer._orderByFields||a)f.orderByFields=this.layer._orderByFields||[a+" ASC"];b&&(f.geometry=b);(this._currentDef=e.executeForIds(f,d.hitch(this,function(a){return a}))).then(d.hitch(this,function(a){c.resolve(a)}),d.hitch(this,function(a){a&&"Request canceled"!==a.message&&(console.error(a),console.log("Could not get feature Ids"));
c.resolve([])}));return c},queryExecute:function(a,b,c,e,f){var g=[],g=null,k={};if(this.domNode){e.fields=this._processExecuteFields(this.layer.fields,a);c?g=v.generateCacheStore(this.layer,b,this._batchCount,this._getLayerFilterExpression(),f):(g=l.map(e.features,d.hitch(this,function(a){var b=d.clone(a.attributes);return d.mixin(b,{geometry:a.geometry})})),g=v.generateMemoryStore(g,this.layer.objectIdField));a=this.layer.typeIdField;var k=this.layer.types,n=d.getObject("advancedQueryCapabilities.supportsOrderBy",
!1,this.layer),p=d.getObject("advancedQueryCapabilities.supportsPagination",!1,this.layer),m=d.getObject("advancedQueryCapabilities.supportsStatistics",!1,this.layer),k=v.generateColumnsFromFields(this.grid&&this.grid.columns,this.layerInfo,e.fields,a,k,n&&p||!c,m,this.layer);this.layer.hasAttachments&&this.layer.objectIdField&&this.configedInfo.showAttachments&&(k.attachmentsColumn=this.formatAttachmentsColumn());c=20+100*e.fields.length<h.getMarginBox(this.domNode).w;this.createTable(k,g,b,c);this._currentExtent=
f;b=this.layer.getSelectedFeatures();this.selectionRows&&0<this.selectionRows.length?this._updateSelectRowsByIds(this.selectionRows):b&&0<b.length?this._updateSelectRowsByFeatures(b):this.grid.clearSelection();this.changeToolbarStatus();this.emit("data-loaded")}},formatAttachmentsColumn:function(){var a={label:this.nls.attachments,className:"attachments-column",hidden:!1,unhidable:!0,field:"at-show-attachments",sortable:!1,_cache:{sortable:!1,statistics:!1}};a.renderCell=d.hitch(this,function(a,c,
e){var b=a[this.layer.objectIdField];this.layer.queryAttachmentInfos(b,d.hitch(this,function(a){var c=l.map(a,d.hitch(this,function(a){var c=a.name&&/\.(png|jpg|jpeg|gif)$/gi.test(a.name)?"image-type":"file-type",e=ga.findCredential(this.layer.url);return'\x3cli class\x3d"'+c+'"\x3e\x3ca class\x3d"jimu-ellipsis" target\x3d"_blank" href\x3d"'+(this.layer.url+"/"+b+"/attachments/"+a.id+(e?"?token\x3d"+e.token:""))+'"\x3e'+a.name+"\x3c/a\x3e\x3c/li\x3e"})),f="";0<a.length&&(f=" "+this.nls.files);f='\x3cdiv class\x3d"attachment-infos"\x3e\x3cdiv class\x3d"show-attachments-div"\x3e\x3cspan class\x3d"show-attachments"\x3e'+
a.length+f+'\x3c/span\x3e\x3c/div\x3e\x3cdiv class\x3d"attachment-popup"\x3e\x3cdiv class\x3d"attachment-popup-header"\x3e\x3cspan\x3e'+c.length+"\x26nbsp;"+this.nls.files+'\x3c/span\x3e\x3cspan class\x3d"close jimu-float-trailing"\x3e\x3c/span\x3e\x3c/div\x3e\x3cul class\x3d"attachment-popup-content"\x3e'+c.join("")+"\x3c/ul\x3e\x3c/div\x3e\x3c/div\x3e";f=h.toDom(f);0<a.length&&(a=A(".show-attachments-div",f)[0],h.addClass(a,"has-attachments"));e.appendChild(f);this.own(n(e,"click",d.hitch(this,
function(a){a=a&&a.target;if(h.hasClass(a,"show-attachments-div")||h.hasClass(a,"show-attachments")||h.hasClass(a,"close")){a=this._visibleAttachmentPopup;var b=A(".attachment-popup",e)[0];b&&0<c.length&&h.toggleClass(b,"show");h.hasClass(b,"show")?this._visibleAttachmentPopup=b:this._visibleAttachmentPopup=null;a&&a!==b&&h.toggleClass(a,"show")}})))}),d.hitch(this,function(a){console.error(a)}))});return a},createTable:function(a,b,c,e){if(this.grid)this.grid.set("store",b),this.grid.set("columns",
a),this.grid.refresh();else{var f={};f.columns=a;f.store=b;f.keepScrollPosition=!0;f.pagingDelay=1E3;f.allowTextSelection=this.allowTextSelection;f.deselectOnRefresh=!1;this.layer.objectIdField||(f.minRowsPerPage=this.layer.maxRecordCount||1E3,f.maxRowsPerPage=this.layer.maxRecordCount||1E3,f.selectionMode="none");this.grid=new (D([M,N,O,P,Q,R]))(f,h.create("div"));h.place(this.grid.domNode,this.domNode);this.grid.startup();this.tipNode&&h.destroy(this.tipNode);this.own(n(this.ownerDocument,"keydown",
d.hitch(this,function(a){this.allowTextSelection&&this.grid&&this.grid.allowTextSelection&&a.shiftKey&&this.grid._setAllowTextSelection(!1)})));this.own(n(this.ownerDocument,"keyup",d.hitch(this,function(){this.allowTextSelection&&this.grid&&!this.grid.allowTextSelection&&this.grid._setAllowTextSelection(!0)})));this.layer.objectIdField&&(this.own(n(this.grid,".dgrid-header .dgrid-cell:click",d.hitch(this,this._onHeaderClick))),this.own(n(this.grid,"dgrid-columnstatechange",d.hitch(this,this._onColumnStateChange))),
this.own(n(this.grid,".selection-handle-column:click",d.hitch(this,this._onSelectionHandleClick)),n(this.grid,".selection-handle-column:keydown",d.hitch(this,function(a){a.keyCode!==I.ENTER&&a.keyCode!==I.SPACE||this._onSelectionHandleClick()}))),this.own(n(this.grid,".dgrid-row:dblclick",d.hitch(this,this._onDblclickRow)),n(this.grid,"dgrid-sort",d.hitch(this,function(a){this.emit("sort",a)})),n(this.grid,"dgrid-refresh-complete",d.hitch(this,function(a){this.parent&&H.publish(this.parent.id+"_table_created",
{grid:a.grid,context:this})}))),a=this.map.getLayer(this.layer.id),this.syncSelection&&a&&this.own(n(a,"click",d.hitch(this,this._onFeaturelayerClick))))}this.grid.get("sort")[0]||(this.configedInfo&&this.configedInfo.sortField?this.grid.set("sort",this.configedInfo.sortField,this.configedInfo.isDescending):this.layer.objectIdField&&this.grid.set("sort",this.layer.objectIdField,!1));this.getParent()&&(a=A(".dgrid-scroller",this.grid.domNode)[0],f=A(".dgrid-header",this.grid.domNode)[0],b=h.getComputedStyle(a),
f=h.getMarginBox(f),b=parseInt(b.marginTop,10),isFinite(b)&&f&&b<f.h&&h.setStyle(a,"marginTop",f.h+"px"));e?h.addClass(this.domNode,"auto-width"):h.removeClass(this.domNode,"auto-width");this.footer?h.empty(this.footer):this.footer=h.create("div",{id:this.parent.id+"_"+this.id+"_footer","class":this.parent.baseClass+"-feature-table-footer",tabindex:"-1"},this.domNode);c=h.create("div",{"class":"dgrid-status self-footer",innerHTML:c+"\x26nbsp;"+(this.layerInfo.isTable?this.nls.records:this.nls.features)+
"\x26nbsp;"},this.footer);this.selectedRowsLabel=h.create("div",{"class":"dgrid-status self-footer",innerHTML:"0\x26nbsp;"+this.nls.selected+"\x26nbsp;",style:{display:this.layer.objectIdField?"":"none"}},c,"after");c=h.getStyle(this.domNode,"height");this.changeHeight(c);this._requestStatus="fulfilled";this.tableCreated=!0;h.place(this.loading.domNode,this.grid.domNode);this._toggleLoading(!1)},getSelectedRowsData:function(){var a=new t,b=this._getTableSelectedIds()||[];if(!this.grid||!b.length)return a.resolve(null),
a;this.grid.store instanceof u?(b=d.clone(this.grid.store.data),a.resolve(b)):this.grid.store.query(b,{_export_count:b.length}).then(d.hitch(this,function(b){b=b&&d.clone(this.grid.store._entityData||this.grid.store.data);a.resolve(b)}));return a},_appendXY:function(a){a&&"esriGeometryPoint"===this.layer.geometryType&&l.forEach(a,function(a){var b=a.geometry;b&&"point"===b.type&&("x"in a?a._x=b.x:a.x=b.x,"y"in a?a._y=b.y:a.y=b.y);delete a.geometry})},getOutFields:function(a){var b=null,b=this._getOutFieldsFromLayerInfos(this.layer.objectIdField),
b=this._processExecuteFields(this.layer.fields,b),b=d.clone(b);a&&(a="",a=-1!==b.indexOf("x")?"_x":"x",b.push({name:a,alias:a,format:{digitSeparator:!1,places:6},show:!0,type:"esriFieldTypeDouble"}),a=-1!==b.indexOf("y")?"_y":"y",b.push({name:a,alias:a,format:{digitSeparator:!1,places:6},show:!0,type:"esriFieldTypeDouble"}));return b},setSelectedNumber:function(){if(this.selectedRowsLabel&&this.grid){var a=this.getSelectedRows(),b=0;if(this.grid.store instanceof u){var c=l.map(this.grid.store.data,
function(a){return a[this.layer.objectIdField]},this);l.forEach(a,function(a){-1<c.indexOf(a)&&b++})}else b=a.length;this.selectedRowsLabel.innerHTML="\x26nbsp;\x26nbsp;"+b+" "+this.nls.selected+"\x26nbsp;\x26nbsp;"}},_setSelection:function(a){this._selectionResults=a=a||[];this.selectionManager.setSelection(this.layer,a)},_zoomToExtentByFeatures:function(a){return this.getExtent(a).then(d.hitch(this,function(a){if(a&&this.domNode){var b=null;if("point"===a.type){var e=this.map.getNumLevels(),d=this.map.getLevel(),
b=this.map.getMaxZoom();0<e?(d===b?e=d:(e=d+4,e>b&&(e=b)),b=this.map.centerAndZoom(a,e)):b=this.map.centerAndZoom(a,1/Math.pow(2,4)*2)}else b=this.map.setExtent(a.expand(2));return b.then(function(){return a})}}))},_showMapInfoWindowByFeatures:function(a,b){if(b&&0!==b.length&&this.domNode){var c=this.map.infoWindow,e=this.layerInfo.isPopupEnabled()&&this.layerInfo.getInfoTemplate();if(c&&c.setFeatures&&1===b.length&&e){l.forEach(b,d.hitch(this,function(a){a._layer=this.layerInfo.layerObject;a.setInfoTemplate(e)}));
c.setFeatures(b);var f=null,f="point"===a.type?b[0].geometry:a.getCenter();c.show(f,{closetFirst:!0});this._dblClickResult=b[0];this.syncWithMapInfowindow(this._dblClickResult)}}},selectFeatures:function(a,b){if(b&&0<b.length){if("rowclick"===a||"selectall"===a)this._setSelection(b);else if("zoom"===a||"row-dblclick"===a){var c=x.graphicsExtent(b),e=x.toFeatureSet(b),f=n(this.map,"zoom-end, pan-end",d.hitch(this,function(){f.remove();"row-dblclick"===a&&this.domNode&&this._showMapInfoWindowByFeatures(c,
b)}));x.zoomToFeatureSet(this.map,e).then(null,function(a){a&&(console.error(a.message),f&&f.remove())})}this.setSelectedNumber()}else this._popupMessage(this.nls.dataNotAvailable)},syncWithMapInfowindow:function(a){var b=this.map.infoWindow,c=d.isArray(a)?a:[a];n.once(b,"hide",d.hitch(this,function(){e&&e.remove&&(e.remove(),e=null)}));var e=ha.after(b,"show",d.hitch(this,function(){var a=b.getSelectedFeature(),a=a&&c[0]===a,d=-1;b.features&&(d=b.features.indexOf(c[0]));!a&&-1<d?b.select(d):this.domNode&&
!a&&e&&e.remove&&(e.remove(),e=null)}))},getGraphicsFromLocalFeatureLayer:function(a){for(var b=[],c,d,f=a.length,g=this.layer.graphics.length,h=this.layer.objectIdField,l=0;l<f;l++)for(var p=0;p<g;p++)if(c=this.layer.graphics[p].attributes[h]+"",d=a[l]+"",c===d){b.push(this.layer.graphics[p]);break}return b},getExtent:function(a){var b=new t,c,e,f=a.length;if(1===f&&a[0].geometry&&"point"===a[0].geometry.type)c=a[0].geometry;else if(1!==f||a[0].geometry)for(var g=0;g<f;g++)a[g].geometry?"point"===
a[g].geometry.type?(e||(e=new da(a[g].geometry.spatialReference)),e.addPoint(a[g].geometry),g===f-1&&(c=e.getExtent())):c=c?c.union(a[g].geometry.getExtent()):a[g].geometry.getExtent():console.error("unable to get geometry of the reocord: ",a[g]);else return b.reject(Error("AttributeTable.getExtent:: extent was not projected.")),b;if(!c||!c.spatialReference)return b.reject(Error("AttributeTable.getExtent:: extent was not projected.")),b;a=this.map.spatialReference;c.spatialReference.equals(a)?b.resolve(c):
(e=new ca,e.geometries=[c],e.outSR=a,C.defaults.geometryService.project(e,d.hitch(this,function(a){this.domNode&&(a&&a.length?b.resolve(a[0]):b.reject(Error("AttributeTable.getExtent:: extent was not projected.")))}),d.hitch(this,function(a){a||(a=Error("AttributeTable.getExtent:: extent was not projected."));b.reject(a)})));return b},_onFeaturelayerClick:function(a,b){if(this.actived){var c=d.getObject("graphic",!1,a),e=d.getObject("graphic.attributes",!1,a);e&&c&&c._layer===this.layer&&((c=this.map.infoWindow.getSelectedFeature())&&
c._layer===this.layer&&!b&&this.map.infoWindow.hide(),b=e[this.layer.objectIdField],this.showSelected&&this.toggleSelectedRecords(),this._getIndexOfIdInGrid(b).then(d.hitch(this,function(b){-1!==b&&(this.grid.scrollTo({x:0,y:this.grid.rowHeight*b}),this.map.infoWindow.features&&(b=this.map.infoWindow.features.indexOf(a.graphic),this.map.infoWindow.select(b)),n.once(this.map.infoWindow,"selection-change",d.hitch(this,function(){var b=this.map.infoWindow.getSelectedFeature(),c=d.getObject("_layer",
!1,b);b!==a.graphic&&c===this.layer&&this._onFeaturelayerClick({graphic:b},!0)})),this.syncWithMapInfowindow(a.graphic))})))}},_getIndexOfIdInGrid:function(a){var b=new t,c=-1,e=d.getObject("store.objectIds",!1,this.grid),c=null,c=this.grid.get("sort")[0];if(this._relatedQuery)return b.resolve(-1),b;if(this.grid.store instanceof u)a=this.grid.store.get(a),e=this.grid.store.data,a?c&&c.attribute&&q.isDefined(c.descending)?(e=d.clone(e),c=function(a,b){return function(c,d){return c[a]===d[a]?0:c[a]<
d[a]?b?1:-1:b?-1:1}}(c.attribute,c.descending),e.sort(c),e=l.map(e,function(a){return a[this.layer.objectIdField]},this),c=e.indexOf(a[this.layer.objectIdField])):c=e.indexOf(a):c=-1,b.resolve(c);else if(e&&0<e.length)c=e.indexOf(a),b.resolve(c);else{e=new w;e.returnGeometry=!1;e.where=this._getLayerFilterExpression()+" AND "+this.layer.objectIdField+" \x3c "+a;if(c&&(c.attribute!==this.layer.objectIdField||c.descending))return b.resolve(-1),b;this.matchingMap&&!this._relatedQuery&&this._currentExtent&&
(e.geometry=this._currentExtent);(this._currentDef=this.layer.queryCount(e)).then(d.hitch(this,function(a){b.resolve(a)}),d.hitch(this,function(a){b.reject(a)}))}return b},_zoomToSelected:function(){if(this.configedInfo&&this.tableCreated){var a=this.getSelectedRows();this._goToFeatures(a,"zoom")}},_goToFeatures:function(a,b){if(0!==a.length){var c=this.getGraphicsFromLocalFeatureLayer(a);this.isSupportQueryToServer()&&a.length!==c.length?this._queryFeaturesByIds(a,b):this.selectFeatures(b,c)}},_onDblclickRow:function(a){this.layerInfo&&
this.layerInfo.isShowInMap()&&(a=[this.grid.row(a).id],this._goToFeatures(a,"row-dblclick"))},_queryFeaturesByIds:function(a,b){var c=new w;c.objectIds=a;c.returnGeometry=!0;c.outSpatialReference=d.clone(this.map.spatialReference);c.outFields=["*"];a=this.layer;var e="esri.layers.CSVLayer"===a.declaredClass;a.url&&!e?(new z(a.url)).execute(c,d.hitch(this,function(a){this.selectFeatures(b,a.features)}),d.hitch(this,this._errorSelectFeatures)):a.selectFeatures(c,F.SELECTION_NEW,d.hitch(this,this.selectFeatures,
b),d.hitch(this,this._errorSelectFeatures))},_onHeaderClick:function(a){var b=this.grid.cell(a);this._showColumnMenu(b.column,b,a.target,{x:a.pageX,y:a.pageY})},_showColumnMenu:function(a,b,c,e){var f=d.getObject("_cache",!1,a);if(f&&(f.sortable||f.statistics)){var g=new S({});h.addClass(g.domNode,"jimu-widget-attributetable-feature-menu");var k=this;if(f.sortable){var q=["iconSortAscending","iconSortDescending"];l.forEach([this.nls.sortAsc,this.nls.sortDes],function(b,c){b=new r({label:b,iconClass:q[c],
baseClass:"menuItemClass",onClick:function(){0===c?k.grid.set("sort",a.field,!1):1===c&&k.grid.set("sort",a.field,!0)}});g.addChild(b)})}f.statistics&&(f=new r({label:this.nls.statistics,iconClass:"iconTableStatistics",baseClass:"menuItemClass",onClick:d.hitch(this,function(){var b={layer:this.layer,filterExpression:this._getLayerFilterExpression(),fieldNames:[a.field]};this.matchingMap&&(b.geometry=this._currentExtent);if(this.showSelected){var c=this._getSelectedIds();b.filterExpression+=" AND "+
this.layer.objectIdField+" IN ("+c.join()+")"}else this.queryByStoreObjectIds&&0<this.queryByStoreObjectIds.length&&(b.filterExpression+=" AND "+this.layer.objectIdField+" IN ("+this.queryByStoreObjectIds.join()+")");this.fieldStatistics=new ia;this.fieldStatistics.showContentAsPopup(b)})}),g.addChild(f));f=g.getChildren();g.startup();g._openMyself({target:c,delegatedTarget:b,iframe:null,coords:e});this.own(n(g,"Close",d.hitch(this,function(){var a=this.get("columnMenu");a&&(a.destroyRecursive(),
this.set("columnMenu",null))})));this.set("columnMenu",g);1>f.length&&n.emit(g,"Close")}},_onColumnStateChange:function(a){if(a&&a.grid&&a.grid.columns){var b=0,c;for(c in a.grid.columns)a.grid.columns[c].hidden||b++;20+100*b-1<h.getMarginBox(this.domNode).w?h.addClass(this.domNode,"auto-width"):h.removeClass(this.domNode,"auto-width")}},_onSelectionHandleClick:function(){var a=this._getSelectedIds();this.selectionRows=a;this._closePopup();this.layerInfo.isTable||(0<a.length?this._goToFeatures(a,
"rowclick"):this._setSelection([]));this.setSelectedNumber();this.emit("row-click",{table:this,selectedIds:a})},_onExtentChange:function(a){var b=d.getObject("delta.x",!1,a),c=d.getObject("delta.y",!1,a);a=this._clickMap&&!a.levelChange?isFinite(b)&&isFinite(c)&&(0<Math.abs(b)||0<Math.abs(c)):!0;this._clickMap=!1;a&&this.matchingMap&&this.actived&&this.layerInfo&&!this.layerInfo.isTable&&this.startQuery(this.queryByStoreObjectIds)},_getLayerFilterExpression:function(){var a=this.layerInfo.getFilter();
return a?a:"1\x3d1"},_getOutFieldsFromLayerInfos:function(a){var b=this.configedInfo.layer.fields,c=this.layerInfo.getPopupInfo(),e=c&&c.fieldInfos,f=[];b&&l.forEach(b,d.hitch(this,function(b){if(!q.isDefined(b.show)&&(b.show=!0,e))for(var c=0,d=e.length;c<d;c++){var g=e[c];g.fieldName===b.name&&(b.show=g.visible)}b.name!==a||"esriFieldTypeOID"!==b.type&&"esriFieldTypeInteger"!==b.type&&b.type||(b._pk=!0);(b.show||b._pk)&&f.push(b)}));return f},_processExecuteFields:function(a,b){if(a&&0<a.length){var c=
[];if(!b.length)return a;for(var e=0,f=b.length;e<f;e++)for(var g=0;g<a.length;g++)b[e].name!==a[g].name||b[e].type!==a[g].type&&b[e].type||(a[g]=d.mixin(a[g],b[e]),c.push(a[g]));return c}return b},_getSelectedIds:function(){var a=[],b=this.grid.selection,c;for(c in b)b[c]&&(isFinite(c)?a.push(parseInt(c,10)):a.push(c));return a},_getTableSelectedIds:function(){var a=[],b=this.getSelectedRows();if(this.grid)if(this.grid.store instanceof u){var c=l.map(this.grid.store.data,function(a){return a[this.layer.objectIdField]},
this);l.forEach(b,function(b){-1<c.indexOf(b)&&a.push(parseInt(b,10))})}else a=b;return a},isSelectionMode:function(){var a=this.getSelectedRows();return this.tableCreated&&a&&0<a.length&&this.layer&&this.layer.objectIdField?!0:!1},_errorSelectFeatures:function(a){console.error(a)},_popupMessage:function(a){var b=new y({message:a,buttons:[{label:this.nls.ok,onClick:d.hitch(this,function(){b.close()})}]});this._toggleLoading(!1)},_hasArcadeExpressionFields:function(){return this.layerInfo.getPopupInfo()&&
this.layerInfo.getPopupInfo().expressionInfos&&l.some(this.configedInfo.layer.fields,function(a){return v.arcade.isArcadeExpressionField(a)})},_hasArcadeExpressionWithGeometry:function(){var a=this.layerInfo.getPopupInfo()&&this.layerInfo.getPopupInfo().expressionInfos,b=v.arcade.parseArcadeExpressions(a);return b?l.some(Object.keys(b),function(a){return b[a].usesGeometry}):!1},_toggleLoading:function(a){void 0===a?this.loading.hidden?this.loading.show():this.loading.hide():a?this.loading.show():
this.loading.hide()}})});