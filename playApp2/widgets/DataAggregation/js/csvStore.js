// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/array dojo/_base/lang dojo/Deferred dojo/DeferredList dojo/Evented dojox/data/CsvStore dojo/store/Observable dojo/store/Memory esri/graphicsUtils esri/geometry/webMercatorUtils esri/geometry/Point esri/layers/FeatureLayer esri/tasks/locator esri/tasks/query esri/SpatialReference esri/dijit/PopupTemplate esri/geometry/geometryEngine esri/tasks/ProjectParameters esri/tasks/GeometryService esri/request jimu/utils moment/moment".split(" "),function(E,k,f,q,z,F,G,
H,I,J,K,A,L,M,B,C,N,D,O,P,Q,u,R){return E([F],{file:null,map:null,spatialReference:null,fsFields:[],duplicateTestFields:[],geocodeSources:[],duplicateData:[],data:null,editLayer:null,parent:null,separatorCharacter:null,csvStore:null,storeItems:null,matchedFeatureLayer:null,mappedArrayFields:null,unMatchedFeatureLayer:null,duplicateFeatureLayer:null,addrFieldName:"",xFieldName:"",yFieldName:"",symbol:null,matchFieldPrefix:"MatchField_",_internalFields:[],_removeLocators:[],constructor:function(a){f.mixin(this,
a);this.useAddr=!0;this.objectIdField="ObjectID";this.nls=a.nls;this.minScore=90;this._getDuplicateFields(this.fsFields);this.spatialReference=this.map.spatialReference;this.decimalSeperator=/^1(.+)1$/.exec(u.localizeNumber(1.1))[1].toString()},_getDuplicateFields:function(a){var b=[];k.forEach(a,function(a){a.duplicate&&b.push(a.name)});this.duplicateTestFields=b},handleCsv:function(){var a=new q;if(this.file&&!this.file.data){var b=new FileReader;b.onload=f.hitch(this,function(){this.data=b.result;
this._processCsvData().then(function(b){a.resolve(b)})});b.readAsText(this.file)}return a},_processCsvData:function(){var a=new q;this._convertSources();this._getSeparator();this._getCsvStore().then(function(b){a.resolve(b)});return a},processForm:function(){this._internalFields=["DestinationOID","matchScore","hasDuplicateUpdates","duplicateState"];this._matchFields=[];var a=new q;this._locateData(this.useAddr).then(f.hitch(this,function(b){var c=[],g=[],h=[],l={},d=0,e=0;0<this._removeLocators.length&&
(this._removeLocators.sort(function(a,d){return d-a}),k.forEach(this._removeLocators,f.hitch(this,function(a){this._geocodeSources.splice(a,1)})));for(var v=function(a,d,b,e){var l=a;-1===[null,void 0,""].indexOf(a)&&a.indexOf&&-1<a.indexOf(d)&&(b=b.filter(function(a){return a.keyField===e}))&&b.hasOwnProperty("length")&&1===b.length&&(l=a.toString?a.toString().replace(d,"."):a);return l},w=Object.keys(b),n=0;n<w.length;n++){var m={},p=b[w[n]],t=this.storeItems[p.csvIndex];k.forEach(this.fsFields,
f.hitch(this,function(a){if(this.mappedArrayFields.hasOwnProperty(a.name))if(this.mappedArrayFields[a.name]){var d=this.csvStore.getValue(t,this.mappedArrayFields[a.name]);if(a.domainValues){var b=a.domainValues.filter(f.hitch(this,function(a){return a.label===d}));m[a.name]=b&&0<b.length?b[0].value:d}else m[a.name]="."===this.decimalSeperator||this.useAddr?d:v(d,this.decimalSeperator,this._currentAddressFields,this.mappedArrayFields[a.name])}else m[a.name]=void 0}));k.forEach(this._currentAddressFields,
f.hitch(this,function(a){var d=this.matchFieldPrefix+a.keyField;if("undefined"!==typeof a.value){var b=this.csvStore.getValue(t,a.value);m[d]="."===this.decimalSeperator||this.useAddr?b:v(b,this.decimalSeperator,this._currentAddressFields,a.keyField)}else m[d]=void 0;this._matchFields.push(d)}));p&&p.score>this.minScore?(m.ObjectID=n-d-e,m.matchScore=p.score,c.push({geometry:p.location,attributes:f.clone(m)})):p.isDuplicate?(m.ObjectID=e,m.DestinationOID=p.featureAttributes[this.editLayer.objectIdField],
m.matchScore=100,m.hasDuplicateUpdates=!1,m.duplicateState="no-change",h.push({geometry:p.location,attributes:f.clone(m)}),l[e]=p.featureAttributes,e++):(m.ObjectID=d,m.matchScore=p.score?p.score:0,g.push({geometry:p.location&&p.location.type?p.location:new A(0,0,this.spatialReference),attributes:f.clone(m)}),d++)}this.matchedFeatureLayer=this._initLayer(c,this.file.name.replace(".csv",""));0<h.length&&(this.duplicateFeatureLayer=this._initLayer(h,this.file.name.replace(".csv","")+"_Duplicate"));
0<g.length&&(this.unMatchedFeatureLayer=this._initLayer(g,this.file.name.replace(".csv","")+"_UnMatched"));a.resolve({matchedLayer:this.matchedFeatureLayer,unMatchedLayer:this.unMatchedFeatureLayer,duplicateLayer:this.duplicateFeatureLayer,duplicateLookupList:l})}),function(b){a.reject(b,!0)});return a},_initLayer:function(a,b){a=this._generateFC(a);b=new L(a,{id:b,editable:!0,outFields:["*"]});this._initPopup(b);this.map.addLayers([b]);return b},_initPopup:function(a){var b={title:a.id+": {"+this.labelField+
"}"},c=[];k.forEach(a.fields,f.hitch(this,function(a){a.name!==this.objectIdField&&-1===this._internalFields.indexOf(a.name)&&-1===this._matchFields.indexOf(a.name)&&c.push({fieldName:a.name,visible:!0})}));b.fieldInfos=c;a.infoTemplate=new N(b)},_findDuplicates:function(){var a=new q;this._getAllLayerFeatures(this.editLayer,this.fsFields).then(f.hitch(this,function(b){this.keys=Object.keys(this.mappedArrayFields);this.oidField=this.editLayer.objectIdField;var c=[],g=[],h=this.duplicateTestFields;
h&&h.hasOwnProperty("length")&&0<h.length&&k.forEach(this.storeItems,f.hitch(this,function(a){var d={compareValues:{},fileId:a._csvId,featureId:-1};k.forEach(h,f.hitch(this,function(b){var e=this.mappedArrayFields[b];"undefined"!==typeof e&&(d.compareValues[b]=this.csvStore.getValue(a,e),-1===g.indexOf(b)&&g.push(b))}));0<Object.keys(d.compareValues).length&&c.push(d)}));var l=[];0<c.length&&k.forEach(c,f.hitch(this,function(a){k.forEach(b,f.hitch(this,function(b){var d={};k.forEach(g,f.hitch(this,
function(a){var e=b.attributes[a];d[a]=-1===[null,void 0].indexOf(e)&&e.toString?e.toString():e}));if(JSON.stringify(a.compareValues)===JSON.stringify(d)){var e=b.attributes[this.oidField];-1!==a.featureId?(a.hasMultiDuplicates=!0,"undefined"===typeof a.featureIds?(a.featureIds=[a.featureId,e],a.features=[a.feature,b]):(a.featureIds.push(e),a.features.push(b))):(a.featureId=e,a.feature=b,l.push(a))}}))}));a.resolve(l)}));return a},_getAllLayerFeatures:function(a,b){var c=new q,g=[this.editLayer.objectIdField];
k.forEach(b,function(a){a.name&&g.push(a.name)});2>g.length&&(g=b);var h=a.maxRecordCount;b=new B;b.where="1\x3d1";a.queryIds(b).then(function(b){var d=[],e,l;if(b&&0<b.length){e=0;for(l=b.length;e<l;e+=h){var k=new B;k.outFields=g;k.objectIds=b.slice(e,e+h);k.returnGeometry=!0;d.push(a.queryFeatures(k))}(new z(d)).then(f.hitch(this,function(a){if(a){for(var b=[],d=0;d<a.length;d++)a[d][1].features&&b.push.apply(b,a[d][1].features.map(function(a){return{geometry:a.geometry,attributes:a.attributes}}));
c.resolve(b)}}))}else c.resolve([])},function(a){console.error(a);c.resolve({type:"error",message:a})});return c},_locateData:function(a){var b=new q;this._findDuplicates().then(f.hitch(this,function(c){this.duplicateData=c;if(a){var g=f.hitch(this,function(a,b,d){var e=new q,h=this._geocodeSources[b],c=h.locator;c.outSpatialReference=this.spatialReference;var n=[],l=[],p=0,t,r;t=0;r=a.length;for(;t<r;t+=500){var x=a.slice(t,t+500),y=[];(h.singleEnabled||h.multiEnabled)&&k.forEach(x,f.hitch(this,
function(a){var b=a._csvId,e=null,c;a:for(c in this.duplicateData){var g=this.duplicateData[c];if(g.fileId===b){e=f.mixin({},g);delete this.duplicateData[c];break a}}var l={};l.OBJECTID=b;this.useMultiFields?k.forEach(this.multiFields,f.hitch(this,function(b){this._currentAddressFields=this.multiFields;if(b.value!==this.nls.noValue){var d=this.csvStore.getValue(a,b.value);l[b.keyField]=d}else l[b.keyField]=void 0})):this.singleFields[0].value!==this.nls.noValue&&(this._currentAddressFields=this.singleFields,
c=this.csvStore.getValue(a,this.singleFields[0].value),"undefined"===typeof c&&(c=typeof c+b),l[h.singleLineFieldName]=c);c=f.mixin({},l);c=JSON.stringify(c);if(null===e)y.push(l),d[c]={index:p,csvIndex:b,location:{}},p+=1;else if(null!==e){var g=e.feature.geometry,n=e.feature.attributes;if(-1!==[null,void 0].indexOf(g)&&e.features){var m=0;a:for(;m<e.features.length;m++){var v=e.features[m];if(-1===[null,void 0].indexOf(v.geometry)){g=v.geometry;n=v.attributes;break a}}}d[c]={index:-1,csvIndex:b,
isDuplicate:!0,location:f.mixin({},g),featureAttributes:n}}}));this.useMultiFields&&h.multiEnabled||!this.useMultiFields&&h.singleEnabled?l.push(c.addressesToLocations({addresses:y,countryCode:h.countryCode,outFields:["ResultID","Score"]})):(x=new q,x.reject(this.nls.warningsAndErrors.notConfigured,!0),l.push(x))}var u=Object.keys(d);(new z(l)).then(f.hitch(this,function(c){this.minScore=this._geocodeSources[b]?this._geocodeSources[b].minCandidateScore:90;b+=1;var l=this._geocodeSources.length>b;
if(c&&c.length&&c[0].length&&!1===c[0][0])if(1<c[0].length&&console.error(c[0][1]),(this.useMultiFields&&h.multiEnabled||!this.useMultiFields&&h.singleEnabled)&&this.parent.locatorError(this._geocodeSources[b-1].locator.url,!1),this._removeLocators.push(b-1),l)g(this._remainingStoreItems||this.storeItems,b,this._currentFinalResults||{}).then(f.hitch(this,function(a){e.resolve(a)}));else return 1<this._geocodeSources.length?e.resolve(d):e.reject(this.nls.warningsAndErrors.noMoreLocators),e.promise;
else if(c){var m=this.minScore,p=0;k.forEach(c,f.hitch(this,function(b){b=b[1];k.forEach(b,function(a){a.ResultID=a.attributes.ResultID});b=H(new I({data:b,idProperty:"ResultID"})).query({},{sort:[{attribute:"ResultID"}]});k.forEach(b,f.hitch(this,function(b){for(var e in u){var c=u[e];if(d[c]&&d[c].index===p){b.attributes.Score<m?l?(n.push(a[d[c].csvIndex]),delete d[c]):d[c].score=b.attributes.Score:(d[c].location=b.location,d[c].score=b.attributes.Score,delete d[c].index);delete u[e];break}}p+=
1}))}));if(l&&0<n.length)this._remainingStoreItems=n,this._currentFinalResults=d,g(n,b,d).then(f.hitch(this,function(a){e.resolve(a)}));else return e.resolve(d),e.promise}}),f.hitch(this,function(a){console.log(a);b+=1;if(this._geocodeSources.length>b)g(this._remainingStoreItems||this.storeItems,b,this._currentFinalResults||{}).then(f.hitch(this,function(a){e.resolve(a)}));else return 1<this._geocodeSources.length?e.resolve(d):e.reject(this.nls.warningsAndErrors.noMoreLocators),e.promise}));return e});
this._removeLocators=[];g(this.storeItems,0,{}).then(f.hitch(this,function(a){b.resolve(a)}))}else this._currentAddressFields=[{keyField:this.xFieldName,label:this.xFieldName,value:this.xFieldName},{keyField:this.yFieldName,label:this.yFieldName,value:this.yFieldName}],this._xyData({storeItems:this.storeItems,csvStore:this.csvStore,xFieldName:this.xFieldName,yFieldName:this.yFieldName,wkid:this.spatialReference.wkid}).then(f.hitch(this,function(a){if(this.isGeographic&&!this.map.spatialReference.isWebMercator()&&
4326!==this.spatialReference.wkid){var c=[];k.forEach(a,function(a){c.push(a.location)});var d=1<c.length?D.union(c):D.buffer(c[0],100,9001);this._projectPoints(d,c).then(function(c){for(var d=0;d<a.length;d++)a[d].location=c[d];b.resolve(a)})}else b.resolve(a)}),function(a){b.reject(a)})}));return b},_xyData:function(a){var b=new q,c=[],g=a.csvStore;k.forEach(a.storeItems,f.hitch(this,function(b){var l=b._csvId,d=null,e;a:for(e in this.duplicateData){var h=this.duplicateData[e];if(h.fileId===l){d=
f.mixin({},h);delete this.duplicateData[e];break a}}var w={};e=g.getAttributes(b);k.forEach(e,function(a){w[a]=g.getValue(b,a)});e=!1;var n,m;null!==d&&d.feature&&d.feature.geometry?(h=d.feature.geometry,e=!0,m=d.feature.attributes):(d=g.getValue(b,a.xFieldName),n=g.getValue(b,a.yFieldName),"."!==this.decimalSeperator&&(d=-1!==[null,void 0,""].indexOf(d)?void 0:d.toString().replace(this.decimalSeperator,"."),n=-1!==[null,void 0,""].indexOf(n)?void 0:n.toString().replace(this.decimalSeperator,".")),
d=parseFloat(d),n=parseFloat(n),h=this._getGeometry(d,n),n=isNaN(d)||isNaN(n)?0:100);h&&c.push({attributes:w,location:h,csvIndex:l,score:n,isDuplicate:e,featureAttributes:m})}));b.resolve(c);return b},_getGeometry:function(a,b){"undefined"===typeof this.isGeographic&&(this.isGeographic=/(?=^[-]?\d{1,3}\.)^[-]?\d{1,3}\.\d+|(?=^[-]?\d{4,})|^[-]?\d{1,3}/.exec(a)?!0:!1);a=new A(isNaN(a)?0:a,isNaN(b)?0:b);this.isGeographic&&this.spatialReference.isWebMercator()?a=K.geographicToWebMercator(a):a.spatialReference=
this.isGeographic&&4326!==this.spatialReference.wkid?new C(4326):new C({wkid:this.spatialReference.wkid});return a},_projectPoints:function(a,b){var c=new q;this.gsvc=new P(this.appConfig.geometryService);a={url:this.gsvc.url+"/findTransformations",content:{f:"json",inSR:a.spatialReference.wkid,outSR:this.spatialReference.wkid,extentOfInterest:JSON.stringify(a.getExtent().toJson())},handleAs:"json",callbackParamName:"callback"};Q(a,{usePost:!1}).then(f.hitch(this,function(a){a=(a=a&&a.transformations?
a.transformations:void 0)&&0<a.length?a[0].wkid:void 0;var h=new O;h.outSR=this.spatialReference;h.geometries=b;h.transformForward=!0;h.transformation=a;this.gsvc.project(h,f.hitch(this,function(a){c.resolve(a)}),function(a){c.reject(a)})}),function(a){c.reject(a)});return c},_generateFC:function(a){var b={layerDefinition:{geometryType:"esriGeometryPoint",spatialReference:this.spatialReference,objectIdField:this.objectIdField,type:"Feature Layer",drawingInfo:{renderer:{type:"simple",symbol:this.symbol}},
fields:[{name:this.objectIdField,alias:this.objectIdField,type:"esriFieldTypeOID"}]},featureSet:{features:a,geometryType:"esriGeometryPoint"}};k.forEach(this.fsFields,f.hitch(this,function(a){b.layerDefinition.fields.push({name:a.name,alias:a.label,type:a.value,editable:!0,domain:null})}));return b},clear:function(){this._removeLayer(this.matchedFeatureLayer);this._removeLayer(this.unMatchedFeatureLayer);this._removeLayer(this.duplicateFeatureLayer);this.storeItems=this.csvStore=this.separatorCharacter=
this.data=this.fsFields=this.file=void 0;this.duplicateData=[];this.mappedArrayFields=this.duplicateFeatureLayer=this.unMatchedFeatureLayer=this.matchedFeatureLayer=void 0;this.useAddr=!0;this.yFieldName=this.xFieldName=this.addrFieldName=""},_removeLayer:function(a){a&&(this.map.removeLayer(a),a.clear())},_getSeparator:function(){var a=this.data.indexOf("\n"),b=f.trim(this.data.substr(0,a)),c=0,g="";k.forEach([",","      ",";","|"],function(a){var f=b.split(a).length;f>c&&(c=f,g=a)});this.separatorCharacter=
g},_getCsvStore:function(){var a=new q;this.csvStore=new G({data:this.data,separator:this.separatorCharacter});this.csvStore.fetch({onComplete:f.hitch(this,function(b){this.storeItems=b;this._fetchFieldsAndUpdateForm(this.storeItems,this.csvStore,this.fsFields).then(function(b){a.resolve(b)})}),onError:function(b){console.error("Error fetching items from CSV store: ",b);a.reject(b)}});return a},_fetchFieldsAndUpdateForm:function(a,b,c){var f=new q,h=b._attributes,l=this.decimalSeperator,d={};k.forEach(h,
function(c){k.forEach(a,function(a){var e=!0,f=!0,h=!0,g=!0,k;d.hasOwnProperty(c)&&(f=d[c].supportsInt,h=d[c].supportsFloat,g=d[c].supportsDate,k=d[c].maxLength,f||h||g||(e=!1));var r=b.getValue(a,c);if(r){a=r.toString().length;var q=R(r);if(e){e=-1!==[null,void 0,""].indexOf(r);if(!e&&(g=g&&q.isValid()))if(q=r)try{g=!isNaN((new Date(q)).getTime())}catch(y){console.error(y),g=!1}else g=-1<[null,void 0,""].indexOf(q)?!0:!1;d[c]={supportsDate:g,supportsInt:e?f:!isNaN(parseInt(r,10))&&parseInt(r,10).toString().length===
a&&f};"."!==l&&(r=e?"":r.toString().replace(l,"."));d[c].supportsFloat=e?h:!isNaN(parseFloat(r))&&parseFloat(r).toString().length===a&&h}f=d[c];f.maxLength=k;"undefined"===typeof f.maxLength?f.maxLength=a:f.maxLength<a&&(f.maxLength=a)}})});f.resolve({fields:h,fieldTypes:d,fsFields:c});return f},_zoomToData:function(a,b){if(a&&0<a.length)try{var c=J.graphicsExtent(a);b?this.map.setExtent(c.expand(1.9),!0):this.map.setExtent(c,!0)}catch(g){console.log(g.message)}},_convertSources:function(){this.geocodeSources&&
0<this.geocodeSources.length&&(this._geocodeSources=k.map(this.geocodeSources,f.hitch(this,function(a){if(a&&a.url&&"locator"===a.type)return{locator:new M(a.url||""),outFields:["ResultID","Score"],singleLineFieldName:a.singleLineFieldName||"",name:u.stripHTML(a.name||""),placeholder:u.stripHTML(a.placeholder||""),countryCode:a.countryCode||"",addressFields:a.addressFields,singleEnabled:a.singleEnabled||!1,multiEnabled:a.multiEnabled||!1,minCandidateScore:a.minCandidateScore||90}})))}})});