// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/array dojo/_base/declare dojo/_base/lang dojo/dom-class dojo/dom-construct dojo/_base/html dojo/on dojo/string jimu/dijit/_GeocodeServiceChooserContent jimu/dijit/Popup jimu/dijit/LoadingShelter jimu/portalUrlUtils jimu/dijit/Message esri/request esri/lang ./convert ./QuerySourceSetting ./settingComponents ./SettingBoxedDivs ./SettingBufferBlock ./SettingCheckboxLabeled ./SettingContainer ./SettingDropdownLabeled ./SettingFieldListLabeled ./SettingInputLabeled ./SettingObject ./SettingOptionsTable ./SettingStaticText".split(" "),
function(g,y,e,q,r,n,h,p,z,A,B,t,u,C,D,v,E,k,F,w,l,m,G,H,f,I,J,x){return y(I,{_inputControl:null,_mainControl:null,_detailsDiv:null,_detailsTitle:null,_detailsCheckbox:null,_sourceDisplay:null,_iCurrentSource:-1,_sourceMenuItems:[],_newSourceTypeMenuItems:[],_nls:null,_webmapFeatureLayers:[],_fieldListPicker:null,_displayFieldInput:null,constructor:function(b,a,c,d,K,g){this._nls=a;this._map=d;this._webmapFeatureLayers=K;this._portalUrl=g;this._newSourceTypeMenuItems=[a.groupingLabels.featureLayerDetails,
a.groupingLabels.geocoderDetails];this._inputControl=new J(null,"third-width","",a.propertyLabels.name,null,"",e.hitch(this,this._onRowSelected),e.hitch(this,this._onRowDeleted),e.hitch(this,this._onRowMoved));this._detailsDiv=k.container("two-thirds-width","majorTrailingVertGap",[]);b=k.addTextButtonDropdownCtl("",a.buttons.addSearchSource,this._newSourceTypeMenuItems);this.own(h(b.ctl,"click",e.hitch(this,this._onAddSearchSourceMenuItemClick)));this._mainControl=new m(null,c||"","majorTrailingVertGap",
a.groupingLabels.searchSources,"full-width",[new f("allPlaceholder",!1,"full-width","third-width","two-thirds-width",a.propertyLabels.placeholderTextForAllSources),new l("showInfoWindowOnSelect","full-width","third-width","two-thirds-width",a.propertyLabels.showPopupForFoundItem),new F(null,[b.div,k.container("full-width flexbox","majorTrailingHorizGap",[this._inputControl.div(),this._detailsDiv])])]);this._mainDiv=this._mainControl.div()},setConfig:function(){this._mainControl.setConfig(this._config);
this._sourceMenuItems=g.map(this._config.sources,function(b){return{item:b.name}});this._inputControl.setValue(this._sourceMenuItems);0<this._sourceMenuItems.length&&this._inputControl.selectTableRow(0)},getConfig:function(b,a){this._mainControl.getConfig(this._config);this._setDetails(-1);g.forEach(this._config.sources,function(c){"locator"===c.type?c.url||a.push(p.substitute(this._nls.problems.noSearchSourceURL,{sourceName:c.name})):0===c.searchFields.length&&a.push(p.substitute(this._nls.problems.noSearchSourceFields,
{sourceName:c.name}));0>c.buffer.bufferUnitsMenu[0].indexOf("1")&&a.push(p.substitute(this._nls.problems.noBufferUnitsForSearchSource,{sourceName:c.name}))},this)},_onAddSearchSourceMenuItemClick:function(b){var a,c={};if(b.target.innerText===this._newSourceTypeMenuItems[0]){var d=new E({nls:this._nls.querySourceSetting,map:this._map,appConfig:{portalUrl:this._portalUrl}});a=e.clone(this._config.searchSourceTemplates.query);d.setConfig({name:a.name||"",placeholder:a.placeholder||"",searchFields:a.searchFields||
[],displayField:a.displayField||"",maxSuggestions:a.maxSuggestions||6,maxResults:a.maxResults||6,zoomScale:a.zoomScale||5E4,exactMatch:a.exactMatch,searchInCurrentMapExtent:a.searchInCurrentMapExtent,type:a.type||"query",layerId:a.layerId,url:a.url||""});d._openQuerySourceChooser();d.own(h(d,"select-query-source-ok",e.hitch(this,function(b){a.name=b.name;a.layerId=b.layerInfo?b.layerInfo.id:null;a.url=b.url;a.buffer=e.clone(this._config.bufferTemplate);a.fieldMenuItems=[];(b=b.definition&&b.definition.fields)&&
g.map(b,function(b){a.fieldMenuItems.push({label:b.alias||b.name,value:b.name})});this._config.sources.push(a);c.item=a.name;this._sourceMenuItems.push(c);this._inputControl.addRowToTable(c);this._inputControl.selectTableRow(this._config.sources.length-1);d.destroy();d=null})));d.own(h(d,"select-query-source-cancel",function(){d.destroy();d=null}))}else a=e.clone(this._config.searchSourceTemplates.locator),a.buffer=e.clone(this._config.bufferTemplate),this._openServiceChooser(a,c)},_openServiceChooser:function(b,
a){var c=b&&a?!1:!0;this.serviceChooserContent=new z({url:c?this._sourceDisplay._contents[0].getValue():""});this.shelter=new B({hidden:!0});this.geocoderPopup=new A({titleLabel:this._nls.querySourceSetting.setGeocoderURL,autoHeight:!0,content:this.serviceChooserContent.domNode,container:window.jimuConfig.layoutId,width:640,configItem:b||this._config.sources[this._iCurrentSource],menuEntry:a||this._sourceMenuItems[this._iCurrentSource],update:c});this.shelter.placeAt(this.geocoderPopup.domNode);n.setStyle(this.serviceChooserContent.domNode,
"width","580px");n.addClass(this.serviceChooserContent.domNode,"override-geocode-service-chooser-content");this.serviceChooserContent.own(h(this.serviceChooserContent,"validate-click",e.hitch(this,function(){n.removeClass(this.serviceChooserContent.domNode,"override-geocode-service-chooser-content")})));this.serviceChooserContent.own(h(this.serviceChooserContent,"ok",e.hitch(this,"_onSelectLocatorUrlOk")));this.serviceChooserContent.own(h(this.serviceChooserContent,"cancel",e.hitch(this,"_onSelectLocatorUrlCancel")))},
_onSelectLocatorUrlOk:function(b){if(b&&b[0]&&b[0].url){this.shelter.show();var a=b[0].url;C({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(e.hitch(this,function(b){this.shelter.hide();if(b&&b.singleLineAddressField&&b.singleLineAddressField.name){var c=this.geocoderPopup.configItem;c.singleLineFieldName=b.singleLineAddressField.name;"string"===typeof a?(b=a.split("/"),c.name=b[b.length-2]||"geocoder"):c.name="geocoder";c.url=a;b=this.geocoderPopup.menuEntry;b.item=
c.name;this._sourceDisplay&&this._sourceDisplay._contents&&this._sourceDisplay._contents[0]&&this._sourceDisplay._contents[0].getValue&&this._sourceDisplay._contents[0].getValue()!==a&&(this._sourceDisplay._contents[0].setValue(a),this._sourceDisplay._contents[1].setValue(c.name));this.geocoderPopup.update?(this._config.sources[this._iCurrentSource]=c,this._sourceMenuItems[this._iCurrentSource]=b):(this._config.sources.push(c),this._sourceMenuItems.push(b),this._inputControl.addRowToTable(b));this._setDetails(this._iCurrentSource);
this._inputControl.selectTableRow(this.geocoderPopup.update?this._iCurrentSource:this._config.sources.length-1);this.geocoderPopup&&(this.geocoderPopup.close(),this.geocoderPopup=null)}else new u({message:this._nls.querySourceSetting.locatorWarning})}),e.hitch(this,function(b){console.error(b);this.shelter.hide();new u({message:D.substitute({URL:this._getRequestUrl(a)},e.clone(this._nls.querySourceSetting.invalidUrlTip))})}))}},_getRequestUrl:function(b){var a=window.location.protocol;return"http:"===
a?t.setHttpProtocol(b):"https:"===a?t.setHttpsProtocol(b):b},_onSelectLocatorUrlCancel:function(){this.geocoderPopup&&(this.geocoderPopup.close(),this.geocoderPopup=null,this.emit("select-locator-url-cancel"))},_setDetails:function(b){var a=this._sourceMenuItems.length;this._removeCurrentDetails();if(0<=b&&b<a){a=this._config.sources[b];if("query"===a.type)this._fieldListPicker=new H("searchFields",this._nls,"full-width","details-label","details-value",this._nls.propertyLabels.searchFields,this._nls.hints.csvNameList,
a.fieldMenuItems),this._displayFieldInput=new G("displayField","full-width","details-label","details-value",this._nls.propertyLabels.displayField,"",a.fieldMenuItems,e.hitch(this,this._onChangeField)),this._sourceDisplay=new m(null,"","majorTrailingVertGap",this._nls.groupingLabels.featureLayerDetails,"full-width",[new m(null,"full-width","minorTrailingHorizGap",[new x(null,"details-label inline-block",this._nls.querySourceSetting.layerSource),new x(null,"details-value inline-block wrapText",a.url)]),
new f("name",!1,"full-width","details-label","details-value",this._nls.propertyLabels.name,a.name),new f("placeholder",!1,"full-width","details-label","details-value",this._nls.propertyLabels.placeholderText),this._fieldListPicker,this._displayFieldInput,new f("maxSuggestions",!0,"full-width","details-label","details-value",this._nls.propertyLabels.maximumSuggestions,"6",null,null,null,{min:1,max:10,places:0}),new f("maxResults",!0,"full-width","details-label","details-value",this._nls.propertyLabels.maximumResults,
"6",null,null,null,{min:1,max:10,places:0}),new f("zoomScale",!0,"full-width","details-label","details-value",this._nls.propertyLabels.zoomScale,"50000","","1:",null,{min:0,places:0}),new l("exactMatch","full-width","details-label","details-value",this._nls.propertyLabels.exactMatch),new l("searchInCurrentMapExtent","full-width","details-label","details-value",this._nls.propertyLabels.limitSearchToMapExtent),new w("buffer",this._nls,"full-width","details-label","details-value",this._config.bufferTemplate,
this._nls.propertyLabels.bufferDefaultDistance,"100")]);else if("locator"===a.type){var c=k.textButtonCtl("",this._nls.querySourceSetting.set,this._nls.querySourceSetting.set);this.own(h(c.ctl,"click",e.hitch(this,this._openServiceChooser,void 0,void 0)));this._sourceDisplay=new m(null,"","majorTrailingVertGap",this._nls.groupingLabels.geocoderDetails,"full-width",[new f("url",!1,"full-width","details-label","details-value",this._nls.propertyLabels.url,void 0,void 0,void 0,c,void 0,!0),new f("name",
!1,"full-width","details-label","details-value",this._nls.propertyLabels.name),new f("placeholder",!1,"full-width","details-label","details-value",this._nls.propertyLabels.placeholderText),new f("countryCode",!1,"full-width","details-label","details-value",this._nls.propertyLabels.countryRegionCodes,this._nls.placeholders.countryRegionCodes),new f("maxSuggestions",!0,"full-width","details-label","details-value",this._nls.propertyLabels.maximumSuggestions,"6",null,null,null,{min:1,max:10,places:0}),
new f("maxResults",!0,"full-width","details-label","details-value",this._nls.propertyLabels.maximumResults,"6",null,null,null,{min:1,max:10,places:0}),new f("zoomScale",!0,"full-width","details-label","details-value",this._nls.propertyLabels.zoomScale,"50000","","1:",null,{min:0,places:0}),new l("searchInCurrentMapExtent","full-width","details-label","details-value",this._nls.propertyLabels.limitSearchToMapExtent),new w("buffer",this._nls,"full-width","details-label","details-value",this._config.bufferTemplate,
this._nls.propertyLabels.bufferDefaultDistance,"100")])}this._sourceDisplay&&(a.buffer.bufferUnitsMenu=v.unitCodesToLabels(jimuNls.units,a.buffer.bufferUnitsMenu),this._sourceDisplay.setConfig(a),r.place(this._sourceDisplay.div(),this._detailsDiv),q.remove(this._detailsDiv,"hidden"),this._iCurrentSource=b)}},_convertLayerIdToLayerName:function(b){var a=b;g.some(this._webmapFeatureLayers,function(c){return c.layerId===b?(a=c.name,!0):!1});return a},_convertLayerNameToLayerId:function(b){var a=b;g.some(this._webmapFeatureLayers,
function(c){return c.name===b?(a=c.layerId,!0):!1});return a},_onChangeFeatureLayer:function(b){var a,c=[];0<=this._iCurrentSource&&(a=this._config.sources[this._iCurrentSource],g.some(this._webmapFeatureLayers,e.hitch(this,function(d){return b===d.layerId?(a.name=d.layerId,a.searchFields=[],a.displayField=d.displayField,a.layerId=d.layerId,a.url=d.url,g.map(d.fields,function(a){c.push({label:a.alias||a.name,value:a.name})}),this._fieldListPicker.setFieldList(c),this._fieldListPicker.setDisplay(),
this._displayFieldInput.setOptions(c),this._inputControl.renameTableRow(this._iCurrentSource,d.name),!0):!1})))},_onChangeField:function(b){var a;0<=this._iCurrentSource&&(a=this._config.sources[this._iCurrentSource],a.displayField=b)},_onRowSelected:function(b){this._setDetails(b.rowIndex)},_onRowMoved:function(b,a){var c;this._removeCurrentDetails();c=a?b.rowIndex+1:b.rowIndex-1;a=this._sourceMenuItems.splice(c,1);c=this._config.sources.splice(c,1);this._sourceMenuItems.splice(b.rowIndex,0,a[0]);
this._config.sources.splice(b.rowIndex,0,c[0]);this._inputControl.selectTableRow(b.rowIndex)},_onRowDeleted:function(b,a,c){this._removeCurrentDetails();this._sourceMenuItems.splice(c,1);this._config.sources.splice(c,1);0<this._sourceMenuItems.length&&this._inputControl.selectTableRow(0)},_removeCurrentDetails:function(){var b;0<=this._iCurrentSource&&(q.add(this._detailsDiv,"hidden"),b=this._config.sources[this._iCurrentSource],this._sourceDisplay.getConfig(b),b.buffer.bufferUnitsMenu=v.labelsToUnitCodes(jimuNls.units,
b.buffer.bufferUnitsMenu),"query"===b.type&&(b.name=this._convertLayerIdToLayerName(b.name)),r.empty(this._detailsDiv),this._sourceDisplay=null,this._iCurrentSource=-1)}})});