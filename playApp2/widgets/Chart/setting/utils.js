// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define(["dojo/Deferred","dojo/_base/lang","esri/request","jimu/utils"],function(f,e,g,h){return{_cacheDefinition:{},getLayerDefinitionByLayerIdOrUrl:function(b,a){var c=new f,d=this._cacheDefinition[b]||this._cacheDefinition[a];if(d)return c.resolve(d),c;if(!b)return g({url:a,hanleAs:"json",content:{f:"json"},callbackParamName:"callback"}).then(function(b){this._cacheDefinition[a]=b;c.resolve(b)}.bind(this),function(a){c.reject(a)}),c;if(d=this.layerInfosObj.getLayerInfoById(b)){var e=d.getPopupInfo();
this._getServiceDefinitionByLayerInfo(d).then(function(a){this._addAliasForLayerDefinition(a,e);this._cacheDefinition[b]=a;c.resolve(a)}.bind(this))}else c.reject("Invaild layerInfo for layer id: "+b);return c},_getServiceDefinitionByLayerInfo:function(b){return b.getServiceDefinition().then(e.hitch(this,function(a){return a?a:b.getLayerObject().then(e.hitch(this,function(a){return a?h.getFeatureLayerDefinition(a):null}))}))},_addAliasForLayerDefinition:function(b,a){b&&b.fields&&0<b.fields.length&&
b.fields.forEach(e.hitch(this,function(b){var c=this.getFieldAliasByFieldInfo(b,a);c&&(b.alias=c)}))},getFieldAliasByFieldInfo:function(b,a){var c="";if(!b)return c;var d=b.name,c=b.alias||d;a&&(c=this.getAliasFromPopupInfo(d,a));return c},getAliasFromPopupInfo:function(b,a){var c=b;if(!a)return c;(a=a.fieldInfos)&&0<a.length&&a.forEach(function(a){a.fieldName===b&&(c=a.label)});return c},getAliasByFieldName:function(b,a){if(b&&a&&a.fields&&a.fields.length)return(a=a.fields.filter(function(a){return a.name===
b})[0])&&a.alias},updateOptions:function(b,a,c,d){a?(a=e.clone(a),b.removeOption(b.getOptions()),b.addOption(a)):a=[];!c&&0<a.length&&(c=a[0].value);c&&(b.set("value",c),d&&(a=b.getOptions(c))&&"undefined"!==typeof a.label&&b.set("title",a.label))}}});