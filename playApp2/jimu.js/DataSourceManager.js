// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/topic dojo/Evented dojo/when ./utils jimu/LayerInfos/LayerInfos jimu/portalUtils jimu/portalUrlUtils jimu/filterUtils esri/tasks/query esri/tasks/QueryTask esri/tasks/StatisticDefinition ./Query".split(" "),function(t,d,h,g,u,k,l,n,v,w,x,q,r,y,z){var m=null,p=t(u,{constructor:function(){this._listeners=[];this._refreshTimers=[];this._dataStore={};this._jimuQueryObject={};this._dataSourceUsage={};this._itemsFilter={};this.filterUtils=
new x;window.isBuilder?(g.subscribe("app/mapLoaded",d.hitch(this,this._onMapLoaded)),g.subscribe("app/mapChanged",d.hitch(this,this._onMapChanged))):(g.subscribe("mapLoaded",d.hitch(this,this._onMapLoaded)),g.subscribe("mapChanged",d.hitch(this,this._onMapChanged)));window.isBuilder?(g.subscribe("app/appConfigLoaded",d.hitch(this,this._onAppConfigLoaded)),g.subscribe("app/appConfigChanged",d.hitch(this,this._onAppConfigChanged))):(g.subscribe("appConfigLoaded",d.hitch(this,this._onAppConfigLoaded)),
g.subscribe("appConfigChanged",d.hitch(this,this._onAppConfigChanged)));g.subscribe("updateDataSourceData",d.hitch(this,this._onUpdataDataSourceData));window.isBuilder&&g.subscribe("app/dataSourceDataUpdated",d.hitch(this,this._onDataSourceDataUpdatedInApp))},getData:function(a){return this._dataStore[a]},getDataSourceConfig:function(a){return this.appConfig.dataSource.dataSources[a]},parseDataSourceId:function(a){var b=a.split("~"),c={};if(2>b.length)return console.error("Bad data source id:",a),
c;switch(b[0]){case "map":return b=a.lastIndexOf("~"),c={from:"map",layerId:a.substring(4,b)};case "widget":return c={from:"widget",widgetId:b[1]};case "external":return c={from:"external"};default:console.error("Bad data source id:",a)}},addDataSourceUsage:function(a,b){this._dataSourceUsage[a]?(0>this._dataSourceUsage[a].indexOf(b)&&this._dataSourceUsage[a].push(b),1===this._dataSourceUsage[a].length&&this._startOneDataSource(this.appConfig.dataSource.dataSources[a])):(this._dataSourceUsage[a]=
[b],this._startOneDataSource(this.appConfig.dataSource.dataSources[a]))},removeDataSourceUsage:function(a,b){this._dataSourceUsage[a]&&0<=this._dataSourceUsage[a].indexOf(b)&&(this._dataSourceUsage[a]=h.filter(this._dataSourceUsage[a],function(a){return a!==b}))},_onUpdataDataSourceData:function(a,b){this.appConfig.dataSource.dataSources[a]?"widget"!==this.parseDataSourceId(a).from?console.error("Please update data source from widget only.",a):this._updateDataSourceData(a,b):console.error("Not found data source id:",
a)},_updateDataSourceData:function(a,b){this._dataStore[a]=b;g.publish("dataSourceDataUpdated",a,b);this.emit("update",a,b)},_onDataSourceDataUpdatedInApp:function(a,b){this._updateDataSourceData(a,b)},_onMapLoaded:function(a){this.map=a;window.isBuilder||this._handleDataSourceConfigChange(this.appConfig,this.appConfig,"mapLoaded")},_onMapChanged:function(a){this.map=a;window.isBuilder||this._handleDataSourceConfigChange(this.appConfig,this.appConfig,"mapChanged")},_onAppConfigLoaded:function(a){this.appConfig=
d.clone(a)},_onAppConfigChanged:function(a,b){a=d.clone(a);window.isBuilder||("dataSourceChange"===b?this._handleDataSourceConfigChange(this.appConfig,a,b):"mapChange"===b&&this._cleanForConfigChangedDataSource(this.appConfig,a));this.appConfig=a},_handleDataSourceConfigChange:function(a,b,c){a&&(this._removeListeners(),this._removeTimers(),this._cleanForConfigChangedDataSource(a,b));h.forEach(Object.keys(b.dataSource.dataSources),function(a){b.dataSource.dataSources[a].idObj=this.parseDataSourceId(a)},
this);this._listenDataSourceChange(b.dataSource.dataSources);this._startRefreshTimer(b.dataSource,c);this._initStaticDataSource(b.dataSource)},_cleanForConfigChangedDataSource:function(a,b){var c=a.dataSource.dataSources,d=b.dataSource.dataSources;h.forEach(Object.keys(c),function(a){if(!d[a]||d[a]&&!l.isEqual(d[a],c[a]))delete this._jimuQueryObject[a],this._updateDataSourceData(a,{features:[]}),delete this._dataStore[a]},this)},_isGlobalRefresh:function(a){return a.unifiedRefreshInterval&&0<a.unifiedRefreshInterval},
_startOneDataSource:function(a){var b;b=this._isGlobalRefresh(this.appConfig.dataSource.settings)?this.appConfig.dataSource.settings.unifiedRefreshInterval:a.refreshInterval;if("map"===a.idObj.from)this._listenMapDataSourceChange(a);else if("external"===a.idObj.from&&a.filterByExtent){var c={};c.handle=this.map.on("extent-change",d.hitch(this,this._onLayerDataChange,a));c.dsId=a.id;this._listeners.push(c)}if("map"===a.idObj.from||"external"===a.idObj.from)this._refeshDataSource(a),a.isDynamic&&(c=
{},c.handle=setInterval(d.hitch(this,this._refeshDataSource,a),6E4*b),c.dsId=a.id,this._refreshTimers.push(c))},_stopAndCleanOneDataSource:function(a){this._listeners=h.filter(this._listeners,function(b){return b.dsId===a.id?(b.handle.remove(),!1):!0},this);this._refreshTimers=h.filter(this._refreshTimers,function(b){return b.dsId===a.id?(clearInterval(b.handle),!1):!0},this);this._updateDataSourceData(a.id,{features:[]})},_listenDataSourceChange:function(a){h.forEach(Object.keys(a),function(b){b=
a[b];if("map"===b.idObj.from)this._listenMapDataSourceChange(b);else if("external"===b.idObj.from&&b.filterByExtent){var c={};c.handle=this.map.on("extent-change",d.hitch(this,this._onLayerDataChange,b));c.dsId=b.id;this._listeners.push(c)}},this)},_listenMapDataSourceChange:function(a){this._getLayerObject(a.idObj.layerId).then(d.hitch(this,function(b){if(b){var c={};c.handle=b.on("edits-complete",d.hitch(this,this._onLayerDataChange,a));c.dsId=a.id;this._listeners.push(c);c={};c.handle=this._getLayerInfo(a.idObj.layerId).on("filterChanged",
d.hitch(this,this._onLayerDataChange,a));c.dsId=a.id;this._listeners.push(c);a.filterByExtent&&(c={},c.handle=this.map.on("extent-change",d.hitch(this,this._onLayerDataChange,a)),c.dsId=a.id,this._listeners.push(c))}else console.error("Can not find layer that data source depends on.",a.id)}))},_onLayerDataChange:function(a){this._doQueryForDataSource(a)},_doQueryForDataSource:function(a){("config"===this.appConfig.mode||this._dataSourceUsage[a.id]&&0!==this._dataSourceUsage[a.id].length)&&this.doQuery(a).then(d.hitch(this,
function(b){this._updateDataSourceData(a.id,{features:b.features})}))},_getLayerObject:function(a){return(a=n.getInstanceSync().getLayerOrTableInfoById(a))?a.getLayerObject():k(null)},_getLayerInfo:function(a){return n.getInstanceSync().getLayerOrTableInfoById(a)},_startRefreshTimer:function(a,b){var c=a.dataSources,f=a.settings;h.forEach(Object.keys(c),function(e){e=c[e];if("widget"!==e.idObj.from&&e.isDynamic&&e.url){var g;g=this._isGlobalRefresh(f)?f.unifiedRefreshInterval:e.refreshInterval;"dataSourceChange"===
b?"external"!==e.idObj.from&&"map"!==e.idObj.from||this._refeshDataSource(e):"external"===e.idObj.from&&this._refeshDataSource(e);e={handle:setInterval(d.hitch(this,this._refeshDataSource,e),6E4*g),dsId:a.id};this._refreshTimers.push(e)}},this)},_initStaticDataSource:function(a){h.forEach(Object.keys(a.dataSources),function(b){b=a.dataSources[b];"widget"!==b.idObj.from&&!b.isDynamic&&b.url&&this._doQueryForDataSource(b)},this)},_refeshDataSource:function(a){this._doQueryForDataSource(a)},_getDataSourceFilter:function(a){if("map"===
a.idObj.from){var b=n.getInstanceSync().getLayerOrTableInfoById(a.idObj.layerId),c;b&&(c=b.getFilter());var b=a.filter?this._getFilterExpr(a.filter,a.url):"1\x3d1",f;f=c?"("+c+") and ("+b+")":b;return k(f)}return"external"===a.idObj.from?a.portalUrl&&a.itemId?this._getFilterFromItem(a.portalUrl,a.itemId,a.url).then(d.hitch(this,function(b){var c=a.filter?this._getFilterExpr(a.filter,a.url):"1\x3d1";return f=b?"("+b+") and ("+c+")":c})):k(a.filter?this._getFilterExpr(a.filter,a.url):"1\x3d1"):k(a.filter?
this._getFilterExpr(a.filter,a.url):"1\x3d1")},_getFilterExpr:function(a,b){return this.filterUtils.hasVirtualDate(a)?(this.filterUtils.isHosted=l.isHostedService(b),this.filterUtils.getExprByFilterObj(a)):a.expr},_getFilterFromItem:function(a,b,c){var f=w.getItemUrl(a,b);if(this._itemsFilter[f])return k(this._itemsFilter[f]);var e=v.getPortal(a);return e.getItemById(b).then(d.hitch(this,function(a){return"Feature Service"!==a.type?this._itemsFilter[f]=null:e.getItemData(b).then(d.hitch(this,function(a){var b=
c.split("/"),d=b.pop();d||(d=b.pop());if(!a.layers)return this._itemsFilter[f]=null;a=a.layers.filter(function(a){return a.id+""===d})[0];return a&&a.layerDefinition?this._itemsFilter[f]=a.layerDefinition.definitionExpression:this._itemsFilter[f]=null}))}))},doQuery:function(a){a.idObj||(a.idObj=this.parseDataSourceId(a.id));this.emit("begin-update",a.id);return this._getQueryObjectFromDataSource(a).then(d.hitch(this,function(b){var c,f;if("Features"===a.type){if("serviceLimitation"===a.resultRecordType)return c=
b,f=new r(a.url),f.execute(c);var e=this._jimuQueryObject[a.id];!e||e.url===a.url&&l.isEqual(e.query.toJson(),b.toJson())||(delete this._jimuQueryObject[a.id],e=null);e||(e={},e.url=a.url,e.query=b,"all"!==a.resultRecordType&&(e.pageSize=a.resultRecordCount),e=new z(e),this._jimuQueryObject[a.id]=e);return"all"===a.resultRecordType?e.getAllFeatures():e.queryByPage(1)}f=new r(a.url);c=new q;return this._getDataSourceFilter(a).then(d.hitch(this,function(b){c.where=b;a.filterByExtent&&(c.geometry=this.map.extent);
a.dataSchema.groupByFields&&0<a.dataSchema.groupByFields.length&&(c.groupByFieldsForStatistics=a.dataSchema.groupByFields);a.dataSchema.orderByFields&&0<a.dataSchema.orderByFields.length&&(c.orderByFields=a.dataSchema.orderByFields);c.outStatistics=a.dataSchema.statistics.map(function(a){var b=a.onStatisticField+"_"+a.statisticType;"count"===a.statisticType&&(b="STAT_COUNT");var b=l.upperCaseString(b),c=new y;c.statisticType=a.statisticType;c.onStatisticField=a.onStatisticField;c.outStatisticFieldName=
b;return c});return f.execute(c)}))}))},_getQueryObjectFromDataSource:function(a){return this._getDataSourceFilter(a).then(d.hitch(this,function(b){var c=new q;c.where=b;a.filterByExtent&&(c.geometry=this.map.extent);c.outFields=a.dataSchema.fields.map(function(a){return a.name});a.dataSchema.orderByFields&&0<a.dataSchema.orderByFields.length&&(c.orderByFields=a.dataSchema.orderByFields);c.returnGeometry=!0;c.outSpatialReference=this.map.spatialReference;return k(c)}))},_removeListeners:function(){this._listeners.forEach(d.hitch(this,
function(a){a.handle.remove()}));this._listeners=[]},_removeTimers:function(){this._refreshTimers.forEach(d.hitch(this,function(a){clearInterval(a.handle)}));this._refreshTimers=[]}});p.getInstance=function(){null===m&&(m=new p,window._datasourceManager=m);return m};return p});