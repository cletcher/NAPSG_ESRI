// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/html dojo/_base/config dojo/cookie dojo/Deferred dojo/promise/all dojo/request/xhr ./utils ./WidgetManager ./shared/utils ./tokenUtils ./portalUtils ./appConfigResourceUtils ./portalUrlUtils ./AppStateManager esri/IdentityManager esri/config esri/urlUtils esri/arcgis/utils".split(" "),function(E,c,w,B,x,y,m,t,z,k,F,p,h,l,G,e,H,A,u,C,D){var r=null,v;v=E(null,{urlParams:null,appConfig:null,rawAppConfig:null,configFile:null,_configLoaded:!1,
portalSelf:null,constructor:function(a,b){this._removeHash(a);this.urlParams=a||{};this.widgetManager=F.getInstance();c.mixin(this,b)},loadConfig:function(){console.time("Load Config");return this._tryLoadConfig().then(c.hitch(this,function(a){var b=this.checkConfig(a);if(b)throw Error(b);this.rawAppConfig=c.clone(a);H.getInstance().setRawAppConfig(this.rawAppConfig);a=this._upgradeAppConfig(a);this._processAfterTryLoad(a);this.appConfig=a;if(this.urlParams.id)return this.loadWidgetsManifest(a).then(c.hitch(this,
function(){return this.loadAndUpgradeAllWidgetsConfig(a)})).then(c.hitch(this,function(a){return this.updateNecessaryAttrOfResourceUrlInAppConfig(a,this.urlParams.id)})).then(c.hitch(this,function(){this._configLoaded=!0;this._setDocumentTitle(a);this._readAndSetSharedTheme(a);return this.getAppConfig()}));h.setPortalUrl(a.portalUrl);D.arcgisUrl=e.getBaseItemUrl(a.portalUrl);return this._proesssWebTierAndSignin(a).then(c.hitch(this,function(){if(this.urlParams.appid){if(window.appInfo.isRunInPortal){var b=
e.getStandardPortalUrl(a.portalUrl),b=l.getPortal(b);return k.checkEssentialAppsLicense(this.urlParams.appid,b,h.isInBuilderWindow()).then(c.hitch(this,function(){return this._getAppConfigFromTemplateAppId(a.portalUrl,this.urlParams.appid).then(c.hitch(this,function(a){this._tryUpdateAppConfigByLocationUrl(a);return this._processInPortalAppProtocol(a)}))}),c.hitch(this,function(a){console.error(a);throw Error(window.jimuNls.essentialAppsLicenseErrorForApp);}))}return this._processNotInPortalAppProtocol(a).then(c.hitch(this,
function(a){return this._getAppDataAddTemplateDataFromTemplateAppId(a.portalUrl,this.urlParams.appid).then(c.hitch(this,function(b){b.appData.appConfig&&(a=b.appData.appConfig);a._appData=b.appData;a.templateConfig=b.templateData;a.isTemplateApp=!0;return a}))}))}return this._processNotInPortalAppProtocol(a)})).then(c.hitch(this,function(a){this._processAfterTryLoad(a);this.appConfig=a;return a.map.itemId?a:(a.map["3D"]?l.getDefaultWebScene(a.portalUrl):l.getDefaultWebMap(a.portalUrl)).then(function(b){a.map.itemId=
b;return a})})).then(c.hitch(this,function(a){return this.loadWidgetsManifest(a)})).then(c.hitch(this,function(a){return a._appData?a._appData.values&&a._appData.values.webmap?l.getPortal(a.portalUrl).getItemById(a._appData.values.webmap).then(c.hitch(this,function(b){return k.template.mergeTemplateAppConfigToAppConfig(a,a._appData,b)})):k.template.mergeTemplateAppConfigToAppConfig(a,a._appData):a})).then(c.hitch(this,function(a){return this.loadAndUpgradeAllWidgetsConfig(a)})).then(c.hitch(this,
function(a){return a._wabAppId?this.processResourceInAppConfigForConfigLoader(a,this.urlParams):a.appItemId&&-1<window.JSON.stringify(a).indexOf("${itemId}")?this.updateNecessaryAttrOfResourceUrlInAppConfig(a,a.appItemId):a})).then(c.hitch(this,function(a){this.appConfig=a;this._configLoaded=!0;this._setDocumentTitle(a);this._readAndSetSharedTheme(a);return this.getAppConfig()}))}),c.hitch(this,function(a){var b=new m;b.reject(a);return b}))},processResourceInAppConfigForConfigLoader:function(a,b){var d=
a.portalUrl,f=a.appItemId,n=b.appid,g=new m,q=c.clone(a);this.updateNecessaryAttrOfResourceUrlInAppConfig(q,n).then(function(){if("config"===b.mode){var c=this.getResourceUrlsOfAppConfig(a).result;0!==c.length?l.getItemResources(d,n).then(function(a){if(0===a.length)return c=c.map(function(a){return{resUrl:a}}),G.AddResourcesToItemForAppSave(d,c,f,n).then(function(){g.resolve(q)},function(a){console.warn("Add resource to template based app error:"+a.message||a);g.resolve(q)});g.resolve(q)},function(a){console.warn("Get resource of template based item error:"+
a.message||a);g.resolve(q)}):g.resolve(q)}else g.resolve(q)}.bind(this),function(a){console.warn("Insert appId to resource url of appConfig error:"+a.message||a);g.resolve(q)});return g},getResourceUrlsOfAppConfig:function(a){var b={test:function(a){return/^https?:\/\/(.)+\/sharing\/rest\/content\/items\/(.)+\/resources\/inConfig\//.test(a)},func:c.hitch(this,function(a){return a.value})};return k.processItemResourceOfAppConfig(a,b)},updateNecessaryAttrOfResourceUrlInAppConfig:function(a,b){function d(a){return/^https?:\/\/(.)+\/sharing\/rest\/content\/items\/(.)+\/resources\/inConfig\//.test(a)}
function f(a,b){a=g.processItemIDAndTokenOfResources(b.value,a);a=g.setResouceProtocolForHttps(a);var f=b.obj,d=b.key;"number"===typeof b.i?f[d][b.i]=a:f[d]=a;return!0}var n=a.portalUrl,g=this;return l.getPortal(n).getItemById(b).then(c.hitch(this,function(g){g={test:d,func:c.hitch(this,f,{appId:b,isPublic:"public"===g.access,portalUrl:n})};return k.processItemResourceOfAppConfig(a,g).appConfig}))},setResouceProtocolForHttps:function(a){var b=a;"https:"===window.location.protocol&&(b=a.replace(/^http(s?):\/\//i,
"https://"));return b},processItemIDAndTokenOfResources:function(a,b){0<a.indexOf("${itemId}")&&(a=a.replace("${itemId}",b.appId));/(\?|\&)token=.+/.test(a)&&(a=a.replace(/(\?|\&)token=.+/,""));b.isPublic||(b=h.getPortalCredential(b.portalUrl))&&(a+="?token\x3d"+b.token);return a},_setDocumentTitle:function(a){!window.isBuilder&&a&&a.title&&(document.title=k.stripHTML(a.title))},getAppConfig:function(){var a=c.clone(this.appConfig);a.getConfigElementById=function(a){return k.getConfigElementById(this,
a)};a.getConfigElementsByName=function(a){return k.getConfigElementsByName(this,a)};a.visitElement=function(a){k.visitElement(this,a)};this._addAuthorizedCrossOriginDomains(this.portalSelf,a);return a},_addAuthorizedCrossOriginDomains:function(a,b){a&&a.authorizedCrossOriginDomains&&h.addAuthorizedCrossOriginDomains(a.authorizedCrossOriginDomains);b&&b.authorizedCrossOriginDomains&&h.addAuthorizedCrossOriginDomains(b.authorizedCrossOriginDomains)},checkConfig:function(){return!1},processProxy:function(a){u.defaults.io.alwaysUseProxy=
a.httpProxy&&a.httpProxy.useProxy&&a.httpProxy.alwaysUseProxy;u.defaults.io.proxyUrl="";u.defaults.io.proxyRules=[];a.httpProxy&&a.httpProxy.useProxy&&a.httpProxy.url&&(u.defaults.io.proxyUrl=a.httpProxy.url);a.httpProxy&&a.httpProxy.useProxy&&a.httpProxy.rules&&w.forEach(a.httpProxy.rules,function(a){C.addProxyRule(a)})},addNeedValues:function(a){this._processNoUriWidgets(a);this._processEmptyGroups(a);this._addElementId(a);this._fixRepeatedId(a)},showError:function(a){a&&a.message&&(B.create("div",
{"class":"app-error",innerHTML:k.sanitizeHTML(a.message)},document.body),B.setStyle(jimuConfig.loadingId,"display","none"))},_tryLoadConfig:function(){"stemapp"===this.urlParams.id&&(this.urlParams.config=window.appInfo.appPath+"config.json",delete this.urlParams.id);if(this.urlParams.config)return this.configFile=this.urlParams.config,z(this.configFile,{handleAs:"json",headers:{"X-Requested-With":null}}).then(c.hitch(this,function(a){h.setPortalUrl(a.portalUrl);a.portalUrl&&(window.portalUrl=a.portalUrl);
return this.urlParams.token?h.registerToken(this.urlParams.token).then(function(){return a}):a}));if(this.urlParams.id){window.appInfo.isRunInPortal=!0;var a=e.getPortalUrlFromLocation(),b=new m;h.setPortalUrl(a);window.portalUrl=a;D.arcgisUrl=e.getBaseItemUrl(a);var d;this.urlParams.token?d=h.registerToken(this.urlParams.token):(d=new m,d.resolve());d.then(c.hitch(this,function(){var d=l.getPortal(a);d.loadSelfInfo().then(c.hitch(this,function(f){this.portalSelf=f;f.allSSL&&"http:"===window.location.protocol?
(console.log("redirect from http to https"),window.location.href=e.setHttpsProtocol(window.location.href),b.reject()):this._processSignIn(a).then(c.hitch(this,function(){this._getAppConfigFromAppId(a,this.urlParams.id).then(c.hitch(this,function(a){return k.checkEssentialAppsLicense(this.urlParams.id,d,h.isInBuilderWindow()).then(c.hitch(this,function(){this._tryUpdateAppConfigByLocationUrl(a);return this._processInPortalAppProtocol(a)}),c.hitch(this,function(a){console.error(a);throw Error(window.jimuNls.essentialAppsLicenseErrorForApp);
}))})).then(function(a){b.resolve(a)},function(a){b.reject(a)})}))}))}),c.hitch(this,function(a){this.showError(a)}));return b}this.configFile="config.json";return z(this.configFile,{handleAs:"json"}).then(c.hitch(this,function(a){h.setPortalUrl(a.portalUrl);a.portalUrl&&(window.portalUrl=a.portalUrl);return this.urlParams.token?h.registerToken(this.urlParams.token).then(function(){return a}):a}))},_upgradeAppConfig:function(a){var b=window.wabVersion,d=a.wabVersion;a.configWabVersion=a.wabVersion;
if(b===d)return a;var c=this.versionManager.getVersionIndex(d),n=this.versionManager.getVersionIndex(b);if(c>n)throw Error("Bad version number, "+d);a=this.versionManager.upgrade(a,d,b);a.wabVersion=b;return a},loadAndUpgradeAllWidgetsConfig:function(a){var b=new m,d=[];p.visitElement(a,c.hitch(this,function(a){a.uri&&(a=this.widgetManager.tryLoadWidgetConfig(a),d.push(a))}));t(d).then(c.hitch(this,function(){b.resolve(a)}),function(a){b.reject(a)});return b},_processAfterTryLoad:function(a){this._setPortalUrl(a);
this._tryUpdateAppConfigByLocationUrl(a);this._processUrlParams(a);this.addNeedValues(a);this.processProxy(a);A.tokenValidity=10080;return a},_readAndSetSharedTheme:function(a){a.theme.sharedTheme||(a.theme.sharedTheme={useHeader:!1,useLogo:!1},a.theme.sharedTheme.isPortalSupport=this.portalSelf.portalProperties&&this.portalSelf.portalProperties.sharedTheme?!0:!1);a.theme.sharedTheme.useHeader&&(a.theme.sharedTheme.isPortalSupport&&this.portalSelf.portalProperties?(a.theme.customStyles={mainBackgroundColor:this.portalSelf.portalProperties.sharedTheme.header.background},
a.titleColor=this.portalSelf.portalProperties.sharedTheme.header.text):console.error("Portal does not support sharedTheme."));a.theme.sharedTheme.useLogo&&(a.theme.sharedTheme.isPortalSupport&&this.portalSelf.portalProperties?(a.logo=this.portalSelf.portalProperties.sharedTheme.logo.small?this.portalSelf.portalProperties.sharedTheme.logo.small:"images/app-logo.png",!a.logoLink&&this.portalSelf.portalProperties.sharedTheme.logo.link&&(a.logoLink=this.portalSelf.portalProperties.sharedTheme.logo.link)):
(console.error("Portal does not support sharedTheme, use default logo."),a.logo="images/app-logo.png"))},_tryUpdateAppConfigByLocationUrl:function(a){if(!(this.urlParams.config&&-1<this.urlParams.config.indexOf("arcgis.com/sharing/rest/content/items/"))){var b=e.getPortalUrlFromLocation(),b=e.getStandardPortalUrl(b);e.isOnline(b)&&(b=e.updateUrlProtocolByOtherUrl(b,a.portalUrl),a.map.portalUrl&&e.isSamePortalUrl(a.portalUrl,a.map.portalUrl)&&(a.map.portalUrl=b),a.portalUrl=b,a.httpProxy&&a.httpProxy.url&&
(a.httpProxy.url=e.getPortalProxyUrl(b)))}},_processWidgetJsons:function(a){p.visitElement(a,function(a,d){d.isWidget&&a.uri&&k.widgetJson.processWidgetJson(a)})},_processNoUriWidgets:function(a){var b=0;p.visitElement(a,function(a,c){c.isWidget&&!a.uri&&(b++,a.placeholderIndex=b)})},_processEmptyGroups:function(a){var b=0;a.widgetOnScreen.groups&&w.forEach(a.widgetOnScreen.groups,function(a){if(!a.widgets||a.widgets&&0===a.widgets.length)b++,a.placeholderIndex=b})},_addElementId:function(a){var b=
0,d;p.visitElement(a,function(a){if(a.id){a.id=a.id.replace(/\//g,"_");var c=a.id.lastIndexOf("_");-1<c&&(d=a.id.substr(c+1),b=Math.max(b,d))}});p.visitElement(a,function(a){a.id||(b++,a.id=a.itemId?a.itemId+"_"+b:a.uri?a.uri.replace(/\//g,"_")+"_"+b:"_"+b)})},_setPortalUrl:function(a){if(a.portalUrl){var b=e.getPortalUrlFromLocation(),c=e.isOnline(b);e.isSamePortalUrl(a.portalUrl,b)||c||(window.appInfo.isRunInPortal=!1)}else window.isXT&&y("wab_portalurl")?a.portalUrl=y("wab_portalurl"):(window.appInfo.isRunInPortal=
!0,a.portalUrl=e.getPortalUrlFromLocation())},_changePortalUrlProtocol:function(a,b){a.portalUrl=e.setProtocol(a.portalUrl,b);a.map.portalUrl&&(a.map.portalUrl=e.setProtocol(a.map.portalUrl,b));a.httpProxy&&(a.httpProxy.url=e.setProtocol(a.httpProxy.url,b),a.httpProxy&&a.httpProxy.rules&&w.forEach(a.httpProxy.rules,c.hitch(this,function(a){a.proxyUrl=e.setProtocol(a.proxyUrl,b)})))},_processInPortalAppProtocol:function(a){var b=new m,d=l.getPortal(a.portalUrl),f=c.hitch(this,function(c){if("https:"===
window.location.protocol)this._changePortalUrlProtocol(a,"https");else{if(c){console.log("redirect from http to https");window.location.href=e.setHttpsProtocol(window.location.href);b.reject();return}this._changePortalUrlProtocol(a,"http")}this._checkLocale();b.resolve(a)});d.loadSelfInfo().then(c.hitch(this,function(b){this.portalSelf=b;"private"===b.access?(b=0===a.portalUrl.toLowerCase().indexOf("https://"),f(b)):f(b.allSSL)}),c.hitch(this,function(a){b.reject(a)}));return b},_processNotInPortalAppProtocol:function(a){var b=
new m;a.portalUrl?l.getPortal(a.portalUrl).loadSelfInfo().then(c.hitch(this,function(c){this.portalSelf=c;var d="https:"===window.location.protocol;(c.allSSL||d)&&this._changePortalUrlProtocol(a,"https");0!==a.portalUrl.toLowerCase().indexOf("https://")||d||h.isInConfigOrPreviewWindow()?b.resolve(a):(console.log("redirect from http to https"),window.location.href=e.setHttpsProtocol(window.location.href),b.reject())}),c.hitch(this,function(a){b.reject(a)})):b.resolve(a);return b},_proesssWebTierAndSignin:function(a){var b=
new m,d=!1,f=a.portalUrl;this._processWebTier(a).then(c.hitch(this,function(a){d=a;return l.getPortal(f).loadSelfInfo()})).then(c.hitch(this,function(a){this.portalSelf=a;return this._processSignIn(f,d)})).then(c.hitch(this,function(){b.resolve()}),function(a){b.reject(a)});return b},_processWebTier:function(a){var b=new m,d=a.portalUrl;a.isWebTier?(h.addAuthorizedCrossOriginDomains([d]),h.isWebTierPortal(d).then(c.hitch(this,function(){var c=h.getPortalCredential(d);c&&c.ssl&&"http:"===window.location.protocol&&
!h.isInConfigOrPreviewWindow()?(console.log("redirect from http to https"),window.location.href=e.setHttpsProtocol(window.location.href)):b.resolve(a.isWebTier)}),c.hitch(this,function(a){b.reject(a)}))):b.resolve(!1);return b},_processSignIn:function(a,b){var d=new m,f=l.getPortal(a),n=e.getSharingUrl(a);window.appInfo.isRunInPortal?(b=A.checkSignInStatus(n),b.promise.always(c.hitch(this,function(){d.resolve()}))):(!h.isInBuilderWindow()&&!h.isInConfigOrPreviewWindow()&&this.portalSelf.supportsOAuth&&
this.rawAppConfig&&this.rawAppConfig.appId&&!b&&h.registerOAuthInfo(a,this.rawAppConfig.appId),b=A.checkSignInStatus(n),b.promise.always(c.hitch(this,function(){h.xtGetCredentialFromCookie(a);f.loadSelfInfo().then(c.hitch(this,function(a){this.portalSelf=a;this._checkLocale();d.resolve()}))})));return d},_checkLocale:function(){if(!h.isInConfigOrPreviewWindow()){var a=this.portalSelf.user&&this.portalSelf.user.culture||x.locale,a=a.toLowerCase();!this.urlParams.locale&&k.isLocaleChanged(x.locale,
a)&&(y("wab_app_locale",a),window.location.reload())}},_getAppConfigFromTemplateAppId:function(a,b){var d=l.getPortal(a);return this._getWabAppIdAndDataFromTemplateAppId(a,b).then(c.hitch(this,function(b){var f=b.appId,g=b.appData;return t([this._getAppConfigFromAppId(a,f),d.getItemData(g.source)]).then(c.hitch(this,function(a){var b;g.appConfig?(b=g.appConfig,delete g.appConfig):b=a[0];b=this._upgradeAppConfig(b);a=a[1];b._appData=g;b._wabAppId=f;b.templateConfig=a;b.isTemplateApp=!0;return b}))}))},
_getAppDataAddTemplateDataFromTemplateAppId:function(a,b){var c=l.getPortal(a);return c.getItemData(b).then(function(a){return c.getItemData(a.source).then(function(b){return{appData:a,templateData:b}})})},_getWabAppIdAndDataFromTemplateAppId:function(a,b){var d=new m,f=l.getPortal(a);f.getItemData(b).then(c.hitch(this,function(a){f.getItemById(a.source).then(c.hitch(this,function(b){b=C.urlToObject(b.url);d.resolve({appId:b.query.id,appData:a})}))}),function(a){d.reject(a)});return d},_getAppConfigFromAppId:function(a,
b){return l.getPortal(a).getItemData(b)},_removeHash:function(a){for(var b in a)a[b]&&(a[b]=a[b].replace("#",""))},loadWidgetsManifest:function(a){function b(b,c,e){function g(c){return b.loadWidgetManifest(c).then(function(a){return a},function(b){console.log("Widget failed to load, it is removed.",c.name);b.stack?console.error(b.stack):console.log(b);d(a,c)})}return c.itemId?l.getPortal(e).getItemById(c.itemId).then(function(a){c.uri=k.widgetJson.getUriFromItem(a);return g(c)},function(b){console.log("Widget is not loaded, it is removed.",
c.name,b);d(a,c)}):g(c)}function d(a,b){function c(c){a[c]&&a[c].widgets&&(a[c].widgets=a[c].widgets.filter(function(a){if(b)return a.id!==b.id;a.uri&&!a.manifest&&console.error("Widget is removed because it is not loaded successfully.",a.uri);return a.manifest}));a[c]&&a[c].groups&&a[c].groups.forEach(function(a){a.widgets&&(a.widgets=a.widgets.filter(function(a){if(b)return a.id!==b.id;a.uri&&!a.manifest&&console.error("Widget is removed because it is not loaded successfully.",a.uri);return a.manifest}))})}
c("widgetOnScreen");c("widgetPool")}var f=[],e=new m;this.urlParams.manifest&&a._buildInfo&&a._buildInfo.widgetManifestsMerged&&delete a._buildInfo.widgetManifestsMerged;a._buildInfo&&a._buildInfo.widgetManifestsMerged?this._loadMergedWidgetManifests().then(c.hitch(this,function(d){p.visitElement(a,c.hitch(this,function(c){c.widgets||!c.uri&&!c.itemId||(c.uri&&d[c.uri]?(this._addNeedValuesForManifest(d[c.uri],c.uri),k.widgetJson.addManifest2WidgetJson(c,d[c.uri])):f.push(b(this.widgetManager,c,a.portalUrl)))}));
t(f).then(function(){e.resolve(a)})})):(p.visitElement(a,c.hitch(this,function(c){c.widgets||!c.uri&&!c.itemId||f.push(b(this.widgetManager,c,a.portalUrl))})),t(f).then(function(){e.resolve(a)}));setTimeout(function(){e.isResolved()||(d(a),e.resolve(a))},6E4);return e},_addNeedValuesForManifest:function(a,b){c.mixin(a,k.getUriInfo(b));k.manifest.addManifestProperies(a);k.manifest.processManifestLabel(a,x.locale)},_loadMergedWidgetManifests:function(){return z(window.appInfo.appPath+"widgets/widgets-manifest.json",
{handleAs:"json"})},_fixRepeatedId:function(a){var b=[];p.visitElement(a,function(a){0<=b.indexOf(a.id)&&(a.id+="_");b.push(a.id)})},_processUrlParams:function(a){var b=this.urlParams.itemid||this.urlParams.webmap;b&&a.map.itemId!==b&&(a.map.mapOptions&&k.deleteMapOptions(a.map.mapOptions),a.map.itemId=b);this.urlParams.mode&&(a.mode=this.urlParams.mode);a.map.mapOptions||(a.map.mapOptions={});this.urlParams.scale&&(a.map.mapOptions.scale=this.urlParams.scale);if(this.urlParams.level||this.urlParams.zoom)a.map.mapOptions.zoom=
this.urlParams.level||this.urlParams.zoom}});v.getInstance=function(a,b){null===r?r=new v(a,b):(r.urlParams=a||{},r.options=b);return r};return v});