// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/array dojo/_base/lang dojo/Deferred dojo/promise/all dojo/string esri/arcade/arcade esri/arcade/Feature esri/tasks/RelationshipQuery jimu/utils jimu/LayerStructure".split(" "),function(g,k,m,r,p,q,t,u,v,w){var b={readExprInfo:{}};b.readExprInfo.getArcadeProfilesByType=function(a,c,d){a={map:a,layer:c};return"render"===d?b.readExprInfo._getArcadeRender(a):"label"===d?b.readExprInfo._getArcadeLabel(a):"infoTemplate"===d?b.readExprInfo._getArcadeInfoTemplate(a):b.readExprInfo._getAllArcade(a)};
b.readExprInfo._getArcadeRender=function(a){return b.readExprInfo._lookupArcadeRender({layers:b.readExprInfo._checkPassInLayer(a)})};b.readExprInfo._getArcadeInfoTemplate=function(a){return b.readExprInfo._lookupArcadeInfoTemplate({layers:b.readExprInfo._checkPassInLayer(a)})};b.readExprInfo._getArcadeLabel=function(a){return b.readExprInfo._lookupArcadeLabel({layers:b.readExprInfo._checkPassInLayer(a)})};b.readExprInfo._getAllArcade=function(a){var c=b.readExprInfo._getArcadeRender(a),d=b.readExprInfo._getArcadeInfoTemplate(a);
a=b.readExprInfo._getArcadeLabel(a);return{render:c,infoTemplate:d,label:a}};b.readExprInfo._checkPassInLayer=function(a){var c=[];return c="undefined"!==typeof a?"undefined"!==typeof a.layer?null!==a.layer&&""!==a.layer?b.readExprInfo._getAllMapLayers(a):b.readExprInfo._getAllMapLayers():b.readExprInfo._getAllMapLayers():b.readExprInfo._getAllMapLayers()};b.readExprInfo._getAllMapLayers=function(a){var c="",d=[],b=w.getInstance();a&&a.layer&&(c=a.layer.id);""!==c?(a=b.getNodeById(c))&&d.push(a._layerInfo.layerObject):
b.traversal(function(a){"undefined"!==typeof a._layerInfo.layerObject.type?-1===a._layerInfo.layerObject.type.indexOf("tile")&&d.push(a._layerInfo.layerObject):d.push(a._layerInfo.layerObject)});return d};b.readExprInfo._lookupArcadeRender=function(a){var c=[];0<a.layers.length&&g.forEach(a.layers,k.hitch(this,function(a){var b={};if("undefined"!==typeof a.renderer){var d=a.renderer;"undefined"!==typeof d.valueExpression&&(b.layer=a.id,b.valueExpression=d.valueExpression,b.valueExpressionTitle=d.valueExpressionTitle,
"undefined"!==typeof d.values&&(b.values=d.values),"undefined"!==typeof d.visualVariables&&(b.visualVariables=d.visualVariables));1<Object.keys(b).length&&b.constructor===Object?c.push(b):c.push({layer:a.id,valueExpression:null,valueExpressionTitle:null,values:null,visualVariables:null})}}));return c};b.readExprInfo._lookupArcadeInfoTemplate=function(a){var c=[];0<a.layers.length&&g.forEach(a.layers,k.hitch(this,function(a){var b={};if("undefined"!==typeof a.infoTemplate)"undefined"!==typeof a.infoTemplate.info.expressionInfos&&
0<a.infoTemplate.info.expressionInfos.length&&(b.layer=a.id,b.expressionInfos=a.infoTemplate.info.expressionInfos);else if("undefined"!==typeof a.infoTemplates)for(var d in a.infoTemplates)if(a.infoTemplates.hasOwnProperty(d)&&"undefined"!==typeof a.infoTemplates[d].infoTemplate.info.expressionInfos){var f=a.infoTemplates[d].infoTemplate;0<f.info.expressionInfos.length&&(b.layer=a.id,b.expressionInfos=f.info.expressionInfos)}1<Object.keys(b).length&&b.constructor===Object?c.push(b):c.push({layer:a.id,
expressionInfos:null})}));return c};b.readExprInfo._lookupArcadeLabel=function(a){var b=[];0<a.layers.length&&g.forEach(a.layers,k.hitch(this,function(a){var c={};"undefined"!==typeof a.labelingInfo&&g.forEach(a.labelingInfo,k.hitch(this,function(b){"undefined"!==typeof b.name&&(c.layer=a.id,c.name=b.name,c.labelingInfo=b,c.expression=b.labelExpressionInfo.expression)}));1<Object.keys(c).length&&c.constructor===Object?b.push(c):b.push({layer:a.id,name:null,labelingInfo:null,expression:null})}));return b};
b.customExpr={};b.customExpr.getAttributesFromCustomArcadeExpr=function(a,c,d){a=b.InfoTemplate._parseArcadeExpressions(a);return b.InfoTemplate._combineFeatureAttributesAndExpressionResolutions(c,a,d)};b.customExpr.getAttributesValueFromCustomArcadeExprBatch=function(a,c,d){var e=[],h;for(h in c)e.push(c[h]);c=b.InfoTemplate._parseArcadeExpressions(a);a=b.InfoTemplate._getExprNamesArrayFromPopupExprInfos(a);a.relationships=null;a.parsedExpressions=c;var f=new m;b.InfoTemplate._getPopupFieldsValueFromArcadeFeatures(e,
a,d).then(function(a){f.resolve(a)});return f};b.InfoTemplate={};b.InfoTemplate.getAttributesFromInfoTemplate=function(a,c,d){var e={fields:[]};c.layerObject&&c.layerObject.fields&&(e.fields=c.layerObject.fields);a=b.readExprInfo.getArcadeProfilesByType(a,c,"infoTemplate")[0].expressionInfos;if(!a)return d.attributes;a=b.InfoTemplate._parseArcadeExpressions(a);return b.InfoTemplate._combineFeatureAttributesAndExpressionResolutions(d,a,e)};b.InfoTemplate.getAttributesValueFromInfoTemplateBatch=function(a,
c,d){var e={fields:[]};c.layerObject&&c.layerObject.fields&&(e.fields=c.layerObject.fields);var h=[],f;for(f in d)h.push(d[f]);a=b.readExprInfo.getArcadeProfilesByType(a,c,"infoTemplate")[0].expressionInfos;var g=new m;if(!a)return g.resolve([]),g;d=b.InfoTemplate._parseArcadeExpressions(a);f=null;f=c.getPopupInfo().description;null!==f?(f=b.InfoTemplate._convertPopupDescToFieldNamesArray(f),f.relationships=b.InfoTemplate._getRelationshipQueries(c)):(f=b.InfoTemplate._getExprNamesArrayFromPopupExprInfos(a),
f.relationships=null);f.parsedExpressions=d;b.InfoTemplate._getPopupFieldsValueFromArcadeFeatures(h,f,e).then(function(a){g.resolve(a)});return g};b.InfoTemplate._getRelationshipQueries=function(a){var b=!1,d={},e=/\d+/,h;if(h=a.getPopupInfo().description.match(/\{relationships\/\d+\//gm))b=!0,g.forEach(h,function(b){var c=b.match(e)[0];d.hasOwnProperty(c)||(b=new u,b.outFields=["*"],b.relationshipId=c,b.returnGeometry=!1,d[c]={operLayer:a,relatedQuery:b})});return b?d:null};b.InfoTemplate._getExprNamesArrayFromPopupExprInfos=
function(a){var b=[],d;for(d in a)b.push("${expression/"+a[d].name+"}");return b};b.InfoTemplate._convertPopupDescToFieldNamesArray=function(a){a=b.InfoTemplate._convertEndParasToEOLs(a);a=b.InfoTemplate._convertBreaksToEOLs(a);a=b.InfoTemplate._sanitizeNoTags(a).trim();a=a.replace(/\{/gi,"${");a=a.replace(/\u00a0/gi," ");a=a.split("\n");return a=g.map(a,function(a){return a.trim()})};b.InfoTemplate._sanitizeNoTags=function(a){var b;b=v.sanitizeHTML(a);a=/<(?:!--(?:(?:-*[^->])*--+|-?)|script\b(?:[^"'>]|"[^"]*"|'[^']*')*>[\s\S]*?<\/script\s*|style\b(?:[^"'>]|"[^"]*"|'[^']*')*>[\s\S]*?<\/style\s*|\/?[a-z](?:[^"'>]|"[^"]*"|'[^']*')*)>/gi;
var d;do d=b,b=b.replace(a,"");while(b!==d);return b=b.replace(/</g,"\x26lt;")};b.InfoTemplate._getPopupFieldsValueFromArcadeFeatures=function(a,c,d){var e=new m,h=[],f=[],k=0;c.relationships?(g.forEach(a,function(a){b.InfoTemplate._objEach(c.relationships,function(e,h){var k=new m,n=e.relatedQuery,l;f.push(k);l=a.attributes[e.operLayer.layerObject.objectIdField];n.objectIds=[l];e.operLayer.layerObject.queryRelatedFeatures(n,function(e){var f=[];e[l]&&e[l].features&&(e=e[l].features,g.forEach(e,function(e){var k=
[],n,l,m;n=a.attributes;l="relationships/"+h+"/";b.InfoTemplate._objEach(e.attributes,function(a,b){m=l+b;n[m]=a});g.forEach(c,function(e){k.push(p.substitute(e,b.InfoTemplate._combineFeatureAttributesAndExpressionResolutions(a,c.parsedExpressions,d),b.InfoTemplate._useEmptyStringForNull))});f.push(k)}));k.resolve(f)})})}),r(f).then(function(a){g.forEach(a,function(a){g.forEach(a,function(a){++k;h.push(a)})});console.log(k+" related address features found");e.resolve(h)})):(g.forEach(a,function(a){var e=
[];g.forEach(c,function(f){e.push(p.substitute(f,b.InfoTemplate._combineFeatureAttributesAndExpressionResolutions(a,c.parsedExpressions,d),b.InfoTemplate._useEmptyStringForNull))});h.push(e)}),e.resolve(h));return e};b.InfoTemplate._parseArcadeExpressions=function(a){var b;Array.isArray(a)&&0<a.length&&(b={},g.forEach(a,function(a){b[a.name]=q.parseScript(a.expression)}));return b};b.InfoTemplate._initArcadeContext=function(a,b){var c={vars:{}};c.vars.$feature=t.createFromGraphicLikeObject(a.geometry,
a.attributes,b);return c};b.InfoTemplate._combineFeatureAttributesAndExpressionResolutions=function(a,c,d){var e,g;e=k.mixin({},a.attributes);if(c)for(g in a=b.InfoTemplate._initArcadeContext(a,d),c)d=q.executeScript(c[g],a),e["expression/"+g]=d?d.toString():"";return e};b.InfoTemplate._convertEndParasToEOLs=function(a){var b=a;a=a.match(/<\/p>/gi);g.forEach(a,function(a){b=b.replace(a,"\n")});return b};b.InfoTemplate._convertBreaksToEOLs=function(a){var b=a;a=a.match(/<br\s*\/?>/gi);g.forEach(a,
function(a){b=b.replace(a,"\n")});return b};b.InfoTemplate._useEmptyStringForNull=function(a){return a?a:""};b.InfoTemplate._objEach=function(a,b,d){for(var c in a)a.hasOwnProperty(c)&&b.call(d,a[c],c)};return b});