// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/topic dojo/Deferred dojo/promise/all ./featureActions/main ./utils".split(" "),function(p,d,e,f,l,h,q,n){var k=null,m=p(null,{constructor:function(){this._actions=[];window.isBuilder?(f.subscribe("app/mapLoaded",d.hitch(this,this._onMapLoaded)),f.subscribe("app/mapChanged",d.hitch(this,this._onMapChanged))):(f.subscribe("mapLoaded",d.hitch(this,this._onMapLoaded)),f.subscribe("mapChanged",d.hitch(this,this._onMapChanged)));window.isBuilder?
(f.subscribe("app/appConfigLoaded",d.hitch(this,this._onAppConfigLoaded)),f.subscribe("app/appConfigChanged",d.hitch(this,this._onAppConfigChanged))):(f.subscribe("appConfigLoaded",d.hitch(this,this._onAppConfigLoaded)),f.subscribe("appConfigChanged",d.hitch(this,this._onAppConfigChanged)));this._registerFrameworkActions()},getAllActions:function(){return this._actions},getSupportedActions:function(a){a=this._getFeatureSet(a);var b=[];e.forEach(this._actions,function(g){var c=this.testActionSupportFeature(g,
a);c.action=g;b.push(c)},this);return h(b).then(d.hitch(this,function(a){return a.map(d.hitch(this,function(a,b){return{result:a,action:this._actions[b]}})).filter(function(a){return a.result}).map(function(a){return a.action})}))},testActionSupportFeature:function(a,b){b=this._getFeatureSet(b);var g;b.features&&0<b.features.length&&(g=b.features[0].getLayer());a=a.isFeatureSupported(b,g);var c=new l;a&&"function"===typeof a.then?a.then(function(a){c.resolve(a)},function(a){console.error(a);c.resolve(!1)}):
c.resolve(a);return c},registerAction:function(a){var b=new l;require([a.uri],d.hitch(this,function(g){var c=new g({map:this.map,appConfig:this.appConfig,label:a.label,name:a.name,widgetId:a.widgetId});e.some(this._actions,function(a){return c.name===a.name&&c.widgetId===a.widgetId})?(console.warn("Feature/FeatureSet action has been registered.",c.name),b.reject("Feature/FeatureSet action has been registered.",c.name)):(this._actions.push(c),b.resolve(c))}));return b},removeActionsByWidgetId:function(a){this._actions=
e.filter(this._actions,function(b){return b.widgetId!==a},this)},getActionsByWidgetId:function(a){return e.filter(this._actions,function(b){return b.widgetId===a},this)},getActionsByActionName:function(a){return e.filter(this._actions,function(b){return b.name===a},this)},registerWidgetFeatureActions:function(a){var b=new l;if(!a.featureActions||!a.uri)return b.resolve(),b;var g=[];e.forEach(a.featureActions,function(b){g.push(this.registerAction({uri:a.isRemote?a.amdFolder+b.uri+".js":a.amdFolder+
b.uri,widgetId:a.id,name:b.name,label:a.manifest["i18nLabels_featureAction_"+b.name][window.dojoConfig.locale]||a.manifest["i18nLabels_featureAction_"+b.name].defaultLabel}))},this);return h(g)},registerAllWidgetFeatureActions:function(a){var b=[];a.visitElement(d.hitch(this,function(a){a.uri&&a.visible&&b.push(this.registerWidgetFeatureActions(a))}));return h(b).then(function(){f.publish("widgetsActionsRegistered")})},_reRegisterWidgetActions:function(a){var b=[];e.forEach(this.getAllActions(),function(b){var c=
a.getConfigElementById(b.widgetId);"framework"===b.widgetId||c&&c.uri&&!1!==c.visible||this.removeActionsByWidgetId(b.widgetId)},this);a.visitElement(d.hitch(this,function(a){a.uri&&a.visible&&0===this.getActionsByWidgetId(a.id).length&&b.push(this.registerWidgetFeatureActions(a))}));0<b.length&&h(b).then(function(){f.publish("widgetsActionsRegistered")})},_registerFrameworkActions:function(){e.forEach(q,function(a){this.registerAction({uri:a.uri,widgetId:"framework",label:window.jimuNls.featureActions[a.name],
name:a.name})},this)},_getFeatureSet:function(a){return"[object Object]"===Object.prototype.toString.call(a)?a.features?a:n.toFeatureSet([a]):n.toFeatureSet(a)},_onAppConfigLoaded:function(a){this.appConfig=a=d.clone(a);this._setActionsAppConfig(a);this.registerAllWidgetFeatureActions(this.appConfig)},_onAppConfigChanged:function(a){this.appConfig=a=d.clone(a);this._reRegisterWidgetActions(this.appConfig);this._setActionsAppConfig(a)},_onMapLoaded:function(a){this.map=a;this._setActionsMap(a)},_onMapChanged:function(a){this.map=
a;this._setActionsMap(a)},_setActionsMap:function(a){e.forEach(this._actions,function(b){b.setMap(a)},this)},_setActionsAppConfig:function(a){e.forEach(this._actions,function(b){b.setAppConfig(a)},this)}});m.getInstance=function(){null===k&&(k=new m,window._featureActionManager=k);return k};return m});